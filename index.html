<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Recast — Compact Click-Through (Realistic Catalog)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="dark light">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://unpkg.com">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      :root {
        --bg-main: #f9fafb;
        --text-primary: #111827;
        --primary: #2563eb;
        --primary-hover: #1d4ed8;
        --radius: 1rem;
        --border-subtle: #e5e7eb;
        --shadow-card: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        --shadow-hover: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      }
      html, body {
        background: var(--bg-main);
        color: var(--text-primary);
        font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      }
      .focus-ring:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; }
      .section-card { border-radius: var(--radius); background: #ffffff; box-shadow: var(--shadow-card); transition: box-shadow 300ms ease, transform 300ms ease; }
      .section-card:hover { box-shadow: var(--shadow-hover); transform: translateY(-2px); }
      .sub-card { border-radius: calc(var(--radius) / 1.5); border: 1px solid var(--border-subtle); background: #f9fafb; transition: box-shadow 300ms ease; }
      .tile { width: 0.45rem; height: 0.45rem; border-radius: 2px; background: #e5e7eb; opacity: 0.9; }
      .run .tile { animation: tilePulse 1s ease-in-out var(--d, 0s) 1 forwards; }
      @keyframes tilePulse { 0% { transform: scale(0.7); background: #e5e7eb; opacity: 0.4; } 60% { transform: scale(1); background: var(--primary); opacity: 1; } 100% { background: #e5e7eb; opacity: 0.9; } }
      .flow-bar { height: 0.22rem; border-radius: 2px; transform-origin: left center; transform: scaleX(0); }
      .run .flow-bar { animation: barGrow 0.9s ease forwards var(--d, 0s); }
      @keyframes barGrow { to { transform: scaleX(1); } }
      .bolt-line { width: 0.22rem; border-radius: 2px; transform-origin: top center; transform: scaleY(0); }
      .run .bolt-line { animation: boltDrop 0.9s ease forwards var(--d, 0s); }
      @keyframes boltDrop { to { transform: scaleY(1); } }
      .logo-ring { width: 2.1rem; height: 2.1rem; border-radius: 9999px; display: grid; place-items: center; background: #ffffff; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1); transition: all 0.3s ease; }
      .logo-ring:hover { box-shadow: 0 0 8px rgba(37,99,235,0.3); transform: scale(1.05); }
      .logo-wrap { display: flex; align-items: center; gap: 0.4rem; position: relative; transition: all 300ms ease; }
      .logo-name { font-size: 0.7rem; color: #6b7280; opacity: 0; transform: translateX(-10px); transition: all 0.3s ease; }
      .show-labels .logo-wrap { flex-direction: column; align-items: flex-start; gap: 0.2rem; }
      .show-labels .logo-name { opacity: 1; transform: translateX(0); white-space: normal; text-align: left; }
      .show-labels .logo-wrap .logo-ring { width: 1.8rem; height: 1.8rem; }
      .run .logo-ring { animation: appLiftPulse 1.2s cubic-bezier(0.2, 0.8, 0.2, 1) var(--d, 0s) 1 forwards; }
      @keyframes appLiftPulse { 0% { transform: translateY(0) scale(1); filter: saturate(0.4); opacity: 0.65; } 30% { transform: translateY(-4px) scale(1.05); } 60% { transform: translateY(-2px) scale(1.02); filter: saturate(1); opacity: 1; } 100% { transform: translateY(0) scale(1); } }
      .user-beam { height: 0.38rem; border-radius: 2px; transform-origin: left center; transform: scaleX(0); }
      .run .user-beam { animation: barGrow 1s ease forwards var(--d, 0s); }
      .badge { width: 1.15rem; height: 1.15rem; border-radius: 9999px; opacity: 0; transform: translateY(-6px) scale(0.9); }
      .run .badge { animation: badgeDrop 0.8s ease-out var(--d, 0s) forwards; }
      @keyframes badgeDrop { to { opacity: 1; transform: translateY(0) scale(1); } }
      .cat-row { display: grid; grid-template-columns: 15ch 1fr; gap: 0.5rem; align-items: center; border-top: 1px solid #e5e7eb; padding-top: 0.5rem; transition: all 300ms ease; }
      .cat-row:first-child { border-top: none; padding-top: 0; }
      .cat-title { font-size: 0.7rem; letter-spacing: 0.08em; display: flex; align-items: center; gap: 0.5rem; }
      .re-primary { background: var(--primary) !important; color: #fff !important; border: 0; border-radius: 9999px; padding: 0.5rem 1.5rem; transition: background 0.2s ease, transform 0.2s ease; }
      .re-primary:hover { background: var(--primary-hover) !important; transform: scale(1.02); }
      .re-primary:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; }
      .re-secondary { background: transparent !important; color: var(--text-primary) !important; border: 2px solid var(--text-primary) !important; border-radius: 9999px; padding: 0.5rem 1.5rem; transition: all 0.2s ease, transform 0.2s ease; }
      .re-secondary:hover { color: var(--primary) !important; border-color: var(--primary) !important; transform: scale(1.02); }
      @media (prefers-reduced-motion: reduce) {
        .accordion-content { transition: none !important; }
      }
      .modal-overlay { transition: opacity 300ms ease; }
      .modal-content { transition: transform 300ms cubic-bezier(0.2, 0.8, 0.2, 1), opacity 300ms ease; }
      .modal-open .modal-content { transform: scale(1); opacity: 1; }
      .modal-closed .modal-content { transform: scale(0.95); opacity: 0; }
      .check-appear{opacity:0;animation:fadeInOut 1.5s ease var(--d,0s) forwards}
      @keyframes fadeInOut{0%{opacity:0}30%{opacity:1}70%{opacity:1}100%{opacity:0}}
      .flow-connect{background-image:linear-gradient(to right, transparent 50%, #e5e7eb 50%);background-size:4px 1px;background-repeat:repeat-x;height:1px;opacity:0.5}
      .end-user-expand{transition:all 0.5s ease;transform:scale(1.05);background:#ffffff;border-color:#10b981}
      .icon-launch{animation:iconLaunch 0.5s ease forwards}
      @keyframes iconLaunch{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}
      .tagline-fade{opacity:0;animation:fadeIn 1s ease 10s forwards}
      @keyframes fadeIn{to{opacity:1}}
      .overlay-tag{opacity:0;transition:opacity 0.3s ease;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,0.9);padding:1rem;border-radius:var(--radius);box-shadow:var(--shadow-card);z-index:10}
      .show-labels .overlay-tag{opacity:1;transition-delay:0.5s}
      .meta-label{font-size:0.6rem;color:#6b7280;opacity:0;transform:translateY(5px);transition:all 0.3s ease;position:relative;top:auto;left:auto;z-index:5;white-space:nowrap;display:flex;flex-direction:column;gap:0.1rem;align-items:flex-start;width:100%;justify-content:flex-start}
      .show-labels .meta-label{opacity:1;transform:translateY(0)}
      .show-labels .cat-row{grid-template-columns:15ch 1fr;gap:1rem}
      .show-labels #flowCard .flex-wrap{gap:1rem}
      .show-labels .logo-wrap{width:calc(33.333% - 0.666rem);margin-bottom:0.5rem}
      .env-wrap { display: flex; align-items: center; gap: 0.2rem; position: relative; transition: all 300ms ease; width: calc(16.666% - 0.5rem); flex-direction: column; }
      .env-name { font-size: 0.7rem; color: #6b7280; opacity: 1; transform: translateY(0); transition: all 0.3s ease; white-space: nowrap; text-align: center; }
      .env-ring { width: 1.8rem; height: 1.8rem; }
      .run .env-ring { animation: envPulse 1.2s cubic-bezier(0.2, 0.8, 0.2, 1) var(--d, 0s) 1 forwards; }
      @keyframes envPulse { 0% { transform: scale(1); filter: saturate(0.4); opacity: 0.65; box-shadow: 0 0 0 rgba(37,99,235,0); } 30% { transform: scale(1.05); box-shadow: 0 0 12px rgba(37,99,235,0.5); } 60% { transform: scale(1.02); filter: saturate(1); opacity: 1; box-shadow: 0 0 8px rgba(37,99,235,0.3); } 100% { transform: scale(1); box-shadow: 0 0 0 rgba(37,99,235,0); } }
      .arrow-line { height: 1.5rem; width: 0.15rem; background: linear-gradient(to bottom, #e5e7eb, #2563eb); transform-origin: top center; transform: scaleY(0); margin: 0 auto; position: relative; }
      .arrow-line::after { content: ''; position: absolute; bottom: -0.3rem; left: -0.25rem; border-left: 0.4rem solid transparent; border-right: 0.4rem solid transparent; border-top: 0.6rem solid #1d4ed8; opacity: 0; transition: opacity 0.3s; }
      .run .arrow-line { animation: arrowDrop 0.8s ease forwards var(--d, 0s); }
      .run .arrow-line::after { animation: arrowTip 0.8s ease forwards var(--d, 0s); }
      @keyframes arrowDrop { 0% { transform: scaleY(0); } 100% { transform: scaleY(1); } }
      @keyframes arrowTip { 0% { opacity: 0; } 80% { opacity: 0; } 100% { opacity: 1; } }
      .hub-card { opacity: 0; transform: translateY(10px); transition: all 0.5s ease; }
      .run .hub-card { animation: hubAppear 0.8s ease forwards var(--d, 2.5s); }
      @keyframes hubAppear { to { opacity: 1; transform: translateY(0); } }
      .metrics-banner { opacity: 0; transform: translateY(10px); transition: all 0.5s ease; text-align: center; font-size: 0.9rem; font-weight: 500; color: #111827; }
      .run .metrics-banner { animation: metricsAppear 0.8s ease forwards var(--d, 3.5s); }
      @keyframes metricsAppear { to { opacity: 1; transform: translateY(0); } }
      .interactive-node { transition: opacity 0.3s, transform 0.3s; }
      .interactive-node:hover { opacity: 0.9; transform: scale(1.05); }
    </style>
  </head>
  <body class="min-h-screen antialiased">
    <div id="app" class="min-h-screen"></div>
    <script>
      const STATE = {
        activeTab: 'problems',
        impact: { minutes: 9, pkgHours: 6, riskHrs: 22.5 },
        defaults: { impact: { minutes: 9, pkgHours: 6, riskHrs: 22.5 } },
        ctx: { device: 'Windows', network: 'Corporate', compliant: true },
        packHrs: 8, configHrs: 2, currentHrs: 24,
        roiInputs: { users: 5000, ticketsPerUserPerMonth: 0.035, avgHandleMins: 18 },
        copied: false,
        showLabels: false,
        showSolutionCards: true,
        openWhy: null,
        openWhyModal: null,
        openCards: { core: false, onboarding: false, trust: false },
        visitedCards: [],
        openBuckets: { one: false, zero: false, per: false },
        modalOpen: false,
        editTab: 'change',
        editBuffers: { change: { intro: '', bullets: '', analyst: '' }, now: { intro: '', bullets: '', analyst: '' }, recast: { intro: '', bullets: '', analyst: '' } },
        insightContent: null,
        mode: 'current_state',
        activePopover: null,
        years: [2025, 2026, 2027, 2028],
        drivers: [
          { id: "more_apps", label: "More Applications", subtext: "Portfolio growth across Windows, macOS, VDI, web", markerYear: 2025.6, bullets: ["Every new app adds ongoing work—packaging, testing, updates, support.", "App sprawl compounds across Windows, macOS, VDI, and web delivery paths.", "Portfolio growth increases version drift and troubleshooting load."], short: "More apps = more packaging, updates, testing, support.", state: 'off' },
          { id: "constant_updates", label: "Constant Change", subtext: "Security patches, compatibility, vendor releases", markerYear: 2026.2, bullets: ["Updates are continuous, not occasional—work never clears.", "Security patches and compatibility changes create perpetual churn.", "Release velocity outpaces admin capacity."], short: "Updates are continuous; stability requires constant change.", state: 'off' },
          { id: "too_many_tools", label: "Hybrid Environments", subtext: "Fragmented delivery across platforms", markerYear: 2026.8, bullets: ["App delivery is fragmented across tools and environments (e.g., Intune/ConfigMgr/VDI).", "Teams rebuild packaging and deployment logic per platform.", "Tool fragmentation creates handoffs, duplication, and drift."], short: "Same app, different platforms, rebuilt logic everywhere.", state: 'off' },
          { id: "manual_rework", label: "Too Much Manual Work", subtext: "Rebuilds, exceptions, one-off fixes", markerYear: 2027.3, bullets: ["Manual rebuilds per version create packaging backlog and rework.", "Reactive fixes become permanent exceptions (technical debt).", "Firefighting displaces planned work and modernization."], short: "Rebuilds, retesting, one-off fixes consume senior time.", state: 'off' },
          { id: "security_compliance", label: "Security and Compliance Pressure", subtext: "Higher urgency, higher risk", markerYear: 2027.7, bullets: ["Security/compliance raises the urgency and risk of app change.", "Inconsistent versions and installs increase exposure and escalations.", "Patching timelines stretch when workflows are manual and fragmented."], short: "More urgency, less tolerance; complexity amplifies risk.", state: 'off' }
        ],
        tippingPointYear: 2027.5,
        tippingPoint: {
          title: "Inflection Point",
          bullets: ["Changes take longer", "Risk increases", "Teams burn out", "Strategic initiatives stall"],
          closing: "This isn’t failure — it’s the limit of a model that no longer scales."
        },
        chartConfig: {
          yAxis: "Expectations and Requests",
          xAxis: "Time",
          center: "The widening gap",
          footer: "IT Appreciation & Resources / Time",
          tipping: "Operational breaking point"
        },
        currentDemandExponent: 1.6,
        targetDemandExponent: 1.6,
        currentCapacitySlope: 0,
        targetCapacitySlope: 0,
        showTippingPoint: false,
        currentState: {
          change: {
            intro: "The application layer has become the biggest drag on IT execution.",
            bullets: [
              'Too many apps, too many platforms. The same applications are rebuilt, patched, and supported separately across Intune, ConfigMgr, VDI, Windows, and macOS.',
              'Work has outgrown capacity. Headcount stays flat while app updates, fixes, and exceptions keep increasing.',
              'Major initiatives stall on app readiness. Cloud moves, AVD/Citrix projects, hardware refreshes, and AI efforts all slow down at the same point.',
            ],
            analyst: "Across industries, application delivery — not infrastructure — is now the primary bottleneck to modernization. Most transformation projects slow or fail because teams lack capacity to keep apps ready while platforms change.."
          },
          now: {
            intro: "The gap between what IT is asked to deliver and what it can sustain is widening fast.",
            bullets: [
              'Change is accelerating, not slowing down. More app updates, more security pressure, more platforms — with the same teams.',
              'Manual app work compounds over time. Every custom or internal app adds more versions, more dependencies, and more risk with each change',
              'Teams that should be driving innovation are stuck keeping apps alive.',
            ],
            analyst: "Organizations that succeed with AI, cloud, and new platforms over the next few years will be the ones that stabilize application delivery first. Everyone else hits a capacity wall where progress slows regardless of strategy"
          },
          recast: {
            intro: "Application Workspace changes how apps are delivered — to the user, not the device.",
            bullets: [
              'One workspace for every app. Commercial, internal, and legacy apps are delivered consistently across Intune, ConfigMgr, AVD, and other platforms.',
              'Less version sprawl, fewer variables. Fewer app versions mean fewer tickets, faster fixes, and simpler support.',
              'Capacity returns to the team. What used to take hours becomes minutes, freeing teams to move modernization forward.',
            ],
            analyst: "Leading IT organizations are shifting from device-centric management to user-centric delivery models to reduce operational friction and keep pace with constant platform change"
          }
        },
        defaultsCurrentState() {
          return JSON.parse(JSON.stringify({
            change: {
              intro: "The application layer has become the biggest drag on IT execution.",
              bullets: [
              'Too many apps, too many platforms. The same applications are rebuilt, patched, and supported separately across Intune, ConfigMgr, VDI, Windows, and macOS.',
              'Work has outgrown capacity. Headcount stays flat while app updates, fixes, and exceptions keep increasing.',
              'Major initiatives stall on app readiness. Cloud moves, AVD/Citrix projects, hardware refreshes, and AI efforts all slow down at the same point.',
            ],
            analyst: "Across industries, application delivery — not infrastructure — is now the primary bottleneck to modernization. Most transformation projects slow or fail because teams lack capacity to keep apps ready while platforms change.."
            },
            now: {
              intro: "The gap between what IT is asked to deliver and what it can sustain is widening fast.",
              bullets: [
              'Change is accelerating, not slowing down. More app updates, more security pressure, more platforms — with the same teams.',
              'Manual app work compounds over time. Every custom or internal app adds more versions, more dependencies, and more risk with each change',
              'Teams that should be driving innovation are stuck keeping apps alive.',
            ],
            analyst: "Organizations that succeed with AI, cloud, and new platforms over the next few years will be the ones that stabilize application delivery first. Everyone else hits a capacity wall where progress slows regardless of strategy"
            },
            recast: {
              intro: "Application Workspace changes how apps are delivered — to the user, not the device.",
              bullets: [
                'One workspace for every app. Commercial, internal, and legacy apps are delivered consistently across Intune, ConfigMgr, AVD, and other platforms.',
                'Less version sprawl, fewer variables. Fewer app versions mean fewer tickets, faster fixes, and simpler support..',
                'Capacity returns to the team. What used to take hours becomes minutes, freeing teams to move modernization forward',
              ],
              analyst: "Leading IT organizations are shifting from device-centric management to user-centric delivery models to reduce operational friction and keep pace with constant platform change."
            }
          }));
        },
        defaultsChartConfig() {
          return JSON.parse(JSON.stringify({
            yAxis: "Expectations and Requests",
            xAxis: "Time",
            center: "The widening gap",
            footer: "Limited budget, flat headcount, and finite operational capacity",
            tipping: "Operational breaking point"
          }));
        },
        defaultsDrivers() {
          return JSON.parse(JSON.stringify([
            { id: "more_apps", label: "More Applications", subtext: "Portfolio growth across Windows, macOS, VDI, web", markerYear: 2025.6, bullets: ["Every new app adds ongoing work—packaging, testing, updates, support.", "App sprawl compounds across Windows, macOS, VDI, and web delivery paths.", "Portfolio growth increases version drift and troubleshooting load."], short: "More apps = more packaging, updates, testing, support.", state: 'off' },
            { id: "constant_updates", label: "Constant Change", subtext: "Security patches, compatibility, vendor releases", markerYear: 2026.2, bullets: ["Updates are continuous, not occasional—work never clears.", "Security patches and compatibility changes create perpetual churn.", "Release velocity outpaces admin capacity."], short: "Updates are continuous; stability requires constant change.", state: 'off' },
            { id: "too_many_tools", label: "Hybrid Environments", subtext: "Fragmented delivery across platforms", markerYear: 2026.8, bullets: ["App delivery is fragmented across tools and environments (e.g., Intune/ConfigMgr/VDI).", "Teams rebuild packaging and deployment logic per platform.", "Tool fragmentation creates handoffs, duplication, and drift."], short: "Same app, different platforms, rebuilt logic everywhere.", state: 'off' },
            { id: "manual_rework", label: "Too Much Manual Work", subtext: "Rebuilds, exceptions, one-off fixes", markerYear: 2027.3, bullets: ["Manual rebuilds per version create packaging backlog and rework.", "Reactive fixes become permanent exceptions (technical debt).", "Firefighting displaces planned work and modernization."], short: "Rebuilds, retesting, one-off fixes consume senior time.", state: 'off' },
            { id: "security_compliance", label: "Security and Compliance Pressure", subtext: "Higher urgency, higher risk", markerYear: 2027.7, bullets: ["Security/compliance raises the urgency and risk of app change.", "Inconsistent versions and installs increase exposure and escalations.", "Patching timelines stretch when workflows are manual and fragmented."], short: "More urgency, less tolerance; complexity amplifies risk.", state: 'off' }
          ]));
        },
        progress: { apps: 0, time: 0, tickets: 0 },
        envProgress: { appsProcessed: 0 },
        calcInputs: { apps: 250, envs: 3, changes: 20 },
        calcResult: null,
        qualified: false
      };
      const TABS = [
        { id: 'problems', label: 'Current State', icon: 'alert-triangle' },
        { id: 'solution', label: 'Recast Approach', icon: 'workflow' },
        { id: 'roi', label: 'Business Impact', icon: 'bar-chart-3' }
      ];
      const NEW_CARDS = [
        {
          id: 'core',
          icon: 'layers',
          title: 'How Recast Does It.',
          bullets: [
            'One workspace to package, deploy, update, and retire apps across Intune, SCCM, Citrix, Omnissa, and Azure.',
            '8,000+ pre-tested enterprise apps ready to deploy instantly.',
            'Automated patching and validation keep apps secure and compliant.',
            'Unified dashboard for visibility and governance across all environments.',
            'Policy-driven automation reduces manual work by over 60%.',
            'End users get the right app instantly — no tickets, no delays.'
          ],
          closer: 'Configured once — Delivered everywhere.',
          timeline: false,
          bgHeader: 'bg-[#f9fafb]',
          bgContent: 'bg-[#f9fafb]'
        },
        {
          id: 'onboarding',
          icon: 'clock',
          title: 'Onboard & Up to Speed Fast.',
          bullets: [
            'Standard rollout in 4–6 weeks (Kickoff — Implementation — UAT — Launch — Enablement).',
            'No new infrastructure — integrates with your existing management tools.',
            'Guided setup with dedicated Customer Success Manager.',
            'Typical resource: 1–2 IT engineers part-time.',
            'Enablement includes training, certification, and success planning.'
          ],
          closer: 'From first call to production in weeks, not months.',
          timeline: true,
          bgHeader: 'bg-[#f9fafb]',
          bgContent: 'bg-[#f9fafb]'
        },
        {
          id: 'trust',
          icon: 'shield-check',
          title: 'Trusted by Customers',
          bullets: [
            '60M+ endpoints across 130+ countries.',
            '70k+ Customers & Trusted by global organizations| Citibank, McKinsey & Company, U.S. Air Force, FEMA, Hitachi, Johns Hopkins, Costco, Government of Canada.',
            '87 CSAT Score | Most trusted in the industry',
            'Proven scalability from small pilots to global deployments.',
            'Backed by enterprise-grade support and compliance alignment (SOC 2, ISO 27001).'
          ],
          closer: 'Trusted by organizations that can’t afford downtime.',
          timeline: false,
          bgHeader: 'bg-[#f9fafb]',
          bgContent: 'bg-[#f9fafb]'
        }
      ];
      const onboardingMiniTimelineEnabled = true;
      const NODE_DATA = {
        'platform': {
          bullets: ['Cloud', 'Endpoint / VDI', 'SCCM to Intune', 'Citrix to AVD'],
          pos: {x:200, y:50},
          anchor: 'bottom'
        },
        'application': {
          bullets: ['New apps', 'Continuous updates'],
          pos: {x:700, y:50},
          anchor: 'bottom'
        },
        'security': {
          bullets: ['MFA', 'Zero Trust'],
          pos: {x:200, y:370},
          anchor: 'top'
        },
        'device': {
          bullets: ['Windows / macOS', 'ARM / VDI'],
          pos: {x:700, y:370},
          anchor: 'top'
        },
        'user': {
          bullets: ['Instant access', 'No downtime'],
          pos: {x:70, y:210},
          anchor: 'right'
        },
        'modernization': {
          bullets: ['Cloud moves', 'AI projects'],
          pos: {x:830, y:210},
          anchor: 'left'
        }
      };
      const NODE_DATA_RECAST = {
        'platform': {
          bullets: ['Cloud migrations without app rework', 'Endpoint to VDI seamless shift', 'SCCM to Intune automated transition', 'Citrix to AVD quick migration'],
          pos: {x:200, y:50},
          anchor: 'bottom'
        },
        'application': {
          bullets: ['Automated new app onboarding', 'Continuous updates with zero touch', 'Version sprawl elimination', 'Legacy app virtualization'],
          pos: {x:700, y:50},
          anchor: 'bottom'
        },
        'security': {
          bullets: ['Built-in MFA integration', 'Zero Trust app access', 'Automated compliance checks', 'Instant security patching'],
          pos: {x:200, y:370},
          anchor: 'top'
        },
        'device': {
          bullets: ['Universal Windows/macOS support', 'ARM device compatibility', 'VDI/physical unified management', 'Cross-OS version consistency'],
          pos: {x:700, y:370},
          anchor: 'top'
        },
        'user': {
          bullets: ['Instant self-service app access', 'Zero downtime updates', 'Seamless multi-device sync', 'Intuitive workspace portal'],
          pos: {x:70, y:210},
          anchor: 'right'
        },
        'modernization': {
          bullets: ['Accelerated cloud migrations', 'AI readiness without app blocks', 'Streamlined hardware refreshes', 'Continuous digital transformation'],
          pos: {x:830, y:210},
          anchor: 'left'
        }
      };
      function cx(...a){ return a.filter(Boolean).join(' '); }
      function round(n){ return Math.round(n*100)/100; }
      function num(n){ return new Intl.NumberFormat().format(Math.round(n)); }
      function routeRecommendation(ctx){
        if(!ctx.compliant) return 'Web';
        if(ctx.device==='Windows' && ctx.network!=='Home') return 'Local';
        return 'VDI';
      }
      function cleanNum(v){ v = Number(String(v).replace(/[^0-9.\-]/g,'')); return isFinite(v) ? v : 0; }
      function render(){
        const root=document.getElementById('app');
        root.innerHTML = `
          <header class="relative">
            <div class="relative mx-auto max-w-6xl px-4 pt-8 pb-6">
              <h1 class="text-[40px] md:text-[56px] font-semibold leading-tight"><span style="color:#0070F3">Re</span><span style="color:#0A1C60">cast</span> Software</h1>
              <p class="mt-2 max-w-2xl text-[16px] leading-[1.5] text-[#4A5568]">
                ${STATE.activeTab==='problems'
                  ? 'The application layer is now the primary constraint in modern IT.'
                  : 'Application Workspace helps IT keep applications running smoothly as platforms change — without creating more work'}
              </p>
            </div>
            <div class="relative mx-auto max-w-6xl px-4">
              <div role="tablist" aria-label="Demo sections" class="flex w-full flex-wrap gap-2 rounded bg-slate-50 p-1 ring-1 ring-slate-200">
                ${TABS.map(t=>`
                  <button type="button" class="${cx('inline-flex items-center gap-2 px-3.5 py-1.5 text-sm focus-ring transition', STATE.activeTab===t.id ? 'bg-[#0070F3] text-white hover:bg-[#005AD0] rounded' : 'text-[#0A1C60] hover:bg-slate-100 rounded')}" data-action="switch-tab" data-tab="${t.id}" aria-controls="panel-${t.id}" aria-selected="${STATE.activeTab===t.id}">
                    <i data-lucide="${t.icon}" class="w-4 h-4"></i><span>${t.label}</span>
                  </button>
                `).join('')}
              </div>
            </div>
          </header>
          <main class="mx-auto max-w-6xl px-4 pb-16">
            ${STATE.activeTab==='roi' ? `
            <div class="mt-3 grid grid-cols-1 gap-3 sm:grid-cols-3">
              ${chip('Reactive Work Reduced', String(STATE.impact.minutes)+' min/user/mo', 'emerald')}
              ${chip('Hours Saved from Packaging', String(round(STATE.impact.pkgHours)), 'sky')}
              ${chip('Hours Saved from Faster Patching', String(round(STATE.impact.riskHrs)), 'yellow')}
            </div>` : ''}
            <section class="mt-5">${renderActivePanel()}</section>
          </main>
          ${renderModal()}
          ${renderWhyModal()}
          ${renderInsightModal()}
        `;
        if (window.lucide?.createIcons) { try { window.lucide.createIcons(); } catch {} }
        attachEvents();
        if (STATE.activeTab === 'solution') { buildFlow(); }
        if (STATE.activeTab === 'roi') { updateROIOutputs(); }
        if (STATE.activeTab === 'solution') { attachAccordionKeyboard(); }
        if (STATE.activeTab === 'problems') {
          renderCapacityGapChart();
          if (Math.abs(STATE.currentDemandExponent - STATE.targetDemandExponent) > 0.001 || Math.abs(STATE.currentCapacitySlope - STATE.targetCapacitySlope) > 0.001) {
            requestAnimationFrame(animateCurves);
          }
        }
      }
      function chip(label,value,tone){
        const tones={emerald:'from-emerald-400/80 to-teal-400/80',sky:'from-sky-400/80 to-indigo-400/80',yellow:'from-yellow-300/90 to-amber-400/90'};
        return `
          <div class="section-card p-3">
            <div class="text-[11px] text-[#4A5568]">${label}</div>
            <div class="mt-1 inline-flex items-center gap-2 rounded-[2px] bg-gradient-to-r px-2 py-0.5 text-slate-900 ${tones[tone]}">
              <i data-lucide="badge-check" class="w-4 h-4"></i><span class="text-sm font-semibold tabular-nums">${value}</span>
            </div>
          </div>
        `;
      }
      function renderActivePanel(){
        if (STATE.activeTab==='problems') return renderProblems();
        if (STATE.activeTab==='solution') return renderSolution();
        if (STATE.activeTab==='roi') return renderROI();
        return '';
      }
      function renderProblems(){
        const items=[
          {t:'Same App, Different Experience',s:'Apps behave differently across Windows, macOS, VDI, and web — creating confusion, inconsistency, and support issues',i:'layers'},
          {t:'App Changes Take Too Long',s:'Each update requires rebuilds, retesting, and rework — slowing delivery and piling up backlog.',i:'boxes'},
          {t:'Zero-day exposure',s:'Patching takes days, not minutes.',i:'shield'},
          {t:'Change Feels Risky',s:'Teams delay upgrades because app readiness and compatibility are uncertain.',i:'layout-grid'}
        ];
        return `
          <section id="panel-problems" class="space-y-4">
            <div class="grid grid-cols-1 gap-3 sm:grid-cols-2 lg:grid-cols-4">
              ${items.map(p=>`
                <article class="section-card p-4">
                  <div class="flex items-center gap-2"><i data-lucide="${p.i}" class="w-5 h-5 text-[#0070F3]"></i><h3 class="text-base font-semibold">${p.t}</h3></div>
                  <p class="mt-1 text-sm text-[#4A5568]">${p.s}</p>
                </article>
              `).join('')}
            </div>
            <div class="section-card p-6">
              <div class="grid grid-cols-1 lg:grid-cols-[1fr_auto] gap-6 items-start">
                <div class="relative">
                  <svg id="capacity-gap-chart" class="w-full h-96"></svg>
                </div>
                <div class="w-full lg:w-80 bg-white rounded-2xl shadow-md p-6">
                  <h3 class="text-xl font-medium mb-6">Modern IT Challenges</h3>
                  <div class="grid grid-cols-1 gap-6 items-stretch">
                    ${calloutDropdown('change','alert-triangle','Why Change','bg-slate-50')}
                    ${calloutDropdown('now','clock-4','Why Now','bg-slate-50', false, "Because the current model can’t handle the amount of change that’s coming")}
                    ${calloutDropdown('recast','sparkles','Why Recast','bg-slate-50', true)}
                  </div>
                </div>
              </div>
            </div>
          </section>
        `;
      }
      function renderCapacityGapChart(){
        const svg = document.getElementById('capacity-gap-chart');
        if (!svg) return;
        svg.innerHTML = '';
        svg.setAttribute('viewBox', '0 0 800 400');
        const width = 700, height = 300, margin = {left: 50, bottom: 50, top: 50, right: 50};
        const xScale = t => margin.left + t * width;
        const yScale = v => margin.top + height - v * height;
        // Axes
        const xAxis = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        xAxis.innerHTML = `
          <line x1="${margin.left}" y1="${margin.top + height}" x2="${margin.left + width}" y2="${margin.top + height}" stroke="#d1d5db" stroke-width="1"/>
          <text x="${margin.left + width / 2}" y="${margin.top + height + 40}" text-anchor="middle" font-size="14" fill="#111827">${STATE.chartConfig.xAxis}</text>
          ${STATE.years.map((year, i) => {
            const x = xScale(i / 3);
            return `
              <line x1="${x}" y1="${margin.top + height}" x2="${x}" y2="${margin.top + height + 10}" stroke="#d1d5db" stroke-width="1"/>
              <text x="${x}" y="${margin.top + height + 25}" text-anchor="middle" font-size="12" fill="#111827">${year}</text>
            `;
          }).join('')}
          <text x="${margin.left + width / 2}" y="${margin.top + height + 60}" text-anchor="middle" font-size="12" fill="#6b7280"> ${STATE.chartConfig.footer}</text>
        `;
        svg.appendChild(xAxis);
        const yAxis = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        yAxis.innerHTML = `
          <line x1="${margin.left}" y1="${margin.top}" x2="${margin.left}" y2="${margin.top + height}" stroke="#d1d5db" stroke-width="1"/>
          <text x="${margin.left - 10}" y="${margin.top + height / 2}" text-anchor="middle" font-size="14" fill="#111827" transform="rotate(-90, ${margin.left - 10}, ${margin.top + height / 2})">${STATE.chartConfig.yAxis}</text>
        `;
        svg.appendChild(yAxis);
        // Curves
        const exp = STATE.currentDemandExponent;
        const slope = STATE.currentCapacitySlope;
        let demandPath = `M ${xScale(0)} ${yScale(0)}`;
        let capacityPath = `M ${xScale(0)} ${yScale(0.3)}`;
        let demandPoints = [];
        let capacityPoints = [];
        for (let i = 0; i <= 100; i++) {
          let t = i / 100;
          let dem = Math.pow(t, exp);
          let cap = 0.3 + slope * t;
          demandPath += ` L ${xScale(t)} ${yScale(dem)}`;
          capacityPath += ` L ${xScale(t)} ${yScale(cap)}`;
          demandPoints.push({x: xScale(t), y: yScale(dem)});
          capacityPoints.push({x: xScale(t), y: yScale(cap)});
        }
        const demandLine = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        demandLine.setAttribute('d', demandPath);
        demandLine.setAttribute('stroke', '#ef4444');
        demandLine.setAttribute('stroke-width', '2');
        demandLine.setAttribute('fill', 'none');
        svg.appendChild(demandLine);
        const capacityLine = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        capacityLine.setAttribute('d', capacityPath);
        capacityLine.setAttribute('stroke', '#3b82f6');
        capacityLine.setAttribute('stroke-width', '2');
        capacityLine.setAttribute('fill', 'none');
        svg.appendChild(capacityLine);
        // Gap shading
        let numNormal = 0, numAccelerating = 0;
        STATE.drivers.forEach(d => { if (d.state === 'normal') numNormal++; if (d.state === 'accelerating') numAccelerating++; });
        const pressure = numNormal + numAccelerating * 2;
        const lightness = 95 - pressure * 1.5;
        const gapPath = demandPoints.map(p => `L ${p.x} ${p.y}`).join(' ') + capacityPoints.reverse().map(p => `L ${p.x} ${p.y}`).join(' ') + 'Z';
        const gap = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        gap.setAttribute('d', `M ${demandPoints[0].x} ${demandPoints[0].y} ` + gapPath);
        gap.setAttribute('fill', `hsl(220, 10%, ${lightness}%)`);
        svg.appendChild(gap);
        const gapLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        gapLabel.setAttribute('x', xScale(0.5));
        gapLabel.setAttribute('y', yScale(0.5));
        gapLabel.setAttribute('text-anchor', 'middle');
        gapLabel.setAttribute('font-size', '16');
        gapLabel.setAttribute('fill', '#6b7280');
        gapLabel.textContent = STATE.chartConfig.center;
        svg.appendChild(gapLabel);
        // Markers
        STATE.drivers.forEach(d => {
          if (d.markerYear && (d.state === 'normal' || d.state === 'accelerating')) {
            const t = (d.markerYear - 2025) / 3;
            const dem = Math.pow(t, exp);
            const x = xScale(t);
            const y = yScale(dem);
            const emphasis = d.state === 'accelerating' ? 8 : 6;
            const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            g.setAttribute('role', 'button');
            g.setAttribute('tabindex', '0');
            g.setAttribute('aria-label', `Learn more about ${d.label}`);
            g.innerHTML = `
              <title>${d.short}</title>
              <circle cx="${x}" cy="${y}" r="20" fill="transparent" stroke="none"/>
              <circle cx="${x}" cy="${y}" r="${emphasis}" fill="#ef4444"/>
              <text x="${x + 10}" y="${y + 4}" font-size="12" fill="#111827">${d.label}</text>
            `;
            g.addEventListener('click', () => openInsight(d));
            g.addEventListener('keydown', e => { if (e.key === 'Enter') openInsight(d); });
            svg.appendChild(g);
          }
        });
        // Always-on resources limited label
        const endT = 1;
        const endCap = 0.3 + slope * endT;
        const endX = xScale(endT);
        const endY = yScale(endCap) + 20;
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', endX - 50);
        text.setAttribute('y', endY);
        text.setAttribute('font-size', '12');
        text.setAttribute('fill', '#6b7280');
        text.textContent = 'Limited Capacity';
        svg.appendChild(text);
        // Tipping point
        if (STATE.showTippingPoint) {
          const t = (STATE.tippingPointYear - 2025) / 3;
          const x = xScale(t);
          const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
          line.setAttribute('x1', x);
          line.setAttribute('y1', yScale(0));
          line.setAttribute('x2', x);
          line.setAttribute('y2', yScale(1));
          line.setAttribute('stroke', '#ef4444');
          line.setAttribute('stroke-width', '2');
          line.setAttribute('stroke-dasharray', '5 5');
          svg.appendChild(line);
          const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          label.setAttribute('x', x + 10);
          label.setAttribute('y', yScale(1) - 10);
          label.setAttribute('font-size', '12');
          label.setAttribute('fill', '#111827');
          label.textContent = 'IT Inflection Point';
          svg.appendChild(label);
          const ann = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          ann.setAttribute('x', x + 10);
          ann.setAttribute('y', yScale(0.8) + 5);
          ann.setAttribute('font-size', '12');
          ann.setAttribute('fill', '#ef4444');
          ann.textContent = STATE.chartConfig.tipping;
          svg.appendChild(ann);
          const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
          g.setAttribute('role', 'button');
          g.setAttribute('tabindex', '0');
          g.setAttribute('aria-label', 'Learn more about Projected Tipping Point');
          g.innerHTML = `
            <rect x="${x - 10}" y="${yScale(1) - 20}" width="20" height="${height}" fill="transparent"/>
          `;
          g.addEventListener('click', () => openInsight(STATE.tippingPoint));
          g.addEventListener('keydown', e => { if (e.key === 'Enter') openInsight(STATE.tippingPoint); });
          svg.appendChild(g);
        }
      }
      function updateCurves(){
        let numNormal = 0, numAccelerating = 0;
        STATE.drivers.forEach(d => { if (d.state === 'normal') numNormal++; if (d.state === 'accelerating') numAccelerating++; });
        STATE.targetDemandExponent = 1.6 + (numNormal * 0.15 + numAccelerating * 0.3);
        STATE.targetDemandExponent = Math.min(STATE.targetDemandExponent, 3);
        STATE.targetCapacitySlope = 0;
        STATE.showTippingPoint = numAccelerating >= 3;
      }
      function animateCurves(timestamp){
        STATE.currentDemandExponent += (STATE.targetDemandExponent - STATE.currentDemandExponent) * 0.1;
        STATE.currentCapacitySlope += (STATE.targetCapacitySlope - STATE.currentCapacitySlope) * 0.1;
        renderCapacityGapChart();
        if (Math.abs(STATE.currentDemandExponent - STATE.targetDemandExponent) > 0.001 || Math.abs(STATE.currentCapacitySlope - STATE.targetCapacitySlope) > 0.001) {
          requestAnimationFrame(animateCurves);
        }
      }
      function setSlider(id, value){
        const driver = STATE.drivers.find(d => d.id === id);
        if (driver) {
          driver.state = ['off', 'normal', 'accelerating'][value];
          updateCurves();
          requestAnimationFrame(animateCurves);
          renderCapacityGapChart();
        }
      }
      function resetSliders(){
        STATE.drivers.forEach(d => d.state = 'off');
        STATE.currentDemandExponent = 1.6;
        STATE.targetDemandExponent = 1.6;
        STATE.currentCapacitySlope = 0;
        STATE.targetCapacitySlope = 0;
        STATE.showTippingPoint = false;
        render();
      }
      function openInsight(content){
        STATE.insightContent = content;
        render();
      }
      function renderInsightModal(){
        if (!STATE.insightContent) return '';
        const c = STATE.insightContent;
        const title = c.title || c.label;
        const intro = c.intro || c.short;
        const bullets = c.bullets || [];
        const closing = c.closing || '';
        return `
          <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 modal-overlay" role="dialog" aria-modal="true" aria-labelledby="insight-modal-title">
            <div class="w-full max-w-4xl mx-4 bg-white rounded-2xl shadow-2xl overflow-hidden transform modal-content">
              <div class="bg-slate-50 px-8 py-6 flex items-center justify-between" style="border-bottom:1px solid var(--border-subtle)">
                <div class="flex items-center gap-3">
                  <i data-lucide="lightbulb" class="w-8 h-8 text-[#0A1C60]" aria-hidden="true"></i>
                  <h2 id="insight-modal-title" class="text-3xl font-bold tracking-tight text-[#0A1C60]">${title}</h2>
                </div>
                <button type="button" class="text-slate-500 hover:text-slate-700 focus-ring p-2" data-action="close-insight-modal" aria-label="Close">
                  <i data-lucide="x" class="w-6 h-6"></i>
                </button>
              </div>
              <div class="p-8 bg-slate-50">
                ${intro ? `<p class="text-base leading-relaxed text-[#4A5568] mb-4">${intro}</p>` : ''}
                <div class="space-y-4">
                  ${bullets.map(b=>`
                    <div class="bg-white p-4 rounded-lg shadow-sm flex items-start gap-3 hover:shadow-md transition-shadow">
                      <i data-lucide="check-circle" class="w-5 h-5 text-[#0070F3] flex-shrink-0 mt-0.5"></i>
                      <p class="text-base leading-relaxed text-[#4A5568]">${b}</p>
                    </div>
                  `).join('')}
                </div>
                ${closing ? `
                  <div class="mt-6 bg-white p-4 rounded-lg shadow-sm hover:shadow-md transition-shadow flex items-start gap-3">
                    <i data-lucide="lightbulb" class="w-5 h-5 text-yellow-400 flex-shrink-0 mt-0.5"></i>
                    <p class="text-base italic text-[#4A5568]">${closing}</p>
                  </div>
                ` : ''}
              </div>
            </div>
          </div>
        `;
      }
      function renderMindMap(isRecast = false, containerClass = 'relative w-full h-72') {
        const centralFill = isRecast ? '#10b981' : '#2563eb';
        const centralStroke = isRecast ? '#059669' : '#1d4ed8';
        const ringStroke = isRecast ? '#10b981' : '#f59e0b';
        const ringText1 = isRecast ? 'Application Workspace' : 'Application Delivery & Readiness';
        const ringText2 = isRecast ? 'Absorbs all change' : 'Where all change converges';
        const ringTextColor = isRecast ? '#059669' : '#92400e';
        const centralText1 = isRecast ? 'Application Workspace' : 'Modern IT';
        const centralText2 = isRecast ? 'Stable app layer' : 'Operating Model';
        const arrowFill = isRecast ? '#6ee7b7' : '#cbd5f5';
        const lineStroke = isRecast ? '#6ee7b7' : '#cbd5f5';
        const markerAttr = isRecast ? 'marker-start="url(#arrow)"' : 'marker-end="url(#arrow)"';
        const nodeData = isRecast ? NODE_DATA_RECAST : NODE_DATA;
        const lines = isRecast ? [
          {x1:390, y1:170, x2:220, y2:60},
          {x1:510, y1:170, x2:680, y2:60},
          {x1:390, y1:250, x2:220, y2:360},
          {x1:510, y1:250, x2:680, y2:360},
          {x1:365, y1:210, x2:90, y2:210},
          {x1:535, y1:210, x2:810, y2:210}
        ] : [
          {x1:220, y1:60, x2:390, y2:170},
          {x1:680, y1:60, x2:510, y2:170},
          {x1:220, y1:360, x2:390, y2:250},
          {x1:680, y1:360, x2:510, y2:250},
          {x1:90, y1:210, x2:365, y2:210},
          {x1:810, y1:210, x2:535, y2:210}
        ];
        const nodes = [
          {id: 'platform', cx:200, cy:50, text1:'Platform', text2:'Change', sub1:'Cloud', sub2:'Endpoint / VDI'},
          {id: 'application', cx:700, cy:50, text1:'Application', text2:'Change', sub1:'New apps', sub2:'Continuous updates'},
          {id: 'security', cx:200, cy:370, text1:'Security', text2:'& Compliance', sub1:'MFA', sub2:'Zero Trust'},
          {id: 'device', cx:700, cy:370, text1:'Device & OS', text2:'Diversity', sub1:'Windows / macOS', sub2:'ARM / VDI'},
          {id: 'user', cx:70, cy:210, text1:'User', text2:'Expectations', sub1:'Instant access', sub2:'No downtime'},
          {id: 'modernization', cx:830, cy:210, text1:'Modernization', text2:'Initiatives', sub1:'Cloud moves', sub2:'AI projects'}
        ];
        return `
          <div class="${containerClass}">
            <svg viewBox="0 0 900 420" class="w-full h-full">
              <circle cx="450" cy="210" r="85" fill="none" stroke="${ringStroke}" stroke-width="2" stroke-dasharray="4 4" />
              <text x="450" y="140" text-anchor="middle" fill="${ringTextColor}" font-size="13" font-weight="600">${ringText1}</text>
              <text x="450" y="156" text-anchor="middle" fill="${ringTextColor}" font-size="11">${ringText2}</text>
              <circle cx="450" cy="210" r="42" fill="${centralFill}" stroke="${centralStroke}" stroke-width="2" />
              <text x="450" y="206" text-anchor="middle" fill="white" font-size="13" font-weight="700">${centralText1}</text>
              <text x="450" y="222" text-anchor="middle" fill="white" font-size="11">${centralText2}</text>
              <defs>
                <marker id="arrow" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
                  <path d="M 0 0 L 10 5 L 0 10 z" fill="${arrowFill}"/>
                </marker>
              </defs>
              ${lines.map(l => `<line x1="${l.x1}" y1="${l.y1}" x2="${l.x2}" y2="${l.y2}" stroke="${lineStroke}" stroke-width="2" ${markerAttr} />`).join('')}
              ${nodes.map(n => `
                <g class="interactive-node cursor-pointer" data-id="${n.id}" role="button" tabindex="0" aria-label="View details for ${n.text1} ${n.text2}" aria-expanded="${STATE.activePopover === n.id ? 'true' : 'false'}">
                  <circle cx="${n.cx}" cy="${n.cy}" r="34" fill="white" stroke="#2563eb" stroke-width="2" />
                  <text x="${n.cx}" y="${n.cy - 6}" text-anchor="middle" font-size="12" font-weight="600" fill="#111827">${n.text1}</text>
                  <text x="${n.cx}" y="${n.cy + 8}" text-anchor="middle" font-size="12" font-weight="600" fill="#111827">${n.text2}</text>
                  <text x="${n.cx}" y="${n.cy + 24}" text-anchor="middle" font-size="10" fill="#6b7280">${n.sub1}</text>
                  <text x="${n.cx}" y="${n.cy + 38}" text-anchor="middle" font-size="10" fill="#6b7280">${n.sub2}</text>
                </g>
              `).join('')}
            </svg>
          </div>
        `;
      }
      function calloutDropdown(id, icon, label, headerTone, cta=false, subtext=''){
        return `
          <div class="h-full flex flex-col">
            <button
              type="button"
              class="w-full overflow-hidden ring-1 ring-slate-200 focus-ring transition hover:ring-slate-300 shadow-sm"
              data-action="open-why-modal"
              data-why="${id}"
              style="border-radius:var(--radius)"
            >
              <div class="${cx('flex items-center justify-between px-5 py-4', headerTone)}" style="border-bottom:1px solid var(--border-subtle)">
                <div class="flex items-center gap-2">
                  <i data-lucide="${icon}" class="w-5 h-5 text-[#0A1C60]" aria-hidden="true"></i>
                  <span class="text-[22px] font-semibold tracking-normal text-[#0A1C60]">${label}</span>
                </div>
                <i data-lucide="chevron-right" class="w-5 h-5 text-[#4A5568] transition-transform duration-150" aria-hidden="true"></i>
              </div>
            </button>
            ${subtext ? `<p class="px-5 py-2 text-sm text-gray-700">${subtext}</p>` : ''}
          </div>
        `;
      }
      const whyOrder = ['change', 'now', 'recast'];
      function renderWhyModal(){
        if(!STATE.openWhyModal) return '';
        const id = STATE.openWhyModal;
        const iconMap = { change: 'alert-triangle', now: 'clock-4', recast: 'sparkles' };
        const labelMap = { change: 'Why Change', now: 'Why Now', recast: 'Why Recast' };
        const data = STATE.currentState[id];
        const headerTone = 'bg-slate-50';
        const cta = id === 'now';
        const modalClass = 'w-full max-w-4xl mx-4 bg-white rounded-2xl shadow-2xl overflow-hidden transform modal-content';
        const currentIdx = whyOrder.indexOf(id);
        const prev = currentIdx > 0 ? whyOrder[currentIdx - 1] : null;
        const next = currentIdx < whyOrder.length - 1 ? whyOrder[currentIdx + 1] : null;
        const content = `
          <div class="p-8 bg-slate-50">
            <p class="text-base leading-relaxed text-[#4A5568] mb-4">${data.intro}</p>
            <div class="space-y-4">
              ${data.bullets.map(b=>`
                <div class="bg-white p-4 rounded-lg shadow-sm flex items-start gap-3 hover:shadow-md transition-shadow">
                  <i data-lucide="check-circle" class="w-5 h-5 text-[#0070F3] flex-shrink-0 mt-0.5"></i>
                  <p class="text-base leading-relaxed text-[#4A5568]">${b}</p>
                </div>
              `).join('')}
            </div>
            <div class="mt-6 bg-white p-4 rounded-lg shadow-sm hover:shadow-md transition-shadow flex items-start gap-3">
              <i data-lucide="lightbulb" class="w-5 h-5 text-yellow-400 flex-shrink-0 mt-0.5"></i>
              <p class="text-base italic text-[#4A5568]">${data.analyst}</p>
            </div>
            ${cta?`
              <div class="mt-8 flex justify-center">
                <button id="btnAdvanceToSolution" type="button" data-action="advance" data-next="solution" class="inline-flex bg-[#0070F3] text-white text-base font-semibold px-6 py-3 items-center gap-3 focus-ring shadow-md hover:shadow-lg hover:bg-[#005AD0] transition-shadow">
                  <i data-lucide="arrow-right" class="w-5 h-5"></i>
                  How Recast solves it
                </button>
              </div>
            `:''}
            <div class="mt-8 flex justify-between">
              ${prev ? `<button type="button" class="re-secondary inline-flex items-center gap-2" data-action="why-nav" data-to="${prev}"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back</button>` : '<div></div>'}
              ${next ? `<button type="button" class="re-primary inline-flex items-center gap-2" data-action="why-nav" data-to="${next}">Next <i data-lucide="arrow-right" class="w-4 h-4"></i></button>` : `<button type="button" class="re-primary inline-flex items-center gap-2" data-action="advance" data-next="solution">See Approach <i data-lucide="arrow-right" class="w-4 h-4"></i></button>`}
            </div>
          </div>
        `;
        return `
          <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 modal-overlay" role="dialog" aria-modal="true" aria-labelledby="why-modal-title-${id}">
            <div class="${modalClass}" style="max-height: none;" ${id === 'recast' ? 'id="recast-modal-content"' : ''}>
              <div class="${headerTone} px-8 py-6 flex items-center justify-between" style="border-bottom:1px solid var(--border-subtle)">
                <div class="flex items-center gap-3">
                  <i data-lucide="${iconMap[id]}" class="w-8 h-8 text-[#0A1C60]" aria-hidden="true"></i>
                  <h2 id="why-modal-title-${id}" class="text-3xl font-bold tracking-tight text-[#0A1C60]">${labelMap[id]}</h2>
                </div>
                <button type="button" class="text-slate-500 hover:text-slate-700 focus-ring p-2" data-action="close-why-modal" aria-label="Close">
                  <i data-lucide="x" class="w-6 h-6"></i>
                </button>
              </div>
              ${content}
            </div>
          </div>
        `;
      }
      function popoutCard(card){
        const expanded = STATE.openCards[card.id];
        const contentId = `card-content-${card.id}`;
        return `
          <div class="h-full flex flex-col">
            <button
              type="button"
              class="accordion-header w-full overflow-hidden ring-1 ring-slate-200 focus-ring transition hover:ring-slate-300 shadow-sm"
              data-action="toggle-card"
              data-card="${card.id}"
              aria-expanded="${expanded}"
              aria-controls="${contentId}"
              style="border-radius:var(--radius); min-height: 44px;"
            >
              <div class="${card.bgHeader || 'bg-slate-50'} px-5 py-4 flex flex-col" style="border-bottom:1px solid var(--border-subtle)">
                <div class="flex justify-between items-center">
                  <div class="flex items-center gap-2">
                    <i data-lucide="${card.icon}" class="w-6 h-6 text-[#0A1C60]" aria-hidden="true"></i>
                    <span class="text-xl font-semibold text-left tracking-normal text-[#0A1C60]">${card.title}</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="text-sm text-[#4A5568]">${expanded ? 'Collapse' : 'Expand'}</span>
                    <i data-lucide="chevron-down" class="w-5 h-5 text-[#4A5568] transition-transform duration-150 ${expanded ? 'rotate-180' : ''}" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </button>
            <div id="${contentId}" class="accordion-content overflow-hidden border-l-4 border-[#0070F3]" style="max-height:${expanded?'1200px':'0'};opacity:${expanded?'1':'0'};transition:max-height 150ms cubic-bezier(.2,.8,.2,1),opacity 150ms ease; ${card.bgContent}; padding:${expanded?'24px 20px':'0 20px'}">
              <ul class="list-disc pl-6 text-[16px] leading-[1.45] space-y-3 text-[#4A5568] text-left">
                ${card.bullets.map(b=>`<li>${b}</li>`).join('')}
              </ul>
              ${card.timeline && onboardingMiniTimelineEnabled && expanded ? renderMiniTimeline() : ''}
              <p class="mt-4 italic text-[16px] text-[#4A5568]">${card.closer}</p>
            </div>
          </div>
        `;
      }
      function renderMiniTimeline(){
        const phases = [
          {icon: 'play-circle', label: 'Kickoff'},
          {icon: 'hammer', label: 'Implementation'},
          {icon: 'check-circle', label: 'UAT'},
          {icon: 'flag', label: 'Launch'},
          {icon: 'book-open', label: 'Enablement'}
        ];
        return `
          <div class="flex items-center justify-between mt-4" aria-hidden="true">
            ${phases.map((p, i) => `
              ${i > 0 ? '<div class="flex-1 h-px bg-slate-200 mx-2"></div>' : ''}
              <div class="flex flex-col items-center">
                <i data-lucide="${p.icon}" class="w-5 h-5 text-[#0070F3]"></i>
                <span class="text-xs mt-1 text-[#4A5568]">${p.label}</span>
              </div>
            `).join('')}
          </div>
        `;
      }
      function bucketAccordion(id, icon, label, contentFunc, headerTone='bg-slate-50'){
        const expanded = STATE.openBuckets[id];
        const contentId = `bucket-content-${id}`;
        return `
          <div class="flex flex-col">
            <button
              type="button"
              class="w-full overflow-hidden ring-1 ring-slate-200 focus-ring transition hover:ring-slate-300 shadow-sm"
              data-action="toggle-bucket"
              data-bucket="${id}"
              aria-expanded="${expanded}"
              aria-controls="${contentId}"
              style="border-radius:var(--radius)"
            >
              <div class="flex items-center justify-between px-5 py-4 ${headerTone}" style="border-bottom:1px solid var(--border-subtle)">
                <div class="flex items-center gap-2">
                  <i data-lucide="${icon}" class="w-5 h-5 text-[#0A1C60]" aria-hidden="true"></i>
                  <span class="text-[18px] font-semibold tracking-normal text-[#0A1C60]">${label}</span>
                </div>
                <i data-lucide="${expanded?'chevron-up':'chevron-down'}" class="w-5 h-5 text-[#4A5568] transition-transform duration-150 ${expanded?'rotate-180':''}" aria-hidden="true"></i>
              </div>
            </button>
            <div id="${contentId}" class="accordion-content overflow-hidden" style="max-height:${expanded?'1200px':'0'};opacity:${expanded?'1':'0'};transition:max-height 150ms cubic-bezier(.2,.8,.2,1),opacity 150ms ease">
              ${expanded ? contentFunc() : ''}
            </div>
          </div>
        `;
      }
      function onePackageContent(){
        const saved=Math.max(0, Number(STATE.packHrs)-Number(STATE.configHrs));
        return `
          <div class="p-4">
            <div class="sub-card p-3 text-sm">
              <div class="flex items-center gap-2 font-medium"><i data-lucide="wand-sparkles" class="w-4 h-4"></i> Hours Saved from Packaging</div>
              <label class="mt-2 flex items-center gap-2 text-xs">
                <span class="text-[#4A5568]">Hours/package</span>
                <input class="w-16 rounded bg-slate-100 px-2 py-1" value="${STATE.packHrs}" inputmode="decimal" data-action="set-pack-hrs" aria-label="Hours per package">
                <span>→</span>
                <input class="w-16 rounded bg-slate-100 px-2 py-1" value="${STATE.configHrs}" inputmode="decimal" data-action="set-config-hrs" aria-label="Hours to configure">
              </label>
              <div class="mt-2 flex items-center justify-between rounded bg-slate-100 px-3 py-2"><span class="tabular-nums">${STATE.packHrs} → ${STATE.configHrs} hrs</span><strong class="tabular-nums">${saved} hrs saved</strong></div>
              <div class="mt-2 text-[12px] flex flex-wrap gap-2">
                <span class="rounded px-2 py-1 bg-slate-100">☁️ Cloud</span>
                <span class="rounded px-2 py-1 bg-slate-100">🖥️ On-Prem</span>
                <span class="rounded px-2 py-1 bg-slate-100">🔀 Hybrid</span>
              </div>
              <button type="button" class="mt-2 bg-[#0070F3] text-white px-3 py-1 text-xs font-semibold w-full rounded hover:bg-[#005AD0]" data-action="add-impact" data-kind="pkgHours" data-value="${saved}">Add to impact</button>
            </div>
          </div>
        `;
      }
      function zeroDayContent(){
        const reduced=Math.max(0, Number(STATE.currentHrs)-1.5);
        return `
          <div class="p-4">
            <div class="sub-card p-3 text-sm">
              <div class="flex items-center gap-2 font-medium"><i data-lucide="shield-check" class="w-4 h-4"></i> Hours Saved from Faster Patching</div>
              <label class="mt-2 flex items-center gap-2 text-xs">
                <span class="text-[#4A5568]">Current hrs</span>
                <input class="w-20 rounded bg-slate-100 px-2 py-1" value="${STATE.currentHrs}" inputmode="decimal" data-action="set-current-hrs" aria-label="Current time to deploy (hours)">
              </label>
              <div class="mt-2 flex items-center justify-between rounded bg-slate-100 px-3 py-2"><span class="tabular-nums">${STATE.currentHrs} → 1.5 hrs</span><strong class="tabular-nums">${round(reduced)} hrs reduced</strong></div>
              <button type="button" class="mt-2 bg-[#0070F3] text-white px-3 py-1 text-xs font-semibold w-full rounded hover:bg-[#005AD0]" data-action="add-impact" data-kind="riskHrs" data-value="${reduced}">Add to impact</button>
            </div>
          </div>
        `;
      }
      function perUserContent(){
        const totalMin = Math.max(0, Number(STATE.impact.minutes));
        const route=routeRecommendation(STATE.ctx);
        return `
          <div class="p-4">
            <div class="sub-card p-3 text-sm">
              <div class="flex items-center gap-2 font-medium"><i data-lucide="mouse-pointer" class="w-4 h-4"></i> Reactive Work Reduced</div>
              <div class="mt-2 flex items-center justify-between rounded bg-slate-100 px-3 py-2">
                <span class="tabular-nums">18 → ${totalMin} min</span>
                <strong class="tabular-nums">${totalMin} min saved</strong>
              </div>
            </div>
            <div class="mt-2 grid grid-cols-3 gap-2 text-xs">
              ${['Windows','Mac'].map(d=>pill(d,STATE.ctx.device===d,'set-device',d)).join('')}
              ${['Corporate','VPN'].map(n=>pill(n,STATE.ctx.network===n,'set-network',n)).join('')}
              ${pill(STATE.ctx.compliant?'Compliant':'Non-compliant',STATE.ctx.compliant,'toggle-compliance','')}
            </div>
            <div class="mt-3"><button type="button" class="bg-transparent text-[#0A1C60] border-2 border-[#0A1C60] px-3 py-1 text-xs w-full rounded hover:text-[#0070F3] hover:border-[#0070F3]" data-action="add-impact" data-kind="minutes" data-value="2">Add to impact (+2 min saved per user)</button></div>
          </div>
        `;
      }
      function renderSolution(){
        return `
          <section id="panel-solution" class="space-y-3">
            <div class="grid grid-cols-1 gap-3 lg:grid-cols-2">
              ${renderFlow()}
              <div class="flex flex-col gap-3 relative">
                <div class="sticky top-0 z-10 bg-[#F7F9FB] py-2 shadow-sm">
                  <div class="flex justify-between items-center text-sm">
                    <span class="font-semibold">Recast Approach</span>
                    <span class="text-[#4A5568]">${STATE.visitedCards.length} of 3 explored</span>
                  </div>
                </div>
                <button type="button" class="md:hidden bg-transparent text-[#0A1C60] border-2 border-[#0A1C60] py-2 text-sm rounded hover:text-[#0070F3] hover:border-[#0070F3]" data-action="expand-all">Expand All</button>
                ${NEW_CARDS.map(card => popoutCard(card)).join('')}
                <div class="sticky bottom-0 bg-[#F7F9FB] py-3 shadow-lg mt-3">
                  <button type="button" class="bg-[#0070F3] text-white px-4 py-2 text-sm font-semibold rounded hover:bg-[#005AD0]" data-action="advance" data-next="roi">See Business Impact</button>
                </div>
              </div>
            </div>
          </section>
        `;
      }
      function pill(label,active,action,value){
        return `<button type="button" class="${cx('px-3 py-1 border text-xs transition',active?'bg-[#0070F3] text-white border-transparent hover:bg-[#005AD0]':'bg-transparent text-[#0A1C60] border-slate-200 hover:border-[#0070F3]')} rounded-[2px]" data-action="${action}" data-value="${String(value)}">${label}</button>`;
      }
      function renderFlow(){
        return `
          <div class="section-card p-4">
            <div class="flex items-center justify-between gap-3">
              <div class="flex items-center gap-2">
                <div class="h-6 w-6 rounded-[2px] grid place-items-center bg-[#0A1C60]"><i data-lucide="boxes" class="h-3.5 w-3.5 text-white"></i></div>
                <div>
                  <h3 class="text-base font-semibold">Application Workspace</h3>
                  <div class="text-[12px] text-[#4A5568]">Deliver applications to users — independent of device or platform</div>
                </div>
              </div>
              <div class="flex items-center gap-2 text-[12px]">
                <button type="button" class="bg-transparent text-[#0A1C60] border-2 border-[#0A1C60] px-2.5 py-1 rounded hover:text-[#0070F3] hover:border-[#0070F3]" data-action="toggle-labels">${STATE.showLabels?'Hide':'Show'} labels</button>
                <button type="button" data-action="start-flow" class="bg-[#0070F3] text-white px-2.5 py-1.5 text-[12px] font-semibold rounded hover:bg-[#005AD0]">Start</button>
                <button type="button" data-action="reset-flow" class="bg-transparent text-[#0A1C60] border-2 border-[#0A1C60] px-2.5 py-1.5 rounded hover:text-[#0070F3] hover:border-[#0070F3]">Reset</button>
              </div>
            </div>
            <div class="mt-2 flex gap-2 text-xs">
            </div>
            <div id="envFlow" class="mt-3 sub-card p-3 relative bg-gradient-to-b from-white to-slate-50 shadow-inner ${STATE.showLabels ? 'show-labels' : ''}" role="region" aria-label="Environment flow">
              <div id="envSources" class="flex flex-wrap justify-between gap-2">
                ${ENV_SOURCES.map((env, idx) => `
                  <div class="env-wrap" style="--d: ${idx * 0.2}s">
                    <div class="env-ring logo-ring">${env.svg}</div>
                    <span class="env-name">${env.name}</span>
                  </div>
                `).join('')}
              </div>
              <div id="envArrows" class="grid grid-cols-6 gap-2 mt-2 mb-2">
                ${ENV_SOURCES.map((_, idx) => `<div class="arrow-line" style="--d: ${1 + idx * 0.2}s"></div>`).join('')}
              </div>
              <div id="envHub" class="hub-card sub-card p-2 text-center bg-white">
                <div class="flex items-center justify-center gap-2">
                  <i data-lucide="server" class="w-4 h-4 text-[#2563eb]"></i>
                  <span class="text-sm font-medium">Application Workspace</span>
                </div>
              </div>
              <div id="metricsBanner" class="metrics-banner mt-2">
                <span id="appsProcessedCounter" class="tabular-nums">0</span>+ Apps Processed
              </div>
            </div>
            <div id="flowCard" class="mt-3 sub-card p-2 relative bg-gradient-to-b from-white to-slate-50 shadow-inner ${STATE.showLabels ? 'show-labels' : ''}" role="region" aria-label="Animated flow">
              <div id="progressCounters" class="hidden mb-3 grid grid-cols-3 gap-2 text-sm text-center">
                <div><span class="font-semibold tabular-nums" id="appsProcessed">0</span> apps processed</div>
                <div><span class="font-semibold tabular-nums" id="timeSaved">0</span> hours saved</div>
                <div><span class="font-semibold tabular-nums" id="ticketsAvoided">0</span> tickets avoided</div>
              </div>
              <div class="space-y-2 relative">
                ${CATALOG.map(s=>`
                  <div class="cat-row">
                    <div class="cat-title uppercase text-[#4A5568]"><i data-lucide="folder" class="w-3 h-3"></i>${s.title}</div>
                    <div id="${s.id}" class="flex flex-wrap gap-2"></div>
                  </div>
                `).join('')}
                <div id="overlayTag" class="overlay-tag hidden text-center text-sm text-[#4A5568]">Every app mapped to stage, policy, region, and device.</div>
              </div>
              <div id="flowHubFlash" class="mt-2 hidden text-[#0070F3]"><span class="inline-flex items-center gap-1 text-[12px]"><i data-lucide="bolt" class="h-4 w-4"></i><span>Update published</span></span></div>
              <div class="mt-3 grid grid-cols-3 gap-2 relative" aria-hidden="true">
                ${['A','B','C'].map((k,i)=>`
                  <div class="sub-card p-2 relative">
                    <div class="text-[12px] text-[#4A5568]">${['Existing Platforms','Staged Rings','Access & Policy'][i]}</div>
                    <div id="flowConn${k}" class="mt-1 grid grid-cols-10 gap-1.5"></div>
                    <div class="mt-1 flow-bar w-full" style="background:linear-gradient(to right,#0070F3,#005AD0);--d:${3 + .5*i}s"></div>
                    <i data-lucide="check-circle" class="check-appear absolute top-1 right-1 w-4 h-4 text-var(--re-green)" style="--d:${4 + .5*i}s"></i>
                  </div>
                `).join('')}
                <div class="flow-connect absolute top-[-0.5rem] left-0 w-full"></div>
              </div>
              <div class="mt-3 grid grid-cols-3 gap-2 relative" aria-hidden="true">
                ${['A','B','C'].map((k,i)=>`
                  <div class="sub-card p-2 relative">
                    <div class="text-[12px] text-[#4A5568]">${['Business Unit','Subsidiary','Region'][i]}</div>
                    <div id="flowGrp${k}" class="mt-1 grid grid-cols-8 gap-1.5"></div>
                    <div class="mx-auto mt-1 bolt-line h-16 w-1" style="background:linear-gradient(to bottom,#0A1C60,#0070F3);--d:${5 + .5*i}s"></div>
                    <i data-lucide="shield-check" class="check-appear absolute top-1 right-1 w-4 h-4 text-var(--re-green)" style="--d:${6 + .5*i}s"></i>
                  </div>
                `).join('')}
                <div class="flow-connect absolute top-[-0.5rem] left-0 w-full"></div>
              </div>
              <div class="mt-3 grid grid-cols-3 gap-2 relative" aria-hidden="true">
                ${['A','B','C'].map((k,i)=>`
                  <div class="sub-card p-2 text-center relative">
                    <i data-lucide="${['monitor-smartphone','laptop','smartphone'][i]}" class="h-5 w-5 text-[#4A5568]"></i>
                    <div id="flowDev${k}" class="mt-1 grid grid-cols-6 gap-1.5"></div>
                    <div class="mt-1 text-[11px] text-[#4A5568]">${['Windows & macOS','VDI / Web','Mobile'][i]}</div>
                    <i data-lucide="check-circle" class="check-appear absolute top-1 right-1 w-4 h-4 text-var(--re-green)" style="--d:${8 + .5*i}s"></i>
                  </div>
                `).join('')}
                <div class="flow-connect absolute top-[-0.5rem] left-0 w-full"></div>
              </div>
              <div class="mt-3">
                <div id="endUserCard" class="sub-card p-3 transition-all duration-500">
                  <div class="flex items-center gap-3">
                    <div id="endUserAvatar" class="h-9 w-9 grid place-items-center font-semibold rounded-full" style="background:#EA4335">U</div>
                    <div class="text-sm">
                      <div class="font-medium">End user</div>
                      <div id="endUserMessage" class="text-[#4A5568]">Apps on demand — no waiting, no tickets.</div>
                    </div>
                  </div>
                  <div class="mt-3 user-beam" style="background:linear-gradient(to right,#0070F3,#005AD0);--d:10s"></div>
                  <div class="relative mt-2" style="border:1px solid var(--border-subtle);background:#F7F9FB;border-radius:var(--radius);padding:1rem">
                    <i data-lucide="laptop" class="h-5 w-5 text-[#4A5568]"></i>
                    <div id="endUserBadge" class="absolute right-2 top-2 badge grid place-items-center font-bold" style="--d:11s;background:#E11D48;color:#000">!</div>
                    <div class="mt-1 text-[11px] text-[#4A5568]">Workspace launches the correct app instantly</div>
                  </div>
                  <div id="miniWorkspace" class="mt-3 hidden grid grid-cols-4 gap-2">
                    ${miniApps.map(app => `<div class="logo-ring cursor-pointer" data-action="launch-icon">${app.svg}</div>`).join('')}
                  </div>
                </div>
                <div id="flowSuccess" class="mt-2 hidden inline-flex items-center gap-1 text-[13px] tagline-fade" style="color:#10B981"><i data-lucide="sparkles" class="h-4 w-4"></i><span>Configured once → delivered everywhere.</span></div>
              </div>
            </div>
          </div>
        `;
      }
      const miniApps = [
        logo('Microsoft Word','W','#185ABD'),
        logo('Microsoft Teams','T','#5B53D6'),
        logo('SAP','SAP','#0A6ED1'),
        logo('Zoom','Z','#0B5CFF')
      ];
      function renderROI(){
        const r = calcROI();
        return `
          <section id="panel-roi" class="space-y-8">
            <div class="section-card p-8 rounded-2xl shadow-md hover:shadow-lg transition-shadow duration-300 bg-white">
              <h3 class="text-2xl font-semibold mb-6 text-gray-900">Business Impact Calculator</h3>
              <div class="grid grid-cols-1 gap-6">
                <label class="flex flex-col gap-1">
                  <span class="text-base font-medium text-gray-900">How many applications does IT actively manage?</span>
                  <span class="text-sm text-gray-600">Includes all applications IT packages, updates, patches, or supports.</span>
                  <input type="number" id="calc-apps" min="10" max="5000" placeholder="250" value="${STATE.calcInputs.apps}" class="rounded border border-slate-200 bg-slate-50 px-3 py-2 text-sm focus-ring">
                </label>
                <label class="flex flex-col gap-1">
                  <span class="text-base font-medium text-gray-900">Across how many environments do those apps need to run?</span>
                  <span class="text-sm text-gray-600">Examples: Windows, macOS, VDI/AVD, Web.</span>
                  <input type="number" id="calc-envs" min="1" max="5" placeholder="3" value="${STATE.calcInputs.envs}" class="rounded border border-slate-200 bg-slate-50 px-3 py-2 text-sm focus-ring">
                </label>
                <label class="flex flex-col gap-1">
                  <span class="text-base font-medium text-gray-900">How many application changes occur per month?</span>
                  <span class="text-sm text-gray-600">Includes vendor updates, security patches, and internal changes.</span>
                  <input type="number" id="calc-changes" min="1" max="200" placeholder="20" value="${STATE.calcInputs.changes}" class="rounded border border-slate-200 bg-slate-50 px-3 py-2 text-sm focus-ring">
                </label>
              </div>
              <div class="mt-6">
                <button type="button" data-action="calculate-impact" class="bg-[#0070F3] text-white px-6 py-3 text-base font-semibold rounded-full hover:bg-[#005AD0] focus-ring">Calculate Impact</button>
              </div>
              <div id="calc-output" class="mt-8">
                ${STATE.calcResult ? renderCalcResult() : ''}
              </div>
            </div>
            <div class="flex justify-center">
              <button type="button" data-action="open-currentstate-editor" class="inline-flex items-center gap-2 bg-transparent text-gray-600 border-2 border-gray-300 px-5 py-3 text-base font-medium focus-ring rounded-full hover:text-[#0070F3] hover:border-[#0070F3]">
                <i data-lucide="edit-3" class="w-5 h-5"></i> Edit Current State
              </button>
            </div>
          </section>
        `;
      }
      function renderCalcResult(){
        if (!STATE.qualified) {
          return `
            <div class="p-4 rounded-lg bg-gray-50">
              <h4 class="text-lg font-medium mb-2 text-gray-900">Your environment appears relatively simple today</h4>
              <p class="text-base text-gray-700">Teams managing a small number of applications in a single environment
often operate without significant delivery strain.
As application count, delivery paths, or change frequency increases,
application delivery becomes harder to scale predictably.</p>
            </div>
          `;
        }
        return `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="p-4 rounded-lg bg-gray-50">
              <h4 class="text-lg font-medium mb-4 text-gray-900">Current State</h4>
              <ul class="space-y-2 text-base list-disc pl-5 text-gray-700">
                <li>Applications are packaged and delivered separately per environment.</li>
                <li>Each change requires rebuilds, retesting, and coordination.</li>
                <li>Operational work scales faster than available capacity.</li>
              </ul>
            </div>
            <div class="p-4 rounded-lg bg-gray-50">
              <h4 class="text-lg font-medium mb-4 text-gray-900">With Application Workspace</h4>
              <ul class="space-y-2 text-base list-disc pl-5 text-gray-700">
                <li>Applications are packaged once and delivered everywhere.</li>
                <li>Consistent behavior across platforms.</li>
                <li>Operational effort scales predictably.</li>
              </ul>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            ${kvCalc('Hours Returned per Month', num(Math.round(STATE.calcResult.hoursSavedMonthly)))}
            ${kvCalc('Hours Returned per Year', num(Math.round(STATE.calcResult.hoursSavedYearly)))}
            ${kvCalc('Delivery Efficiency Gain', '60%')}
            ${kvCalc('Support Load Reduction', '40%')}
          </div>
          <p class="mt-4 text-sm text-gray-600">Represents operational capacity returned to IT — not headcount reduction.</p>
        `;
      }
      function kvCalc(label, value){
        return `
          <div class="p-4 rounded-lg bg-gray-50 flex flex-col items-center justify-center">
            <span class="text-2xl font-bold text-gray-900 tabular-nums">${value}</span>
            <span class="text-base text-gray-700 text-center">${label}</span>
          </div>
        `;
      }
      function calcROI(){
        const i = STATE.roiInputs;
        const ticketsMonth = i.users * i.ticketsPerUserPerMonth;
        const reactiveHoursMonth = (STATE.impact.minutes * i.users) / 60;
        const packagingHoursMonth = STATE.impact.pkgHours;
        const patchHoursMonth = STATE.impact.riskHrs;
        const totalHoursMonth = reactiveHoursMonth + packagingHoursMonth + patchHoursMonth;
        const totalHoursYear = totalHoursMonth * 12;
        const ticketsAvoided = (STATE.impact.minutes * i.users) / i.avgHandleMins;
        const patchReductionPct = STATE.currentHrs > 0 ? Math.round((STATE.impact.riskHrs / STATE.currentHrs) * 100) : 0;
        return {
          i,
          ticketsMonth: round(ticketsMonth),
          reactiveHoursMonth: round(reactiveHoursMonth),
          packagingHoursMonth: round(packagingHoursMonth),
          patchHoursMonth: round(patchHoursMonth),
          totalHoursMonth,
          totalHoursYear,
          ticketsAvoided,
          patchReductionPct
        };
      }
      function updateROIOutputs(){
        // No need for outputs update beyond render
      }
      function setText(id, value){ const el=document.getElementById(id); if(el) el.textContent = String(value); }
      function kv(label,value){
        return `<div class="flex items-center justify-between rounded-[2px] bg-slate-100 px-3 py-2"><span class="text-[#4A5568]">${label}</span><span class="font-semibold tabular-nums">${value}</span></div>`;
      }
      function numInput(label,key,value){
        return `<label class="flex flex-col gap-1 text-sm"><span class="text-[12px] text-[#4A5568]">${label}</span><input class="rounded-[2px] border border-slate-200 bg-slate-50 px-3 py-1.5 text-sm focus-ring" inputmode="decimal" value="${value}" data-action="set-roi" data-key="${key}"></label>`;
      }
      const CATALOG=[
        {title:'CORE PRODUCTIVITY',id:'cat-core',items:[
          logo('Microsoft Word','W','#185ABD'),
          logo('Microsoft Excel','X','#107C41'),
          logo('PowerPoint','P','#D24726'),
          logo('Outlook','O','#106EBE'),
          logo('Microsoft Teams','T','#5B53D6'),
          logo('Google Docs','Dc','#1A73E8'),
          logo('Google Sheets','Sh','#1E8E3E'),
          logo('Google Slides','Sl','#F9AB00')
        ]},
        {title:'MESSAGING & MEETINGS',id:'cat-collab',items:[
          multiLogo('Slack',['#36C5F0','#2EB67D','#E01E5A','#ECB22E']),
          logo('Zoom','Z','#0B5CFF'),
          logo('Gmail','G','#EA4335'),
          logo('Google Meet','GM','#0F9D58')
        ]},
        {title:'WEB BROWSERS',id:'cat-browsers',items:[
          triLogo('Google Chrome','#EA4335','#FBBC05','#34A853','#4285F4'),
          ringLogo('Microsoft Edge','#0C8EC5','#0AA0A3'),
          flameLogo('Mozilla Firefox','#FF7139','#FFCC00')
        ]},
        {title:'ENTERPRISE APPS',id:'cat-enterprise',items:[
          logo('Salesforce','SF','#00A1E0'),
          logo('Workday','WD','#1F5BFF'),
          logo('ServiceNow','SN','#81B29A'),
          logo('SAP','SAP','#0A6ED1'),
          logo('Oracle NetSuite','NS','#C74634')
        ]},
        {title:'SECURITY & ACCESS',id:'cat-security',items:[
          logo('Duo','D','#3CB371'),
          logo('Okta','O','#007DC1'),
          logo('Ping Identity','P','#C0172C'),
          logo('Cisco AnyConnect','AC','#00B5AD'),
          logo('Microsoft Defender','MD','#0067B8'),
          logo('CrowdStrike Falcon','CS','#D61F26')
        ]},
        {title:'STORAGE & CREATIVE',id:'cat-storage',items:[
          logo('Adobe Acrobat','A','#ED2224'),
          logo('Dropbox','DB','#0061FF'),
          logo('Box','BX','#0061D5'),
          logo('OneDrive','OD','#0A5BD5'),
          logo('ZoomIt / Sysinternals','ZI','#58595B')
        ]}
      ];
      const ENV_SOURCES = [
        { name: 'SCCM', svg: '<i data-lucide="server-cog" class="w-5 h-5 text-[#0078D4]"></i>' },
        { name: 'Intune', svg: '<i data-lucide="cloud-cog" class="w-5 h-5 text-[#0078D4]"></i>' },
        { name: 'Citrix', svg: '<i data-lucide="layout-dashboard" class="w-5 h-5 text-[#000000]"></i>' },
        { name: 'AVD', svg: '<i data-lucide="monitor" class="w-5 h-5 text-[#0078D4]"></i>' },
        { name: 'Windows 365', svg: '<i data-lucide="cloud" class="w-5 h-5 text-[#0078D4]"></i>' },
        { name: 'Jamf', svg: '<i data-lucide="apple" class="w-5 h-5 text-[#000000]"></i>' }
      ];
      const appConfigs = [
        {stage:'Prod', policy:'MFA + VPN', region:'AMER', device:'Windows'},
        {stage:'QA', policy:'Compliant only', region:'APAC', device:'Any'},
        {stage:'Dev', policy:'MFA required', region:'EMEA', device:'Mac'},
        {stage:'Prod', policy:'VPN only', region:'Global', device:'Windows'},
        {stage:'QA', policy:'MFA required', region:'AMER', device:'Any'},
        {stage:'Dev', policy:'MFA required', region:'APAC', device:'Mac'},
        {stage:'Prod', policy:'Compliant only', region:'EMEA', device:'Windows'},
        {stage:'QA', policy:'VPN only', region:'Global', device:'Any'}
      ];
      let flatIndex = 0;
      CATALOG.forEach(sec => sec.items.forEach(itm => { itm.config = appConfigs[flatIndex % appConfigs.length]; flatIndex++; }));
      function logo(name,letter,color){ return { name, svg: mark(letter,color) }; }
      function mark(letter,color){
        return `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="24" height="24" role="img" aria-label="${letter}">
            <defs><linearGradient id="g${letter.replace(/\W/g,'')}" x1="0" x2="1"><stop offset="0" stop-color="${shade(color,.9)}"/><stop offset="1" stop-color="${shade(color,1.1)}"/></linearGradient></defs>
            <rect x="1.5" y="1.5" width="45" height="45" rx="12" fill="url(#g${letter.replace(/\W/g,'')})" stroke="rgba(0,0,0,.15)"/>
          <text x="50%" y="56%" text-anchor="middle" font-size="22" font-family="Inter,Segoe UI,Arial" font-weight="800" fill="#0A1C60">${letter}</text>
          </svg>`;
      }
      function multiLogo(name,colors){
        const slices=colors.map((c,i)=>`<rect x="${4+i*9}" y="8" width="7" height="32" rx="4" fill="${c}"></rect>`).join('');
        return { name, svg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="24" height="24" role="img" aria-label="${name}"><rect x="1.5" y="1.5" width="45" height="45" rx="12" fill="#F7F9FB" stroke="rgba(0,0,0,.15)"/>${slices}</svg>` };
      }
      function triLogo(name,r1,r2,r3,r4){
        return { name, svg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="24" height="24" aria-label="${name}"><rect x="1.5" y="1.5" width="45" height="45" rx="12" fill="#F7F9FB" stroke="rgba(0,0,0,.15)"/><circle cx="24" cy="24" r="12" fill="${r4}"/><path d="M24 12 A12 12 0 0 1 36 24 L24 24 Z" fill="${r1}"/><path d="M36 24 A12 12 0 0 1 24 36 L24 24 Z" fill="${r2}"/><path d="M24 36 A12 12 0 0 1 24 12 L24 24 Z" fill="${r3}"/></svg>` };
      }
      function ringLogo(name,c1,c2){
        return { name, svg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="24" height="24" aria-label="${name}"><rect x="1.5" y="1.5" width="45" height="45" rx="12" fill="#F7F9FB" stroke="rgba(0,0,0,.15)"/><circle cx="24" cy="24" r="11" fill="${c1}"/><circle cx="20" cy="20" r="8" fill="${c2}"/></svg>` };
      }
      function flameLogo(name,c1,c2){
        return { name, svg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="24" height="24" aria-label="${name}"><rect x="1.5" y="1.5" width="45" height="45" rx="12" fill="#F7F9FB" stroke="rgba(0,0,0,.15)"/><path d="M24 12c5 7-2 9 3 14 3 3 2 9-3 11-5-2-6-8-3-11 5-5-3-7 3-14z" fill="${c1}"/><circle cx="26" cy="28" r="4" fill="${c2}"/></svg>` };
      }
      function shade(hex,m){ const c=hex.replace('#',''); const n=[0,1,2].map(i=>parseInt(c.slice(i*2,i*2+2),16)); const s=n.map(v=>Math.max(0,Math.min(255,Math.round(v*m)))); return '#'+s.map(v=>v.toString(16).padStart(2,'0')).join(''); }
      /* ---------- Per-user cached Current State (IDs + storage) ---------- */
      const USER_ID = String(window.APP_USER_ID || "guest");
      const PAGE_SCOPE = location.origin + location.pathname + location.search;
      const STORAGE_KEY = `currentState:${USER_ID}:${PAGE_SCOPE}`;
      let DEFAULT_CURRENT_STATE = null;
      const $ = (sel, ctx = document) => ctx.querySelector(sel);
      const fields = {
        changeIntro: () => $('#changeIntro'),
        changeBullets: () => $('#changeBullets'),
        changeAnalyst: () => $('#changeAnalyst'),
        nowIntro: () => $('#nowIntro'),
        nowBullets: () => $('#nowBullets'),
        nowAnalyst: () => $('#nowAnalyst'),
        recastIntro: () => $('#recastIntro'),
        recastBullets: () => $('#recastBullets'),
        recastAnalyst: () => $('#recastAnalyst')
      };
      function captureDefaultsOnce(){
        if (DEFAULT_CURRENT_STATE) return;
        DEFAULT_CURRENT_STATE = STATE.defaultsCurrentState();
      }
      function readFields(){
        return {
          change: {
            intro: fields.changeIntro()?.value ?? "",
            bullets: fields.changeBullets()?.value ?? "",
            analyst: fields.changeAnalyst()?.value ?? ""
          },
          now: {
            intro: fields.nowIntro()?.value ?? "",
            bullets: fields.nowBullets()?.value ?? "",
            analyst: fields.nowAnalyst()?.value ?? ""
          },
          recast: {
            intro: fields.recastIntro()?.value ?? "",
            bullets: fields.recastBullets()?.value ?? "",
            analyst: fields.recastAnalyst()?.value ?? ""
          }
        };
      }
      function readChartFieldsRaw(){
        return {
          chartConfig: {
            yAxis: $('#chart-yaxis')?.value ?? "",
            xAxis: $('#chart-xaxis')?.value ?? "",
            center: $('#chart-center')?.value ?? "",
            footer: $('#chart-footer')?.value ?? "",
            tipping: $('#chart-tipping')?.value ?? ""
          },
          drivers: STATE.drivers.map((_,i) => ({
            label: $(`#driver${i}-label`)?.value ?? "",
            bullets: $(`#driver${i}-bullets`)?.value ?? ""
          }))
        };
      }
      function writeFields(data){
        if(!data) return;
        if(fields.changeIntro()) fields.changeIntro().value = data.change.intro ?? "";
        if(fields.changeBullets()) fields.changeBullets().value = data.change.bullets ?? "";
        if(fields.changeAnalyst()) fields.changeAnalyst().value = data.change.analyst ?? "";
        if(fields.nowIntro()) fields.nowIntro().value = data.now.intro ?? "";
        if(fields.nowBullets()) fields.nowBullets().value = data.now.bullets ?? "";
        if(fields.nowAnalyst()) fields.nowAnalyst().value = data.now.analyst ?? "";
        if(fields.recastIntro()) fields.recastIntro().value = data.recast.intro ?? "";
        if(fields.recastBullets()) fields.recastBullets().value = data.recast.bullets ?? "";
        if(fields.recastAnalyst()) fields.recastAnalyst().value = data.recast.analyst ?? "";
      }
      function writeChartFields(config, drivers){
        if($('#chart-yaxis')) $('#chart-yaxis').value = config?.yAxis ?? "";
        if($('#chart-xaxis')) $('#chart-xaxis').value = config?.xAxis ?? "";
        if($('#chart-center')) $('#chart-center').value = config?.center ?? "";
        if($('#chart-footer')) $('#chart-footer').value = config?.footer ?? "";
        if($('#chart-tipping')) $('#chart-tipping').value = config?.tipping ?? "";
        drivers?.forEach((dd, i) => {
          const labelEl = $(`#driver${i}-label`);
          const bulletsEl = $(`#driver${i}-bullets`);
          if(labelEl) labelEl.value = dd.label ?? "";
          if(bulletsEl) bulletsEl.value = dd.bullets ?? "";
        });
      }
      function loadDraft(){
        try{
          const raw = localStorage.getItem(STORAGE_KEY);
          return raw ? JSON.parse(raw) : null;
        }catch{return null;}
      }
      function saveDraft(payload){
        try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(payload)); }
        catch(e){ console.warn('Save failed (storage blocked or full):', e); }
      }
      function clearDraft(){
        try{ localStorage.removeItem(STORAGE_KEY); }catch{}
      }
      function initCurrentStateModal(){
        captureDefaultsOnce();
        const draft = loadDraft();
        if(draft) {
          writeFields(draft);
          writeChartFields(draft.chartConfig, draft.drivers);
        } else {
          writeChartFields(STATE.chartConfig, STATE.drivers.map(d => ({label: d.label, bullets: d.bullets.join('\n')})));
        }
        const saveBtn = $('#btnSaveCurrentState');
        const resetBtn = $('#btnResetCurrentState');
        if (saveBtn && !saveBtn.dataset.wired){
          saveBtn.dataset.wired = "1";
          saveBtn.addEventListener('click', (e)=>{
            e.preventDefault();
            const formData = readFields();
            const chartDataRaw = readChartFieldsRaw();
            const payload = { ...formData, chartConfig: chartDataRaw.chartConfig, drivers: chartDataRaw.drivers };
            saveDraft(payload);
          });
        }
        if (resetBtn && !resetBtn.dataset.wired){
          resetBtn.dataset.wired = "1";
          resetBtn.addEventListener('click', (e)=>{
            e.preventDefault();
            clearDraft();
            writeFields(DEFAULT_CURRENT_STATE);
            STATE.chartConfig = STATE.defaultsChartConfig();
            STATE.drivers = STATE.defaultsDrivers();
            writeChartFields(STATE.chartConfig, STATE.drivers.map(d => ({label: d.label, bullets: d.bullets.join('\n')})));
            STATE.currentState = STATE.defaultsCurrentState();
            render();
          });
        }
      }
      /* ------------------------------------------------------------------- */
      function renderModal(){
        if(!STATE.modalOpen) return '';
        const buf = STATE.editBuffers;
        const toLines = arr => arr.join('\n');
        const ensure = v => v ?? '';
        const editTabs = [
          {id: 'change', label: 'Why Change'},
          {id: 'now', label: 'Why Now'},
          {id: 'recast', label: 'Why Recast'},
          {id: 'chart', label: 'Chart Config'}
        ];
        return `
          <div role="dialog" aria-modal="true" aria-labelledby="cs-editor-title" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 overflow-auto p-4 md:p-8">
            <div class="w-[95vw] h-[95vh] bg-white rounded-2xl shadow-2xl p-8 overflow-y-auto">
              <div class="flex items-center justify-between">
                <h2 id="cs-editor-title" class="text-xl font-semibold tracking-normal">Edit Current State</h2>
                <button type="button" class="bg-transparent text-[#0A1C60] p-2 focus-ring rounded" data-action="close-modal" aria-label="Close">
                  <i data-lucide="x" class="w-4 h-4"></i>
                </button>
              </div>
              <p class="mt-1 text-sm text-[#4A5568]">Edit the introduction, bullets (one per line, max 4), and analyst trend for each section.</p>
              <div role="tablist" aria-label="Edit sections" class="flex w-full flex-wrap gap-2 rounded bg-slate-50 p-1 ring-1 ring-slate-200 mt-4">
                ${editTabs.map(t=>`
                  <button type="button" class="${cx('inline-flex items-center gap-2 px-3.5 py-1.5 text-sm focus-ring transition', STATE.editTab===t.id ? 'bg-[#0070F3] text-white hover:bg-[#005AD0] rounded' : 'text-[#0A1C60] hover:bg-slate-100 rounded')}" data-action="switch-edit-tab" data-tab="${t.id}" aria-selected="${STATE.editTab===t.id}">
                    <span>${t.label}</span>
                  </button>
                `).join('')}
              </div>
              <div class="mt-4">
                ${STATE.editTab === 'change' ? editorSection('change','Why Change', ensure(buf.change.intro) || STATE.currentState.change.intro, ensure(buf.change.bullets) || toLines(STATE.currentState.change.bullets), ensure(buf.change.analyst) || STATE.currentState.change.analyst) : ''}
                ${STATE.editTab === 'now' ? editorSection('now','Why Now', ensure(buf.now.intro) || STATE.currentState.now.intro, ensure(buf.now.bullets) || toLines(STATE.currentState.now.bullets), ensure(buf.now.analyst) || STATE.currentState.now.analyst) : ''}
                ${STATE.editTab === 'recast' ? editorSection('recast','Why Recast', ensure(buf.recast.intro) || STATE.currentState.recast.intro, ensure(buf.recast.bullets) || toLines(STATE.currentState.recast.bullets), ensure(buf.recast.analyst) || STATE.currentState.recast.analyst) : ''}
                ${STATE.editTab === 'chart' ? editorSectionChart() : ''}
              </div>
              <div class="mt-5 flex flex-wrap gap-2">
                <button id="btnSaveCurrentState" type="button" data-action="save-currentstate" class="inline-flex items-center gap-2 bg-[#0070F3] text-white px-4 py-2 text-sm font-semibold focus-ring rounded hover:bg-[#005AD0]">
                  <i data-lucide="save" class="w-4 h-4"></i> Save
                </button>
                <button id="btnResetCurrentState" type="button" data-action="reset-currentstate-defaults" class="inline-flex items-center gap-2 bg-transparent text-[#0A1C60] border-2 border-[#0A1C60] px-4 py-2 text-sm font-semibold focus-ring rounded hover:text-[#0070F3] hover:border-[#0070F3]">
                  <i data-lucide="rotate-ccw" class="w-4 h-4"></i> Reset to default
                </button>
              </div>
            </div>
          </div>
        `;
      }
      function editorSectionChart(){
        return `
          <div class="flex flex-col gap-4">
            <span class="text-sm font-semibold">XY Chart</span>
            <label class="flex flex-col gap-1">
              <span class="text-xs text-[#4A5568]">Y-axis label</span>
              <input id="chart-yaxis" value="${STATE.chartConfig.yAxis}" class="rounded border border-slate-200 bg-white p-3 text-sm focus-ring" />
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-xs text-[#4A5568]">X-axis label</span>
              <input id="chart-xaxis" value="${STATE.chartConfig.xAxis}" class="rounded border border-slate-200 bg-white p-3 text-sm focus-ring" />
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-xs text-[#4A5568]">Center text</span>
              <input id="chart-center" value="${STATE.chartConfig.center}" class="rounded border border-slate-200 bg-white p-3 text-sm focus-ring" />
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-xs text-[#4A5568]">Footer caption</span>
              <input id="chart-footer" value="${STATE.chartConfig.footer}" class="rounded border border-slate-200 bg-white p-3 text-sm focus-ring" />
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-xs text-[#4A5568]">Operational breaking point annotation</span>
              <input id="chart-tipping" value="${STATE.chartConfig.tipping}" class="rounded border border-slate-200 bg-white p-3 text-sm focus-ring" />
            </label>
            <div class="space-y-4">
              ${STATE.drivers.map((d, i) => `
                <div>
                  <label class="flex flex-col gap-1">
                    <span class="text-xs text-[#4A5568]">Point ${i+1} title</span>
                    <input id="driver${i}-label" value="${d.label}" class="rounded border border-slate-200 bg-white p-3 text-sm focus-ring" />
                  </label>
                  <label class="flex flex-col gap-1 mt-2">
                    <span class="text-xs text-[#4A5568]">Point ${i+1} bullets (one per line, exactly 3)</span>
                    <textarea id="driver${i}-bullets" rows="4" class="min-h-[100px] rounded border border-slate-200 bg-white p-3 text-sm leading-5 focus-ring">${d.bullets.join('\n')}</textarea>
                  </label>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }
      function editorSection(key,label,introValue,bulletsValue,analystValue){
        return `
          <div class="flex flex-col gap-4">
            <span class="text-sm font-semibold">${label}</span>
            <label class="flex flex-col gap-1">
              <span class="text-xs text-[#4A5568]">Introduction</span>
              <textarea id="${key}Intro" data-action="edit-buffer" data-key="${key}" data-subkey="intro" class="min-h-[80px] rounded-[2px] border border-slate-200 bg-white p-3 text-sm leading-5 focus-ring" aria-label="${label} introduction editor" rows="2">${introValue}</textarea>
            </label>
            <label class="flex flex-col gap-1">
              <div class="flex items-center gap-2 text-xs text-[#4A5568]">
                <i data-lucide="check-circle" class="w-4 h-4 text-[#0070F3]"></i>
                Bullets (one per line, max 4)
              </div>
              <textarea id="${key}Bullets" data-action="edit-buffer" data-key="${key}" data-subkey="bullets" class="min-h-[160px] rounded-[2px] border border-slate-200 bg-white p-3 text-sm leading-5 focus-ring" aria-label="${label} bullets editor" rows="6">${bulletsValue}</textarea>
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-xs text-[#4A5568]">Analyst Trend</span>
              <textarea id="${key}Analyst" data-action="edit-buffer" data-key="${key}" data-subkey="analyst" class="min-h-[80px] rounded-[2px] border border-slate-200 bg-white p-3 text-sm leading-5 focus-ring" aria-label="${label} analyst editor" rows="2">${analystValue}</textarea>
            </label>
          </div>
        `;
      }
      function attachEvents(){
        const root=document.getElementById('app');
        root.addEventListener('input', e => {
          const act = e.target.closest('[data-action="set-slider"]');
          if (act) {
            const id = act.getAttribute('data-id');
            const value = parseInt(act.value);
            setSlider(id, value);
          }
          const calcApps = document.getElementById('calc-apps');
          if (calcApps && e.target === calcApps) STATE.calcInputs.apps = cleanNum(e.target.value);
          const calcEnvs = document.getElementById('calc-envs');
          if (calcEnvs && e.target === calcEnvs) STATE.calcInputs.envs = cleanNum(e.target.value);
          const calcChanges = document.getElementById('calc-changes');
          if (calcChanges && e.target === calcChanges) STATE.calcInputs.changes = cleanNum(e.target.value);
        });
        root.addEventListener('click', e => {
          const act = e.target.closest('[data-action]');
          if (act) {
            const action = act.getAttribute('data-action');
            if (action === 'switch-edit-tab') {
              STATE.editTab = act.getAttribute('data-tab');
              render();
              return;
            }
            if (action === 'reset-sliders') {
              resetSliders();
            }
            if (action === 'close-insight-modal') {
              STATE.insightContent = null;
              render();
            }
            if (action === 'why-nav') {
              const to = act.getAttribute('data-to');
              STATE.openWhyModal = to;
              render();
              return;
            }
            if (action === 'calculate-impact') {
              calculateImpact();
              render();
              return;
            }
          }
          const node = e.target.closest('.interactive-node');
          if (node) {
            const id = node.dataset.id;
            STATE.activePopover = STATE.activePopover === id ? null : id;
            render();
            return;
          }
          if (STATE.activeTab === 'problems' && STATE.activePopover && !e.target.closest('.popover')) {
            STATE.activePopover = null;
            render();
          }
        });
        root.querySelectorAll('[data-action="switch-tab"]').forEach(b=>b.addEventListener('click',e=>{
          STATE.activeTab=e.currentTarget.getAttribute('data-tab');
          STATE.visitedCards = [];
          STATE.activePopover = null;
          STATE.calcResult = null;
          render();
        }));
        root.querySelectorAll('[data-action="advance"]').forEach(b=>b.addEventListener('click',e=>{
          STATE.activeTab=e.currentTarget.getAttribute('data-next');
          STATE.openWhyModal = null;
          render();
        }));
        root.querySelectorAll('[data-action="open-why-modal"]').forEach(b=>b.addEventListener('click',e=>{
          const id=e.currentTarget.getAttribute('data-why');
          if (id === 'change') {
            STATE.drivers.forEach(d => {
              if (['more_apps', 'constant_updates', 'too_many_tools', 'manual_rework'].includes(d.id)) d.state = 'normal';
            });
          } else if (id === 'now') {
            STATE.drivers.forEach(d => {
              if (['more_apps', 'constant_updates', 'too_many_tools', 'manual_rework', 'security_compliance'].includes(d.id)) d.state = 'accelerating';
            });
            STATE.showTippingPoint = true;
          } else if (id === 'recast') {
            // Lock sliders, show absorption, narrow gap - but since no absorption line in spec, perhaps adjust exponents
            STATE.targetDemandExponent -= 0.5; // Simulate narrowing
          }
          updateCurves();
          requestAnimationFrame(animateCurves);
          STATE.openWhyModal = id;
          render();
        }));
        root.querySelectorAll('[data-action="close-why-modal"]').forEach(b=>b.addEventListener('click',()=>{
          STATE.openWhyModal = null;
          STATE.activePopover = null;
          render();
        }));
        root.querySelectorAll('[data-action="toggle-card"]').forEach(b=>b.addEventListener('click',e=>{
          const id=e.currentTarget.getAttribute('data-card');
          const wasOpen = STATE.openCards[id];
          Object.keys(STATE.openCards).forEach(k => STATE.openCards[k] = false);
          STATE.openCards[id] = !wasOpen;
          if (STATE.openCards[id] && !STATE.visitedCards.includes(id)) {
            STATE.visitedCards.push(id);
          }
          render();
          if (STATE.openCards[id]) {
            setTimeout(() => {
              e.currentTarget.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 200);
          }
        }));
        root.querySelectorAll('[data-action="expand-all"]').forEach(b=>b.addEventListener('click',()=>{
          Object.keys(STATE.openCards).forEach(k => STATE.openCards[k] = true);
          STATE.visitedCards = ['core', 'onboarding', 'trust'];
          render();
        }));
        root.querySelectorAll('[data-action="toggle-bucket"]').forEach(b=>b.addEventListener('click',e=>{
          const id=e.currentTarget.getAttribute('data-bucket');
          STATE.openBuckets[id] = !STATE.openBuckets[id];
          render();
        }));
        root.querySelectorAll('[data-action="set-device"]').forEach(b=>b.addEventListener('click',e=>{ STATE.ctx.device=e.currentTarget.getAttribute('data-value'); render(); }));
        root.querySelectorAll('[data-action="set-network"]').forEach(b=>b.addEventListener('click',e=>{ STATE.ctx.network=e.currentTarget.getAttribute('data-value'); render(); }));
        root.querySelectorAll('[data-action="toggle-compliance"]').forEach(b=>b.addEventListener('click',()=>{ STATE.ctx.compliant=!STATE.ctx.compliant; render(); }));
        const pack=root.querySelector('[data-action="set-pack-hrs"]'); if(pack) pack.addEventListener('input',e=>{ STATE.packHrs=cleanNum(e.target.value); render(); });
        const cfg=root.querySelector('[data-action="set-config-hrs"]'); if(cfg) cfg.addEventListener('input',e=>{ STATE.configHrs=cleanNum(e.target.value); render(); });
        const cur=root.querySelector('[data-action="set-current-hrs"]'); if(cur) cur.addEventListener('input',e=>{ STATE.currentHrs=cleanNum(e.target.value); render(); });
        root.querySelectorAll('[data-action="add-impact"]').forEach(b=>b.addEventListener('click',e=>{
          const kind=e.currentTarget.getAttribute('data-kind'); const val=Number(e.currentTarget.getAttribute('data-value'))||0;
          if (kind==='minutes') STATE.impact.minutes+=val;
          if (kind==='pkgHours') STATE.impact.pkgHours+=val;
          if (kind==='riskHrs') STATE.impact.riskHrs+=val;
          updateROIOutputs();
          render();
        }));
        root.querySelectorAll('[data-action="set-roi"]').forEach(inp=>inp.addEventListener('input',e=>{
          const key=e.currentTarget.getAttribute('data-key');
          const v=Number(String(e.target.value).replace(/[^0-9.\-]/g,''));
          STATE.roiInputs[key]=isFinite(v)?v:0;
          render();
        }));
        const resetCalc=root.querySelector('[data-action="reset-calculator"]');
        if(resetCalc) resetCalc.addEventListener('click', ()=>{
          STATE.roiInputs = { users: 5000, ticketsPerUserPerMonth: 0.035, avgHandleMins: 18 };
          STATE.impact = { ...STATE.defaults.impact };
          STATE.copied = false;
          render();
        });
        const copyBtn=root.querySelector('[data-action="copy-onepager"]');
        if(copyBtn) copyBtn.addEventListener('click', async ()=>{
          const r = calcROI();
          const body =
 `Recast Application Workspace — Capacity Dashboard
 Assumptions
  - Users: ${r.i.users}
  - Tickets per user / month: ${r.i.ticketsPerUserPerMonth}
  - Avg handle: ${r.i.avgHandleMins} mins
 Observed impact
  - Minutes saved per user (monthly): ${STATE.impact.minutes}
  - Packaging hours avoided: ${STATE.impact.pkgHours}
  - Zero-day hours avoided: ${STATE.impact.riskHrs}
 Outcomes
  - Hours Returned / Month: ${round(r.totalHoursMonth)}
  - Hours Returned / Year: ${round(r.totalHoursYear)}
  - Packaging Work Reduced / Month: ${round(r.packagingHoursMonth)}
  - Zero-Day Patch Time Reduced / Month: ${round(r.patchHoursMonth)}
  - App-Related Reactive Work Reduced / Month: ${round(r.reactiveHoursMonth)}
  - Tickets Avoided (est.): ${round(r.ticketsAvoided)} / month
  - Faster Patch Window: ${STATE.currentHrs} to 1.5 hrs (${r.patchReductionPct}% reduction)
  - App Version Reduction (estimated): 30-50% fewer active versions
 Notes: Illustrative; replace with your data.`;
          try { await navigator.clipboard.writeText(body); } catch {
            const ta=document.createElement('textarea'); ta.value=body; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
          }
          STATE.copied = true; render(); setTimeout(()=>{ STATE.copied = false; render(); }, 1200);
        });
        const startBtn=root.querySelector('[data-action="start-flow"]'); if(startBtn) startBtn.addEventListener('click', startFlow);
        const resetBtn=root.querySelector('[data-action="reset-flow"]'); if(resetBtn) resetBtn.addEventListener('click', resetFlow);
        const toggleLabels=root.querySelector('[data-action="toggle-labels"]'); if(toggleLabels) toggleLabels.addEventListener('click', ()=>{ STATE.showLabels=!STATE.showLabels; toggleOverlay(); buildFlow(); });
        root.querySelectorAll('[data-action="launch-icon"]').forEach(icon=>icon.addEventListener('click', ()=>{ icon.classList.add('icon-launch'); setTimeout(()=>icon.classList.remove('icon-launch'), 500); }));
        const openEditor=root.querySelector('[data-action="open-currentstate-editor"]');
        if(openEditor) openEditor.addEventListener('click', ()=>{
          STATE.modalOpen = true;
          STATE.editTab = 'change';
          STATE.editBuffers = { change: { intro: '', bullets: '', analyst: '' }, now: { intro: '', bullets: '', analyst: '' }, recast: { intro: '', bullets: '', analyst: '' } };
          render();
          setTimeout(()=>{ try { window.lucide.createIcons(); } catch{} }, 0);
          setTimeout(()=>{ initCurrentStateModal(); }, 0);
        });
      }
      function toggleOverlay(){
        const overlay = document.getElementById('overlayTag');
        if(STATE.showLabels){
          overlay.classList.remove('hidden');
          setTimeout(()=>{ overlay.classList.add('hidden'); },3000);
        }
      }
      function buildFlow(){
        let base=0;
        CATALOG.forEach(section=>{
          const mount=document.getElementById(section.id); if(!mount) return;
          mount.innerHTML='';
          section.items.forEach((itm,idx)=>{
            const wrap=document.createElement('div'); wrap.className='logo-wrap'; wrap.style.setProperty('--d',(base+idx*0.2 + 4).toFixed(2)+'s'); // Delay catalog by 4s
            const ring=document.createElement('div'); ring.className='logo-ring'; ring.innerHTML=itm.svg; ring.title=itm.name; ring.setAttribute('role','img'); ring.setAttribute('aria-label',itm.name);
            wrap.appendChild(ring);
            if(STATE.showLabels){
              const label=document.createElement('span'); label.className='logo-name'; label.textContent=itm.name; wrap.appendChild(label);
              const meta=document.createElement('div'); meta.className='meta-label';
              meta.innerHTML = `<span>Stage: ${itm.config.stage}</span><span>Policy: ${itm.config.policy}</span><span>Region: ${itm.config.region}</span><span>Device: ${itm.config.device}</span>`;
              wrap.appendChild(meta);
            }
            mount.appendChild(wrap);
          });
          base+=1.5;
        });
        buildTiles(document.getElementById('flowConnA'), 14, 7); // Delay existing by 4s
        buildTiles(document.getElementById('flowConnB'), 14, 7.5);
        buildTiles(document.getElementById('flowConnC'), 14, 8);
        buildTiles(document.getElementById('flowGrpA'), 18, 9);
        buildTiles(document.getElementById('flowGrpB'), 18, 9.5);
        buildTiles(document.getElementById('flowGrpC'), 18, 10);
        buildTiles(document.getElementById('flowDevA'), 10, 12);
        buildTiles(document.getElementById('flowDevB'), 10, 12.5);
        buildTiles(document.getElementById('flowDevC'), 10, 13);
        const avatar=document.getElementById('endUserAvatar');
        const badge=document.getElementById('endUserBadge');
        if(avatar){ avatar.style.background='#EA4335'; avatar.textContent='U'; }
        if(badge){ badge.textContent='!'; badge.style.background='#E11D48'; }
        const message = document.getElementById('endUserMessage');
        if(message) message.textContent = 'Apps on demand — no waiting, no tickets.';
        const mini = document.getElementById('miniWorkspace');
        if(mini) mini.classList.add('hidden');
        const counters = document.getElementById('progressCounters');
        if(counters) counters.classList.add('hidden');
        const card = document.getElementById('flowCard');
        if(card) card.classList.remove('run');
        const envCard = document.getElementById('envFlow');
        if(envCard) envCard.classList.remove('run');
        if(STATE.showLabels) { card.classList.add('show-labels'); envCard.classList.add('show-labels'); }
        else { card.classList.remove('show-labels'); envCard.classList.remove('show-labels'); }
        const endCard = document.getElementById('endUserCard');
        if(endCard) endCard.classList.remove('end-user-expand');
        STATE.progress = { apps: 0, time: 0, tickets: 0 };
        STATE.envProgress = { appsProcessed: 0 };
        updateProgress();
        updateEnvProgress();
        const success=document.getElementById('flowSuccess'); if(success) success.classList.add('hidden');
      }
      function buildTiles(container,count,baseDelay){
        if(!container) return; container.innerHTML='';
        for(let i=0;i<count;i++){ const d=document.createElement('div'); d.className='tile'; d.style.setProperty('--d',(baseDelay+i*0.1).toFixed(2)+'s'); container.appendChild(d); }
      }
      function startFlow(){
        const envCard=document.getElementById('envFlow'); if(!envCard) return;
        const card=document.getElementById('flowCard'); if(!card) return;
        envCard.classList.remove('run'); card.classList.remove('run'); void envCard.offsetWidth; void card.offsetWidth;
        envCard.classList.add('run'); card.classList.add('run');
        const flash=document.getElementById('flowHubFlash'); const success=document.getElementById('flowSuccess');
        const avatar=document.getElementById('endUserAvatar'); const badge=document.getElementById('endUserBadge');
        const message = document.getElementById('endUserMessage'); const mini = document.getElementById('miniWorkspace');
        const counters = document.getElementById('progressCounters'); const endCard = document.getElementById('endUserCard');
        if(flash){ flash.classList.remove('hidden'); setTimeout(()=>flash.classList.add('hidden'),2000); }
        if(success) success.classList.add('hidden');
        if(counters) counters.classList.remove('hidden');
        let envInterval = setInterval(updateEnvProgress, 50);
        setTimeout(() => {
          clearInterval(envInterval);
          let interval = setInterval(updateProgress, 100);
          setTimeout(()=>{
            if(avatar){ avatar.style.background= 'var(--re-green)'; }
            if(badge){ badge.textContent='✓'; badge.style.background= 'var(--re-green)'; }
            if(message) message.textContent = 'Apps on demand — no waiting, no tickets. Workspace launches the correct app instantly.';
            if(mini) mini.classList.remove('hidden');
            if(endCard) endCard.classList.add('end-user-expand');
            if(success) success.classList.remove('hidden');
            clearInterval(interval);
          }, 7000); // Adjusted for env flow (4s env + 7s catalog)
        }, 4000); // Env flow duration 4s
        setTimeout(()=> { envCard.classList.remove('run'); card.classList.remove('run'); }, 16000);
      }
      function updateProgress(){
        if(STATE.progress.apps < 128) STATE.progress.apps += 4;
        if(STATE.progress.time < 46) STATE.progress.time += 2;
        if(STATE.progress.tickets < 73) STATE.progress.tickets += 3;
        setText('appsProcessed', STATE.progress.apps > 128 ? 128 : STATE.progress.apps);
        setText('timeSaved', STATE.progress.time > 46 ? 46 : STATE.progress.time);
        setText('ticketsAvoided', STATE.progress.tickets > 73 ? 73 : STATE.progress.tickets);
      }
      function updateEnvProgress(){
        if(STATE.envProgress.appsProcessed < 8000) STATE.envProgress.appsProcessed += 200;
        setText('appsProcessedCounter', STATE.envProgress.appsProcessed > 8000 ? '8,000' : STATE.envProgress.appsProcessed);
      }
      function resetFlow(){
        STATE.progress = { apps: 0, time: 0, tickets: 0 };
        STATE.envProgress = { appsProcessed: 0 };
        STATE.showLabels = false;
        buildFlow();
      }
      function calculateImpact(){
        const apps = STATE.calcInputs.apps;
        const envs = STATE.calcInputs.envs;
        const changes = STATE.calcInputs.changes;
        STATE.qualified = apps >= 50 && envs >= 2 && changes >= 10;
        if (STATE.qualified) {
          const currentMonthlyHours = (apps * envs * changes * 0.75) + (changes * 0.25);
          const workspaceMonthlyHours = currentMonthlyHours * 0.4;
          const hoursSavedMonthly = currentMonthlyHours - workspaceMonthlyHours;
          const hoursSavedYearly = hoursSavedMonthly * 12;
          STATE.calcResult = {
            hoursSavedMonthly,
            hoursSavedYearly
          };
        } else {
          STATE.calcResult = null;
        }
      }
      function attachAccordionKeyboard(){
        document.addEventListener('keydown', (e) => {
          const target = e.target;
          if (!target.classList.contains('accordion-header')) return;
          const headers = Array.from(document.querySelectorAll('.accordion-header'));
          const idx = headers.indexOf(target);
          if (e.key === 'ArrowDown') {
            const nextIdx = (idx + 1) % headers.length;
            headers[nextIdx].focus();
            e.preventDefault();
          } else if (e.key === 'ArrowUp') {
            const prevIdx = (idx - 1 + headers.length) % headers.length;
            headers[prevIdx].focus();
            e.preventDefault();
          } else if (e.key === 'Home') {
            headers[0].focus();
            e.preventDefault();
          } else if (e.key === 'End') {
            headers[headers.length - 1].focus();
            e.preventDefault();
          } else if (e.key === 'Enter' || e.key === ' ') {
            target.click();
            e.preventDefault();
          }
        });
      }
      function parseLines(s, max=4){
        return (s || '').split('\n').map(l => l.trim()).filter(Boolean).slice(0, max);
      }
      STATE.drivers.forEach(d => d.state = 'accelerating');
      STATE.showTippingPoint = true;
      updateCurves();
      STATE.currentDemandExponent = STATE.targetDemandExponent;
      STATE.currentCapacitySlope = STATE.targetCapacitySlope;
      STATE.tippingPointYear = 2027.5;
      document.addEventListener('DOMContentLoaded', render);
      document.addEventListener('click', (e)=>{
        const act = e.target.closest('[data-action]');
        if(!act) return;
        const action = act.getAttribute('data-action');
        if(action==='close-modal'){
          STATE.modalOpen=false; render();
        }
        if(action==='edit-buffer'){
          const key = act.getAttribute('data-key');
          const subkey = act.getAttribute('data-subkey');
          act.addEventListener('input', (evt)=>{ STATE.editBuffers[key][subkey] = evt.target.value; });
        }
        if(action==='save-currentstate'){
          const fallback = STATE.defaultsCurrentState();
          const formData = readFields();
          STATE.currentState = {
            change: {
              intro: formData.change.intro.trim() || fallback.change.intro,
              bullets: parseLines(formData.change.bullets) || fallback.change.bullets,
              analyst: formData.change.analyst.trim() || fallback.change.analyst
            },
            now: {
              intro: formData.now.intro.trim() || fallback.now.intro,
              bullets: parseLines(formData.now.bullets) || fallback.now.bullets,
              analyst: formData.now.analyst.trim() || fallback.now.analyst
            },
            recast: {
              intro: formData.recast.intro.trim() || fallback.recast.intro,
              bullets: parseLines(formData.recast.bullets) || fallback.recast.bullets,
              analyst: formData.recast.analyst.trim() || fallback.recast.analyst
            }
          };
          const chartDataRaw = readChartFieldsRaw();
          const fallbackChart = STATE.defaultsChartConfig();
          STATE.chartConfig = {
            yAxis: chartDataRaw.chartConfig.yAxis.trim() || fallbackChart.yAxis,
            xAxis: chartDataRaw.chartConfig.xAxis.trim() || fallbackChart.xAxis,
            center: chartDataRaw.chartConfig.center.trim() || fallbackChart.center,
            footer: chartDataRaw.chartConfig.footer.trim() || fallbackChart.footer,
            tipping: chartDataRaw.chartConfig.tipping.trim() || fallbackChart.tipping
          };
          const fallbackDrivers = STATE.defaultsDrivers();
          STATE.drivers.forEach((d, i) => {
            d.label = chartDataRaw.drivers[i].label.trim() || fallbackDrivers[i].label;
            const b = parseLines(chartDataRaw.drivers[i].bullets, 3);
            d.bullets = b.length === 3 ? b : fallbackDrivers[i].bullets;
          });
          STATE.modalOpen=false;
          STATE.activeTab='problems';
          STATE.openWhy=null;
          render();
        }
        if(action==='reset-currentstate-defaults'){
          clearDraft();
          captureDefaultsOnce();
          writeFields(DEFAULT_CURRENT_STATE);
          STATE.chartConfig = STATE.defaultsChartConfig();
          STATE.drivers = STATE.defaultsDrivers();
          writeChartFields(STATE.chartConfig, STATE.drivers.map(d => ({label: d.label, bullets: d.bullets.join('\n')})));
          STATE.currentState = STATE.defaultsCurrentState();
          render();
        }
      });
      document.addEventListener('keydown',(e)=>{
        if(e.key==='Escape' && (STATE.modalOpen || STATE.openWhyModal || STATE.insightContent)){
          STATE.modalOpen=false;
          STATE.openWhyModal=null;
          STATE.insightContent=null;
          render();
        }
      });
    </script>
  </body>
</html>
