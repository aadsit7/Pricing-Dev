<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Recast — Compact Click-Through (Realistic Catalog)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="dark light" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://unpkg.com" />
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      /* ------------------------------
         Keyframes (V1 only - removed V2 extras)
         ------------------------------ */
      @keyframes tilePulse {
        0% {
          transform: scale(0.7);
          background-color: #e5e7eb;
          opacity: 0.4;
        }
        60% {
          transform: scale(1);
          background-color: #2563eb;
          opacity: 1;
        }
        100% {
          background-color: #e5e7eb;
          opacity: 0.9;
        }
      }
      @keyframes barGrow {
        to {
          transform: scaleX(1);
        }
      }
      @keyframes boltDrop {
        to {
          transform: scaleY(1);
        }
      }
      @keyframes appLiftPulse {
        0% {
          transform: translateY(0) scale(1);
          filter: saturate(0.4);
          opacity: 0.65;
        }
        30% {
          transform: translateY(-4px) scale(1.05);
        }
        60% {
          transform: translateY(-2px) scale(1.02);
          filter: saturate(1);
          opacity: 1;
        }
        100% {
          transform: translateY(0) scale(1);
        }
      }
      @keyframes badgeDrop {
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }
      @keyframes fadeInOut {
        0% {
          opacity: 0;
        }
        30% {
          opacity: 1;
        }
        70% {
          opacity: 1;
        }
        100% {
          opacity: 0;
        }
      }
      @keyframes iconLaunch {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
        }
      }
      @keyframes fadeIn {
        to {
          opacity: 1;
        }
      }
      @keyframes modalEnter {
        0% {
          transform: scale(0.95);
          opacity: 0;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }
      @keyframes overlayFade {
        0% {
          opacity: 0;
        }
        100% {
          opacity: 1;
        }
      }
      /* New keyframes for token movement */
      @keyframes tokenMove {
        0% { left: 0%; }
        33% { left: 33%; }
        66% { left: 66%; }
        100% { left: 100%; }
      }
      /* New keyframe for pulse */
      @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
      }
      .animate-cardPop {
        animation: cardPop 220ms cubic-bezier(0.2, 0.8, 0.2, 1);
      }
      /* ------------------------------
         Lightweight animation hooks
         ------------------------------ */
      .run [data-anim="tilePulse"] {
        animation: tilePulse 1s ease-in-out var(--d, 0s) 1 forwards;
      }
      .run [data-anim="barGrow"] {
        animation: barGrow 0.9s ease forwards var(--d, 0s);
      }
      .run [data-anim="boltDrop"] {
        animation: boltDrop 0.9s ease forwards var(--d, 0s);
      }
      .run [data-anim="fadeInOut"] {
        animation: fadeInOut 1.5s ease var(--d, 0s) forwards;
      }
      .run [data-anim="badgeDrop"] {
        animation: badgeDrop 0.8s ease-out var(--d, 0s) forwards;
      }
      .animate-modalEnter {
        animation: modalEnter 300ms cubic-bezier(0.2, 0.8, 0.2, 1);
      }
      .animate-overlayFade {
        animation: overlayFade 300ms ease;
      }
      .animate-fadeInOut {
        animation: fadeInOut 1.5s ease var(--d, 0s) forwards;
      }
      .animate-fadeIn {
        animation: fadeIn 1s ease 10s forwards;
      }
      .animate-iconLaunch {
        animation: iconLaunch 0.5s ease forwards;
      }
      /* V1 end-user expand (added) */
      .end-user-expand {
        transition: all 0.5s ease;
        transform: scale(1.05);
        background: #ffffff;
        border-color: #10b981;
      }
      /* New styles for top flow token */
      .flow-header {
        position: relative;
      }
      .flow-token {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 12px;
        height: 12px;
        background-color: #2563eb;
        border-radius: 50%;
        transition: left 3s linear;
        z-index: 10;
      }
      .flow-token.animating {
        animation: tokenMove 3s linear 3;
      }
      /* New styles for hub */
      .recast-hub {
        position: relative;
        display: inline-block;
      }
      .recast-hub::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 24px;
        height: 24px;
        background-color: rgba(37, 99, 235, 0.1);
        border-radius: 50%;
      }
      .recast-hub.pulsing::before {
        animation: pulse 0.5s ease-in-out;
      }
      /* New styles for cascade active */
      .active {
        border-color: #2563eb;
        box-shadow: 0 0 8px rgba(37, 99, 235, 0.3);
        transition: all 0.3s ease;
      }
      /* New styles for delivered app in devices */
      .delivered-app {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      .delivered-app.visible {
        opacity: 1;
      }
      /* New styles for 2x2 grid on Current State tab */
      .display-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        justify-content: center;
      }
      @media (max-width: 768px) {
        .display-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body class="min-h-screen antialiased bg-gray-50 text-gray-900 font-[Inter]">
    <div id="app" class="min-h-screen"></div>
    <div id="solution-portal"></div>
    <script>
      /* =========================
         STATE + CONSTANTS
         ========================= */
      const STATE = {
        activeTab: "problems",
        valueTab: "customer", // New: active sub-tab in Business Impact (customer or partner)
        isValueEditing: false, // New: edit mode for Business Impact tabs
        editAssumptions: false,
        impactInputs: {
          employees: 1100,
          ticketsPerUserPerMonth: 0.035,
          avgTimePerTicketMin: 18,
          appUpdatesPerMonth: 22,
        },
        activeView: "exec",
        impact: { minutes: 9, pkgHours: 6, riskHrs: 22.5 },
        defaults: { impact: { minutes: 9, pkgHours: 6, riskHrs: 22.5 } },
        ctx: { device: "Windows", network: "Corporate", compliant: true },
        packHrs: 8,
        configHrs: 2,
        currentHrs: 24,
        roiInputs: { users: 5000, ticketsPerUserPerMonth: 0.035, avgHandleMins: 18 },
        copied: false,
        showLabels: false,
        showSolutionCards: true,
        openWhy: null,
        openWhyModal: null,
        // (Old accordion state left in place to avoid unintended side effects elsewhere.)
        openCards: { core: false, onboarding: false, trust: false },
        // New: wizard-style popout card navigation on the Recast Approach tab
        solutionStep: 0,
        visitedCards: [],
        openBuckets: { one: false, zero: false, per: false, edit: false },
        modalOpen: false,
        editBuffers: {
          change: { intro: "", bullets: "", analyst: "" },
          now: { intro: "", bullets: "", analyst: "" },
          recast: { intro: "", bullets: "", analyst: "" },
        },
        selectedBullets: {},
        selectedCardBullets: { core: [], onboarding: [], trust: [] },
        currentState: {
          change: {
            intro:
              "The app layer has become the biggest slowdown in IT. Teams are drowning in apps, constant updates, and one-off fixes, and every project ends up paying the price.",
            bullets: [
              "There are too many apps to manage by hand. Commercial, internal, and legacy software are spread across Intune, ConfigMgr, VDI, Windows, and macOS.",
              "Headcount hasn’t grown, but the work has exploded. Most teams are already over capacity and spend most of their day reacting to app issues.",
              "Big initiatives keep getting stuck. Cloud moves, Citrix or AVD projects, hardware refreshes, and AI efforts all run into the same wall — app readiness.",
              "Technical debt keeps piling up. Different versions of the same app are everywhere, creating more risk, more tickets, and slower recovery when things break.",
            ],
            analyst:
              "When the application layer is a mess, transformation projects stall or fail. It’s not because the strategy is wrong, but because there’s no capacity left to execute.",
          },
          now: {
            intro:
              "IT teams are being asked to manage more apps and more change with the same people and the same tools. The gap between what’s expected and what’s possible keeps getting wider.",
            bullets: [
              "App updates and complexity keep increasing, but team size stays the same. You can’t scale people the way you scale software.",
              "Internal and custom apps don’t update themselves, so every change adds more manual work, more dependencies, and more risk.",
              "Leadership wants progress on AI, modernization, and new platforms, but the teams who could drive that progress are stuck keeping apps running.",
              "The longer this goes on, the worse it gets. Version sprawl grows, security and compliance get harder, and cleanup costs rise fast.",
            ],
            analyst:
              "In the next few years, the organizations that succeed with AI and modernization will be the ones that fix app delivery first. Everyone else will hit a hard capacity wall.",
          },
          recast: {
            intro:
              "Recast’s Application Workspace solves the core problem. It gives IT one place to package, update, and manage every application so the app layer stops slowing everything down.",
            bullets: [
              "One workspace for every app, whether commercial, internal, or legacy. Installs, updates, and access all handled consistently across Intune, ConfigMgr, AVD, and other systems.",
              "Automates what teams still do by hand — packaging, versioning, and pushing updates, especially for internal and custom apps.",
              "Reduces technical debt and version sprawl, which means fewer variables when something breaks and far fewer app-related tickets.",
              "Frees up IT capacity. What used to take hours now takes minutes, so migrations, pilots, patch cycles, and AI projects can finally move at business speed.",
            ],
            analyst:
              "Recast turns app management from a drag on every project into a stable foundation. Readiness stops being the blocker and becomes the default.",
          },
        },
        defaultsCurrentState() {
          return JSON.parse(
            JSON.stringify({
              change: {
                intro:
                  "The app layer has become the biggest slowdown in IT. Teams are drowning in apps, constant updates, and one-off fixes, and every project ends up paying the price.",
                bullets: [
                  "There are too many apps to manage by hand. Commercial, internal, and legacy software are spread across Intune, ConfigMgr, VDI, Windows, and macOS.",
                  "Headcount hasn’t grown, but the work has exploded. Most teams are already over capacity and spend most of their day reacting to app issues.",
                  "Big initiatives keep getting stuck. Cloud moves, Citrix or AVD projects, hardware refreshes, and AI efforts all run into the same wall — app readiness.",
                  "Technical debt keeps piling up. Different versions of the same app are everywhere, creating more risk, more tickets, and slower recovery when things break.",
                ],
                analyst:
                  "When the application layer is a mess, transformation projects stall or fail. It’s not because the strategy is wrong, but because there’s no capacity left to execute.",
              },
              now: {
                intro:
                  "IT teams are being asked to manage more apps and more change with the same people and the same tools. The gap between what’s expected and what’s possible keeps getting wider.",
                bullets: [
                  "App updates and complexity keep increasing, but team size stays the same. You can’t scale people the way you scale software.",
                  "Internal and custom apps don’t update themselves, so every change adds more manual work, more dependencies, and more risk.",
                  "Leadership wants progress on AI, modernization, and new platforms, but the teams who could drive that progress are stuck keeping apps running.",
                  "The longer this goes on, the worse it gets. Version sprawl grows, security and compliance get harder, and cleanup costs rise fast.",
                ],
                analyst:
                  "In the next few years, the organizations that succeed with AI and modernization will be the ones that fix app delivery first. Everyone else will hit a hard capacity wall.",
              },
              recast: {
                intro:
                  "Recast’s Application Workspace solves the core problem. It gives IT one place to package, update, and manage every application so the app layer stops slowing everything down.",
                bullets: [
                  "One workspace for every app, whether commercial, internal, or legacy. Installs, updates, and access all handled consistently across Intune, ConfigMgr, AVD, and other systems.",
                  "Automates what teams still do by hand — packaging, versioning, and pushing updates, especially for internal and custom apps.",
                  "Reduces technical debt and version sprawl, which means fewer variables when something breaks and far fewer app-related tickets.",
                  "Frees up IT capacity. What used to take hours now takes minutes, so migrations, pilots, patch cycles, and AI projects can finally move at business speed.",
                ],
                analyst:
                  "Recast turns app management from a drag on every project into a stable foundation. Readiness stops being the blocker and becomes the default.",
              },
            })
          );
        },
        progress: { apps: 0, time: 0, tickets: 0 },
        items: [], // Array of {type: 'image', src: string} or {type: 'embed', src: string} (up to 5)
        itemViewerOpen: false, // Flag for item viewer modal
        currentItemIndex: 0, // Current index in item carousel
        itemManagerOpen: false, // Flag for item manager modal
        theaterMode: false, // New: theater mode toggle for embeds in viewer
        openSolutionModal: null, // New: 'core' | 'onboarding' | 'trust' | null
        solutionOpenerId: null // New: id of opener button for focus return
      };
      const TABS = [
        { id: "problems", label: "Current State", icon: "alert-triangle" },
        { id: "solution", label: "Recast Approach", icon: "workflow" },
        { id: "roi", label: "Business Impact", icon: "bar-chart-3" },
      ];
      const NEW_CARDS = [
        {
          id: "core",
          icon: "layers",
          title: "How Recast Does It.",
          bullets: [
            "One workspace to manage the full app lifecycle across SCCM, Intune, Citrix, Omnissa, and Azure — even while platforms coexist and change.",
            "A library of 8,000+ pre-tested enterprise apps — plus support for your existing custom and large-scale applications.",
            "Automated patching and validation reduce version sprawl and maintain compliance across mixed SCCM and Intune environments.",
            "A unified control plane that restores visibility and governance across all app delivery paths — regardless of backend platform.",
            "Policy-driven automation reduces manual work by over 60%.",
            "End users access the right apps through a consistent experience — without retraining or new workflows as IT changes behind the scenes",
          ],
          closer: "Applications follow the USER not the device - Delivered everywhere.",
          timeline: false,
          bgHeader: "bg-gray-50",
          bgContent: "bg-gray-50",
        },
        {
          id: "onboarding",
          icon: "clock",
          title: "Onboard & Up to Speed Fast.",
          bullets: [
            "Standard rollout in 4–6 weeks (Kickoff — Implementation — UAT — Launch — Enablement).",
            "No new infrastructure — integrates with your existing management tools.",
            "Guided setup with dedicated Customer Success Manager.",
            "Typical resource: 1–2 IT engineers part-time.",
            "Enablement includes training, certification, and success planning.",
          ],
          closer: "From first call to production in weeks, not months.",
          timeline: true,
          bgHeader: "bg-gray-50",
          bgContent: "bg-gray-50",
        },
        {
          id: "trust",
          icon: "shield-check",
          title: "Trusted by Customers",
          bullets: [
            "60M+ endpoints across 130+ countries.",
            "70k+ Customers & Trusted by global organizations| Citibank, McKinsey & Company, U.S. Air Force, FEMA, Hitachi, Johns Hopkins, Costco, Government of Canada.",
            "87 CSAT Score | Most trusted in the industry",
            "Proven scalability from small pilots to global deployments.",
            "Backed by enterprise-grade support and compliance alignment (SOC 2, ISO 27001).",
          ],
          closer: "Trusted by organizations that can’t afford downtime.",
          timeline: false,
          bgHeader: "bg-gray-50",
          bgContent: "bg-gray-50",
        },
      ];
      const onboardingMiniTimelineEnabled = true;
      function cx(...a) {
        return a.filter(Boolean).join(" ");
      }
      function round(n) {
        return Math.round(n * 100) / 100;
      }
      function num(n) {
        return new Intl.NumberFormat().format(Math.round(n));
      }
      function routeRecommendation(ctx) {
        if (!ctx.compliant) return "Web";
        if (ctx.device === "Windows" && ctx.network !== "Home") return "Local";
        return "VDI";
      }
      function cleanNum(v) {
        v = Number(String(v).replace(/[^0-9.\-]/g, ""));
        return isFinite(v) ? v : 0;
      }
      /* =========================
         RENDER
         ========================= */
      function render() {
        const root = document.getElementById("app");
        root.innerHTML = `
          <header class="relative">
            <div class="relative mx-auto max-w-6xl px-6 lg:px-12 pt-8 pb-6">
              <h1 class="text-4xl md:text-5xl font-semibold leading-tight">
                <span class="text-blue-600">Re</span><span class="text-gray-900">cast Application Workspace</span>
              </h1>
            </div>
            <div class="relative mx-auto max-w-6xl px-6 lg:px-12">
              <div role="tablist" aria-label="Demo sections" class="flex flex-nowrap overflow-x-auto gap-2 rounded bg-gray-50 p-1 ring-1 ring-gray-200">
                ${TABS.map(
                  (t) => `
                  <button type="button" class="${cx(
                    "flex-1 inline-flex items-center justify-center gap-2 px-3.5 py-1.5 text-sm focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2 transition rounded-full",
                    STATE.activeTab === t.id
                      ? "bg-blue-600 text-white hover:bg-blue-700"
                      : "text-gray-900 hover:bg-gray-100"
                  )}" data-action="switch-tab" data-tab="${t.id}" aria-controls="panel-${t.id}" aria-selected="${
                    STATE.activeTab === t.id
                  }">
                    <i data-lucide="${t.icon}" class="w-4 h-4"></i><span>${t.label}</span>
                  </button>
                `
                ).join("")}
              </div>
            </div>
          </header>
          <main class="mx-auto max-w-6xl px-6 lg:px-12 pb-8 gap-4">
            <section class="mt-4">${renderActivePanel()}</section>
          </main>
          ${renderModal()}
          ${renderWhyModal()}
          ${renderItemViewerModal()}
          ${renderItemManagerModal()}
        `;
        if (window.lucide?.createIcons) {
          try {
            window.lucide.createIcons();
          } catch {}
        }
        attachEvents();
        if (STATE.activeTab === "solution") {
          buildFlow();
        }
        if (STATE.activeTab === "roi") {
          loadValueContent();
        }
        renderSolutionPortal();
        attachSolutionModalEvents();
      }
      function renderSolutionPortal() {
        const portal = document.getElementById("solution-portal");
        if (!portal) return;
        portal.innerHTML = renderSolutionModal();
      }
      function renderSolutionModal() {
        if (!STATE.openSolutionModal) return '';
        const id = STATE.openSolutionModal;
        const card = NEW_CARDS.find(c => c.id === id);
        if (!card) return '';
        const index = NEW_CARDS.findIndex(c => c.id === id);
        const step = index + 1;
        const total = NEW_CARDS.length;
        const isLast = index === total - 1;
        const reducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        const animClass = reducedMotion ? '' : 'animate-modalEnter';
        const overlayAnim = reducedMotion ? '' : 'animate-overlayFade';
        const value = card.closer;
        const bulletsHtml = card.bullets.map(b => `<li class="flex items-start gap-2 text-base text-gray-700 leading-relaxed"><i data-lucide="check-circle" class="w-5 h-5 text-blue-600 shrink-0"></i><span>${b}</span></li>`).join('');
        let proof = '';
        if (id === 'trust') {
          proof = '<div class="mt-6 flex flex-wrap gap-3">' +
            '<span class="bg-gray-100 text-gray-800 px-4 py-2 rounded-full text-sm font-medium">60M+ endpoints</span>' +
            '<span class="bg-gray-100 text-gray-800 px-4 py-2 rounded-full text-sm font-medium">SOC 2</span>' +
            '<span class="bg-gray-100 text-gray-800 px-4 py-2 rounded-full text-sm font-medium">ISO 27001</span>' +
            '</div>';
        }
        const footer = `<div class="p-6 border-t border-gray-200 flex justify-end gap-3 sticky bottom-0 bg-white">
          <button type="button" data-action="close-solution-modal" class="px-6 py-2 rounded-full bg-gray-200 text-gray-900 hover:bg-gray-300 focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2">Close</button>
          ${!isLast ? `<button type="button" data-action="next-solution-modal" class="px-6 py-2 rounded-full bg-blue-600 text-white hover:bg-blue-700 focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2">Next</button>` : ''}
        </div>`;
        if (STATE.openSolutionModal) document.body.style.overflow = 'hidden';
        return `
          <div class="fixed inset-0 z-[1000] flex items-center justify-center bg-black/50 ${overlayAnim}" data-action="close-solution-modal-outside">
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden ${animClass}" style="width: min(900px, 92vw); height: min(720px, 88vh);">
              <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-xl font-medium text-gray-900">${card.title}</h2>
                <button type="button" data-action="close-solution-modal" class="text-gray-500 hover:text-gray-700 p-1" aria-label="Close">
                  <i data-lucide="x" class="w-6 h-6"></i>
                </button>
              </div>
              <div class="p-6 overflow-y-auto" style="max-height: calc(min(720px, 88vh) - 8rem);;">
                <p class="text-base text-gray-700 mb-6 leading-relaxed">${value}</p>
                <ul class="space-y-4">
                  ${bulletsHtml}
                </ul>
                ${proof}
              </div>
              ${footer}
            </div>
          </div>
        `;
      }
      function attachSolutionModalEvents() {
        const portal = document.getElementById('solution-portal');
        if (!portal || !STATE.openSolutionModal) return;
        portal.querySelectorAll('[data-action="close-solution-modal"]').forEach(b => {
          b.addEventListener('click', closeSolutionModal, {once: true});
        });
        portal.querySelectorAll('[data-action="next-solution-modal"]').forEach(b => {
          b.addEventListener('click', nextSolutionModal, {once: true});
        });
        portal.addEventListener('click', (e) => {
          if (e.target === portal) closeSolutionModal();
        }, {once: true});
      }
      function closeSolutionModal() {
        document.body.style.overflow = '';
        const openerId = STATE.solutionOpenerId;
        STATE.openSolutionModal = null;
        STATE.solutionOpenerId = null;
        render();
        if (openerId) {
          const opener = document.getElementById(openerId);
          if (opener) opener.focus();
        }
      }
      function nextSolutionModal() {
        const currentIndex = NEW_CARDS.findIndex(c => c.id === STATE.openSolutionModal);
        if (currentIndex < NEW_CARDS.length - 1) {
          STATE.openSolutionModal = NEW_CARDS[currentIndex + 1].id;
          render();
        }
      }
      function renderActivePanel() {
        if (STATE.activeTab === "problems") return renderProblems();
        if (STATE.activeTab === "solution") return renderSolution();
        if (STATE.activeTab === "roi") return renderBusinessImpact();
        return "";
      }
      /* =========================
         CURRENT STATE (PROBLEMS TAB)
         ========================= */
      const pressures = [
        {
         id: "cost",
          title: "APP DELIVERY IS CONSUMING EUC CAPACITY",
          bullets: [
            "Application packaging and maintenance now dominate endpoint team workloads",
            "Each new app or update introduces unique edge cases and rework",
            "Co-management (Intune + ConfigMgr) increases operational complexity",
            "Lack of standardization hides friction across the lifecycle.",
          ],
        },
        {
          id: "risk",
          title: "RISK, COMPLIANCE & SECURITY",
          bullets: [
            "Multiple versions of the same app exist across devices and platforms",
            "Patch cycles vary by deployment method, creating blind spots.",
            "Visibility into app versions and compliance is fragmented",
            "Security and audit readiness depends on manual verification",
          ],
        },
        {
          id: "capacity",
          title: "MODERNIZATION INITIATIVES STALL AT THE APPLICATION LAYER",
          bullets: [
            "Flat headcount limits the pace of change.",
            "Cloud, AVD, ARM, and Intune projects pause due to app readiness gaps",
            "Packaging backlogs delay pilots and production rollouts",
            "Endpoint teams operate reactively under constant delivery pressure",
          ],
        },
        {
          id: "employee",
          title: "EMPLOYEE EXPERIENCE & ENABLEMENT",
          bullets: [
            "Users experience inconsistent install behavior across devices.",
            "App access and versions vary by user, role, or platform",
            "L1 tickets escalate due to lack of standardization",
            "IT is blamed for issues caused by delivery inconsistency",
          ],
        },
      ];
      function renderProblems() {
        return `
          <section id="panel-problems" class="space-y-3 relative">
            <h2 class="text-3xl font-semibold leading-tight">The application layer is the #1 bottleneck to operational change</h2>
            <p class="text-base text-gray-700 leading-relaxed">Most IT teams are operating at full capacity — but the delivery model isn’t keeping up with change.</p>
            <div class="display-grid">
              ${pressures
                .map(
                  (p) => `
                <div class="rounded-2xl bg-white shadow-md hover:shadow-lg hover:-translate-y-[2px] transition-shadow duration-300 transition-transform p-4 flex flex-col space-y-1 h-full">
                  <h3 class="text-[14px] font-semibold mb-1">${p.title}</h3>
                  <ul class="list-disc list-inside space-y-1 text-[12px] text-gray-700">
                    ${p.bullets
                      .map((b, i) => {
                        const selected = (STATE.selectedBullets[p.id] || []).includes(i);
                        return `
                        <li class="flex items-center gap-2 min-h-[1.25rem] ${
                          selected ? "bg-blue-50 rounded-md p-1 transition-colors" : ""
                        } ${b ? "" : "invisible"}">
                          <label class="flex items-center gap-2 cursor-pointer select-none w-full">
                            <input type="checkbox" class="sr-only" data-action="toggle-bullet" data-category="${
                              p.id
                            }" data-index="${i}" ${selected ? "checked" : ""} aria-label="Select: ${b}">
                            <div class="w-3.5 h-3.5 border-2 rounded-full flex items-center justify-center transition-all duration-200 ease-in-out shrink-0 ${
                              selected ? "bg-blue-600 border-blue-600" : "border-gray-300 bg-white"
                            }">
                              ${
                                selected
                                  ? '<i data-lucide="check" class="w-2.5 h-2.5 text-white stroke-[3]"></i>'
                                  : ""
                              }
                            </div>
                            <span class="${selected ? "text-blue-800 font-medium" : ""}">${b}</span>
                          </label>
                        </li>
                      `;
                      })
                      .join("")}
                  </ul>
                </div>
              `
                )
                .join("")}
            </div>
            <div class="mt-6 flex justify-between items-center">
              <div class="flex items-center gap-2">
                <button type="button" data-action="open-item-manager" class="p-1 text-gray-600 hover:text-blue-600 focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2" aria-label="Manage items">
                  <i data-lucide="pencil" class="w-5 h-5"></i>
                </button>
                ${STATE.items.length > 0 ? `
                  <button type="button" data-action="open-item-viewer" class="p-1 text-gray-600 hover:text-blue-600 focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2" aria-label="Play items">
                    <i data-lucide="play" class="w-5 h-5"></i>
                  </button>
                ` : ''}
              </div>
              <button type="button" data-action="next-tab" class="bg-blue-600 text-white rounded-full px-4 py-1.5 hover:bg-blue-700 hover:scale-102 transition-all duration-200 focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2 text-sm">Next</button>
            </div>
            <!-- Hidden file input for image upload in manager -->
            <input type="file" id="imageUploadManager" accept="image/*" multiple class="hidden" data-action="handle-manager-upload">
          </section>
        `;
      }
      /* =========================
         ITEM VIEWER MODAL
         ========================= */
      function renderItemViewerModal() {
        if (!STATE.itemViewerOpen) return "";
        const items = STATE.items;
        const current = items[STATE.currentItemIndex] || {type: 'image', src: ''};
        const canPrev = STATE.currentItemIndex > 0;
        const canNext = STATE.currentItemIndex < items.length - 1;
        const isEmbed = current.type === "embed";
        return `
          <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 animate-overlayFade" role="dialog" aria-modal="true" aria-labelledby="item-viewer-title">
            <div class="${STATE.theaterMode ? 'w-full max-w-none mx-0' : 'w-full max-w-4xl mx-4'} bg-white rounded-2xl shadow-2xl overflow-hidden animate-modalEnter" style="max-height: 95vh; overflow-y: auto;">
              <div class="bg-gray-50 px-6 py-4 flex items-center justify-between border-b border-gray-200">
                <h2 id="item-viewer-title" class="text-2xl font-bold tracking-tight text-gray-900">Recast</h2>
                <button type="button" class="text-gray-500 hover:text-gray-700 focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2 p-1.5" data-action="close-item-viewer" aria-label="Close">
                  <i data-lucide="x" class="w-5 h-5"></i>
                </button>
              </div>
              <div class="p-6 bg-gray-50 flex flex-col items-center">
                ${current.type === "image" ? `
                  <img src="${current.src}" alt="Item ${STATE.currentItemIndex + 1}" class="max-w-full max-h-[60vh] object-contain rounded-lg shadow-md">
                ` : `
                  <iframe src="${current.src}" class="${STATE.theaterMode ? 'w-full h-[80vh]' : 'w-full h-[60vh]'} rounded-lg shadow-md" frameborder="0" allowfullscreen sandbox="allow-scripts allow-same-origin allow-popups"></iframe>
                `}
                <div class="mt-4 flex items-center gap-4">
                  <button type="button" data-action="prev-item" class="${cx('px-4 py-2 rounded bg-blue-600 text-white', !canPrev ? 'opacity-50 cursor-not-allowed' : '')}" ${!canPrev ? 'disabled' : ''}>Back</button>
                  <span class="text-gray-700">Item ${STATE.currentItemIndex + 1} / ${items.length}</span>
                  <button type="button" data-action="next-item" class="${cx('px-4 py-2 rounded bg-blue-600 text-white', !canNext ? 'opacity-50 cursor-not-allowed' : '')}" ${!canNext ? 'disabled' : ''}>Next</button>
                  <button type="button" data-action="delete-item" data-index="${STATE.currentItemIndex}" class="px-4 py-2 rounded bg-red-600 text-white">Delete</button>
                  ${isEmbed ? `
                    <button type="button" data-action="toggle-theater" class="px-4 py-2 rounded bg-gray-600 text-white">${STATE.theaterMode ? 'Normal Mode' : 'Theater Mode'}</button>
                  ` : ''}
                </div>
              </div>
            </div>
          </div>
        `;
      }
      /* =========================
         ITEM MANAGER MODAL
         ========================= */
      function renderItemManagerModal() {
        if (!STATE.itemManagerOpen) return "";
        const items = STATE.items;
        const canAdd = items.length < 5;
        return `
          <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 animate-overlayFade" role="dialog" aria-modal="true" aria-labelledby="item-manager-title">
            <div class="w-full max-w-md mx-4 bg-white rounded-2xl shadow-2xl overflow-hidden animate-modalEnter" style="max-height: 95vh; overflow-y: auto;">
              <div class="bg-gray-50 px-6 py-4 flex items-center justify-between border-b border-gray-200">
                <h2 id="item-manager-title" class="text-2xl font-bold tracking-tight text-gray-900">Manage Items (up to 5)</h2>
                <button type="button" class="text-gray-500 hover:text-gray-700 focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2 p-1.5" data-action="close-item-manager" aria-label="Close">
                  <i data-lucide="x" class="w-5 h-5"></i>
                </button>
              </div>
              <div class="p-6 bg-gray-50">
                <button type="button" data-action="upload-more-images" class="${cx('w-full px-4 py-2 rounded bg-blue-600 text-white mb-2', !canAdd ? 'opacity-50 cursor-not-allowed' : '')}" ${!canAdd ? 'disabled' : ''}>Add Images</button>
                <input type="text" id="embedUrlInput" placeholder="Paste embed URL or iframe (e.g., Google Slides)" class="w-full px-3 py-2 border rounded mb-2">
                <button type="button" data-action="add-embed" class="${cx('w-full px-4 py-2 rounded bg-blue-600 text-white mb-4', !canAdd ? 'opacity-50 cursor-not-allowed' : '')}" ${!canAdd ? 'disabled' : ''}>Add Embed</button>
                <ul class="space-y-4">
                  ${items.map((item, i) => `
                    <li class="flex items-center gap-4 bg-white p-2 rounded shadow-sm">
                      ${item.type === 'image' ? `
                        <img src="${item.src}" alt="Item ${i + 1}" class="w-16 h-16 object-cover rounded">
                      ` : `
                        <div class="w-16 h-16 bg-gray-200 rounded flex items-center justify-center text-center text-xs p-1">
                          Embed<br>${getDomain(item.src)}
                        </div>
                      `}
                      <div class="flex gap-2">
                        <button type="button" data-action="move-item-up" data-index="${i}" class="${cx('p-1 text-gray-600 hover:text-blue-600', i === 0 ? 'opacity-50 cursor-not-allowed' : '')}" ${i === 0 ? 'disabled' : ''} aria-label="Move up">
                          <i data-lucide="arrow-up" class="w-4 h-4"></i>
                        </button>
                        <button type="button" data-action="move-item-down" data-index="${i}" class="${cx('p-1 text-gray-600 hover:text-blue-600', i === items.length - 1 ? 'opacity-50 cursor-not-allowed' : '')}" ${i === items.length - 1 ? 'disabled' : ''} aria-label="Move down">
                          <i data-lucide="arrow-down" class="w-4 h-4"></i>
                        </button>
                        <button type="button" data-action="delete-item-manager" data-index="${i}" class="p-1 text-gray-600 hover:text-red-600" aria-label="Delete">
                          <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                      </div>
                    </li>
                  `).join('')}
                </ul>
                <button type="button" data-action="save-items" class="w-full px-4 py-2 rounded bg-green-600 text-white mt-4">Save Changes</button>
              </div>
            </div>
          </div>
        `;
      }
      function getDomain(url) {
        try {
          return new URL(url).hostname.replace('www.', '');
        } catch {
          return 'Invalid';
        }
      }
      function sanitizeEmbed(input) {
        let src = input.trim();
        if (src.startsWith('<iframe')) {
          const match = src.match(/src="([^"]+)"/);
          if (match) src = match[1];
        }
        try {
          const u = new URL(src);
          if (u.protocol !== 'https:') return null;
          let host = u.hostname.replace('www.', '');
          if (host === 'docs.google.com' && u.pathname.includes('/pub')) {
            u.pathname = u.pathname.replace('/pub', '/embed');
            src = u.toString();
          }
          if (host === 'youtube.com' && u.pathname === '/watch') {
            const vid = u.searchParams.get('v');
            if (vid) src = `https://www.youtube.com/embed/${vid}`;
          } else if (host === 'youtu.be') {
            const vid = u.pathname.slice(1);
            if (vid) src = `https://www.youtube.com/embed/${vid}`;
          }
          return src;
        } catch {
          return null;
        }
      }
      /* =========================
         WHY MODAL
         ========================= */
      function renderWhyModal() {
        if (!STATE.openWhyModal) return "";
        const id = STATE.openWhyModal;
        const iconMap = { change: "alert-triangle", now: "clock-4", recast: "sparkles" };
        const labelMap = { change: "Why Change", now: "Why Now", recast: "Why Recast" };
        const data = STATE.currentState[id];
        const headerTone = "bg-gray-50";
        const cta = id === "recast";
        return `
          <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 animate-overlayFade" role="dialog" aria-modal="true" aria-labelledby="why-modal-title-${id}">
            <div class="w-full max-w-4xl mx-4 bg-white rounded-2xl shadow-2xl overflow-hidden animate-modalEnter" style="max-height: 95vh; overflow-y: auto;">
              <div class="${headerTone} px-6 py-4 flex items-center justify-between border-b border-gray-200">
                <div class="flex items-center gap-2">
                  <i data-lucide="${iconMap[id]}" class="w-7 h-7 text-gray-900" aria-hidden="true"></i>
                  <h2 id="why-modal-title-${id}" class="text-2xl font-bold tracking-tight text-gray-900">${labelMap[id]}</h2>
                </div>
                <button type="button" class="text-gray-500 hover:text-gray-700 focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2 p-1.5" data-action="close-why-modal" aria-label="Close">
                  <i data-lucide="x" class="w-5 h-5"></i>
                </button>
              </div>
              <div class="p-6 bg-gray-50">
                <p class="text-[15px] leading-relaxed text-gray-700 mb-3">${data.intro}</p>
                <div class="space-y-3">
                  ${data.bullets
                    .map(
                      (b) => `
                    <div class="bg-white p-3 rounded-lg shadow-sm flex items-start gap-2 hover:shadow-md transition-shadow duration-300">
                      <i data-lucide="check-circle" class="w-4.5 h-4.5 text-blue-600 flex-shrink-0 mt-0.5"></i>
                      <p class="text-[15px] leading-relaxed text-gray-700">${b}</p>
                    </div>
                  `
                    )
                    .join("")}
                </div>
                <div class="mt-5 bg-white p-3 rounded-lg shadow-sm hover:shadow-md transition-shadow duration-300 flex items-start gap-2">
                  <i data-lucide="lightbulb" class="w-4.5 h-4.5 text-yellow-400 flex-shrink-0 mt-0.5"></i>
                  <p class="text-[15px] italic text-gray-700">${data.analyst}</p>
                </div>
                ${
                  cta
                    ? `
                  <div class="mt-6 flex justify-center">
                    <button type="button" data-action="advance" data-next="solution" class="inline-flex bg-blue-600 text-white text-[15px] font-semibold px-5 py-2.5 items-center gap-2 focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2 shadow-md hover:shadow-lg hover:bg-blue-700 transition-shadow duration-300 rounded-full">
                      <i data-lucide="arrow-right" class="w-4.5 h-4.5"></i>
                      How Recast solves it
                    </button>
                  </div>
                `
                    : ""
                }
              </div>
            </div>
          </div>
        `;
      }
      /* =========================
         SOLUTION TAB (UPDATED UX)
         - Right-side accordion replaced with popout wizard cards + Back/Next
         ========================= */
      function renderMiniTimeline() {
        const phases = [
          { icon: "play-circle", label: "Kickoff" },
          { icon: "hammer", label: "Implementation" },
          { icon: "check-circle", label: "UAT" },
          { icon: "flag", label: "Launch" },
          { icon: "book-open", label: "Enablement" },
        ];
        return `
          <div class="flex items-center justify-between mt-4" aria-hidden="true">
            ${phases
              .map(
                (p, i) => `
              ${i > 0 ? '<div class="flex-1 h-px bg-gray-200 mx-2"></div>' : ""}
              <div class="flex flex-col items-center">
                <i data-lucide="${p.icon}" class="w-4.5 h-4.5 text-blue-600"></i>
                <span class="text-[11px] mt-0.5 text-gray-700">${p.label}</span>
              </div>
            `
              )
              .join("")}
          </div>
        `;
      }
      function renderRightRail() {
        return `
          <div class="flex flex-col gap-3">
            ${NEW_CARDS.map((card, index) => {
              const step = index + 1;
              const descriptor = card.closer;
              return `
                <button id="button-${card.id}" type="button" data-action="open-solution-modal" data-modal="${card.id}" class="h-[60px] bg-white rounded-xl border border-gray-200 p-3 flex items-center justify-between hover:bg-gray-50 hover:shadow-sm focus:ring-2 focus:ring-blue-600 focus:ring-offset-2 transition-all duration-300 text-left">
                  <div class="flex flex-col max-w-[80%]">
                    <span class="text-base font-medium text-gray-900 truncate">${card.title}</span>
                    <span class="text-sm text-gray-600 truncate">${descriptor}</span>
                  </div>
                </button>
              `;
            }).join('')}
          </div>
        `;
      }
      function renderSolution() {
        return `
          <section id="panel-solution" class="space-y-2">
            <div class="grid grid-cols-1 gap-6 lg:grid-cols-[3fr_1fr]">
              ${renderFlow()}
              ${renderRightRail()}
            </div>
          </section>
        `;
      }
      function renderFlow() {
        const sampleAppSvg = logo("Sample App", "S", "#2563eb").svg; // Use a sample app icon for fan-out
        return `
          <div class="relative rounded-2xl bg-white shadow-md hover:shadow-lg hover:-translate-y-[2px] transition-shadow duration-300 transition-transform p-6 mx-auto max-w-4xl">
            <div class="flex items-center justify-between gap-2">
              <div class="flex items-center gap-1.5">
                <div class="h-5 w-5 rounded grid place-items-center bg-blue-600">
                  <i data-lucide="layers" class="h-3 w-3 text-white"></i>
                </div>
                <div><h3 class="text-[14px] font-semibold">Recast</h3></div>
              </div>
              <div class="flex items-center gap-1.5 text-[11px]">
                <button type="button" data-action="start-flow" id="workspaceStartButton" class="bg-blue-600 text-white px-2 py-1 text-[11px] font-semibold rounded-full hover:bg-blue-700 focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2">Start</button>
                <button type="button" data-action="reset-flow" class="bg-transparent text-gray-900 border-2 border-gray-900 px-2 py-1 rounded-full hover:text-blue-600 hover:border-blue-600 focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2">Reset</button>
              </div>
            </div>
            <div class="mt-1 flex items-center justify-center gap-3 text-[13px] font-medium flow-header">
              <div class="flex items-center gap-1" id="label-managers">
                <i data-lucide="building" class="w-4.5 h-4.5 text-gray-700"></i>
                <span>Existing App Managers (SCCM, Intune, etc.)</span>
              </div>
              <i data-lucide="arrow-right" class="w-4.5 h-4.5 text-gray-500"></i>
              <div class="flex items-center gap-1 recast-hub" id="label-recast">
                <i data-lucide="truck" class="w-4.5 h-4.5 text-blue-600"></i>
                <span>Application Delivery (Recast)</span>
              </div>
              <i data-lucide="arrow-right" class="w-4.5 h-4.5 text-gray-500"></i>
              <div class="flex items-center gap-1" id="label-user">
                <i data-lucide="user" class="w-4.5 h-4.5 text-gray-700"></i>
                <span>User</span>
              </div>
              <div class="flow-token"></div>
            </div>
            <div class="mt-1 text-center bg-blue-50 p-1.5 rounded-lg text-[12px]">
              Users get one consistent app experience—while IT standardizes delivery behind the scenes across every platform.
            </div>
            <div id="flowCard" class="mt-2 rounded-xl border border-gray-200 bg-gradient-to-b from-white to-gray-50 shadow-inner relative overflow-hidden ${
              STATE.showLabels ? "show-labels" : ""
            }" role="region" aria-label="Animated flow">
              <div id="progressCounters" class="hidden mb-2 grid grid-cols-3 gap-1.5 text-[13px] text-center">
                <div><span class="font-semibold tabular-nums" id="appsProcessed">0</span> apps processed</div>
                <div><span class="font-semibold tabular-nums" id="timeSaved">0</span> hours saved</div>
                <div><span class="font-semibold tabular-nums" id="ticketsAvoided">0</span> tickets avoided</div>
              </div>
              <div class="space-y-1 relative">
                ${CATALOG.map(
                  (s) => `
                  <div class="grid grid-cols-[12ch_1fr] gap-0.5 items-center border-t border-gray-200 pt-0.5 transition-all duration-300 first:border-t-0 first:pt-0 show-labels:grid-cols-[12ch_1fr] show-labels:gap-3">
                    <div class="text-[11px] uppercase text-gray-700 flex items-center gap-1.5">
                      <i data-lucide="folder" class="w-2.5 h-2.5"></i>${s.title}
                    </div>
                    <div id="${s.id}" class="flex flex-wrap gap-1.5 show-labels:gap-3"></div>
                  </div>
                `
                ).join("")}
                <div id="overlayTag" class="opacity-0 transition-opacity duration-300 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white/90 p-3 rounded-2xl shadow-md z-10 show-labels:opacity-100 show-labels:delay-500 text-center text-[13px] text-gray-700">
                  Every app mapped to stage, policy, region, and device.
                </div>
              </div>
              <div id="flowHubFlash" class="mt-1 hidden text-blue-600">
                <span class="inline-flex items-center gap-1 text-[11px]">
                  <i data-lucide="bolt" class="h-3.5 w-3.5"></i><span>Update published</span>
                </span>
              </div>
              <div class="mt-2 grid grid-cols-3 gap-1.5 relative" aria-hidden="true" id="platformsSection">
                ${["A", "B", "C"]
                  .map(
                    (k, i) => `
                  <div class="rounded-xl border border-gray-200 bg-gray-50 transition-shadow duration-300 p-1.5 relative">
                    <div class="text-[11px] text-gray-700">${["Existing Platforms", "Staged Rings", "Access & Policy"][i]}</div>
                    <div id="flowConn${k}" class="mt-0.5 grid grid-cols-10 gap-1"></div>
                    <div data-anim="barGrow" class="mt-0.5 h-[0.22rem] rounded-[2px] origin-left scale-x-0 bg-gradient-to-r from-blue-600 to-blue-700" style="--d:${3 + 0.5 * i}s"></div>
                    <i data-lucide="check-circle" class="opacity-0 absolute top-0.5 right-0.5 w-3.5 h-3.5 text-green-500 animate-fadeInOut" style="--d:${4 + 0.5 * i}s"></i>
                  </div>
                `
                  )
                  .join("")}
                <div class="absolute top-[-0.5rem] left-0 w-full h-px opacity-50" style="background-image:linear-gradient(to right, transparent 50%, #e5e7eb 50%); background-size:4px 1px; background-repeat:repeat-x;"></div>
              </div>
              <div class="mt-2 grid grid-cols-3 gap-1.5 relative" aria-hidden="true" id="groupsSection">
                ${["A", "B", "C"]
                  .map(
                    (k, i) => `
                  <div class="rounded-xl border border-gray-200 bg-gray-50 transition-shadow duration-300 p-1.5 relative">
                    <div class="text-[11px] text-gray-700">${["Business Unit", "Subsidiary", "Region"][i]}</div>
                    <div id="flowGrp${k}" class="mt-0.5 grid grid-cols-8 gap-1"></div>
                    <div data-anim="boltDrop" class="mx-auto mt-0.5 w-[0.22rem] h-12 rounded-[2px] origin-top scale-y-0 bg-gradient-to-b from-gray-900 to-blue-600" style="--d:${5 + 0.5 * i}s"></div>
                    <i data-lucide="shield-check" class="opacity-0 absolute top-0.5 right-0.5 w-3.5 h-3.5 text-green-500 animate-fadeInOut" style="--d:${6 + 0.5 * i}s"></i>
                  </div>
                `
                  )
                  .join("")}
                <div class="absolute top-[-0.5rem] left-0 w-full h-px opacity-50" style="background-image:linear-gradient(to right, transparent 50%, #e5e7eb 50%); background-size:4px 1px; background-repeat:repeat-x;"></div>
              </div>
              <div class="mt-2 grid grid-cols-3 gap-1.5 relative" aria-hidden="true" id="devicesSection">
                ${["A", "B", "C"]
                  .map(
                    (k, i) => `
                  <div class="rounded-xl border border-gray-200 bg-gray-50 transition-shadow duration-300 p-1.5 text-center relative">
                    <i data-lucide="${["monitor-smartphone", "laptop", "smartphone"][i]}" class="h-4.5 w-4.5 text-gray-700"></i>
                    <div id="flowDev${k}" class="mt-0.5 grid grid-cols-6 gap-1"></div>
                    <div class="mt-0.5 text-[10px] text-gray-700">${["Windows & macOS", "VDI / Web", "Mobile"][i]}</div>
                    <i data-lucide="check-circle" class="opacity-0 absolute top-0.5 right-0.5 w-3.5 h-3.5 text-green-500 animate-fadeInOut" style="--d:${8 + 0.5 * i}s"></i>
                    <div class="delivered-app hidden">${sampleAppSvg}</div>
                  </div>
                `
                  )
                  .join("")}
                <div class="absolute top-[-0.5rem] left-0 w-full h-px opacity-50" style="background-image:linear-gradient(to right, transparent 50%, #e5e7eb 50%); background-size:4px 1px; background-repeat:repeat-x;"></div>
              </div>
              <div class="mt-2">
                <div id="endUserCard" class="rounded-xl border border-gray-200 bg-gray-50 transition-shadow duration-300 transition-all duration-500 p-2.5">
                  <div class="flex items-center gap-2">
                    <div id="endUserAvatar" class="h-8 w-8 grid place-items-center font-semibold rounded-full bg-red-600 text-white">U</div>
                    <div class="text-[13px]">
                      <div class="font-medium">End user</div>
                      <div id="endUserMessage" class="text-gray-700">Same workspace for the user — even as IT changes platforms behind the scenes.</div>
                    </div>
                  </div>
                  <div data-anim="barGrow" class="mt-2 h-[0.38rem] rounded-[2px] origin-left scale-x-0 bg-gradient-to-r from-blue-600 to-blue-700" style="--d:10s"></div>
                  <div class="relative mt-1 border border-gray-200 bg-gray-50 rounded-2xl p-3">
                    <i data-lucide="laptop" class="h-4.5 w-4.5 text-gray-700"></i>
                    <div id="endUserBadge" class="absolute right-1.5 top-1.5 w-[1rem] h-[1rem] rounded-full opacity-0 translate-y-[-6px] scale-90 grid place-items-center font-bold text-black bg-red-600" style="--d:11s">!</div>
                    <div class="mt-0.5 text-[10px] text-gray-700">The workspace delivers the right app, every time, regardless of backend platform.</div>
                  </div>
                  <div id="miniWorkspace" class="mt-2 hidden grid grid-cols-4 gap-1.5">
                    ${miniApps
                      .map(
                        (app) => `
                      <div class="w-[1.9rem] h-[1.9rem] rounded-xl grid place-items-center bg-white shadow-[inset_0_0_0_1px_rgba(15,23,42,0.08)] transition-all duration-300 hover:shadow-[0_0_10px_rgba(37,99,235,0.25)] hover:scale-[1.04] cursor-pointer" data-action="launch-icon">
                        ${app.svg}
                      </div>
                    `
                      )
                      .join("")}
                  </div>
                </div>
                <div id="flowSuccess" class="mt-1 hidden inline-flex items-center gap-1 text-[13px] opacity-0 animate-fadeIn text-green-500">
                  <i data-lucide="sparkles" class="h-3.5 w-3.5"></i><span>Configured once → delivered everywhere.</span>
                </div>
              </div>
            </div>
          </div>
        `;
      }
      /* =========================
         BUSINESS IMPACT TAB (NEW IMPLEMENTATION)
         ========================= */
      const VALUE_EDITABLE_IDS = [
        // Customer IDs
        'custValueTitle', 'custValueDesc',
        'custMetric1', 'custMetric2', 'custMetric3', 'custMetric4',
        'custTableHeader1', 'custTableHeader2', 'custTableHeader3',
        'custFeature1', 'custFeature2', 'custFeature3', 'custFeature4',
        // Partner IDs
        'partValueTitle', 'partValueDesc',
        'partMetric1', 'partMetric2', 'partMetric3', 'partMetric4',
        'partTableHeader1', 'partTableHeader2', 'partTableHeader3',
        'partFeature1', 'partFeature2', 'partFeature3', 'partFeature4'
      ];
      function renderBusinessImpact() {
        return `
          <div class="space-y-6">
            <div>
              <h2 class="text-3xl font-semibold leading-tight">Business Impact</h2>
              <p class="text-base text-gray-700 leading-relaxed">Explore the value for customers and partners.</p>
            </div>
            <div role="tablist" aria-label="Value tabs" class="flex flex-nowrap overflow-x-auto gap-2 rounded bg-gray-50 p-1 ring-1 ring-gray-200">
              <button type="button" class="${cx(
                "flex-1 inline-flex items-center justify-center gap-2 px-3.5 py-1.5 text-sm focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2 transition rounded-full",
                STATE.valueTab === "customer"
                  ? "bg-blue-600 text-white hover:bg-blue-700"
                  : "text-gray-900 hover:bg-gray-100"
              )}" data-action="switch-value-tab" data-tab="customer" aria-controls="customerTab" aria-selected="${STATE.valueTab === "customer"}">
                <i data-lucide="user-check" class="w-4 h-4"></i><span>Customer Value</span>
              </button>
              <button type="button" class="${cx(
                "flex-1 inline-flex items-center justify-center gap-2 px-3.5 py-1.5 text-sm focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2 transition rounded-full",
                STATE.valueTab === "partner"
                  ? "bg-blue-600 text-white hover:bg-blue-700"
                  : "text-gray-900 hover:bg-gray-100"
              )}" data-action="switch-value-tab" data-tab="partner" aria-controls="partnerTab" aria-selected="${STATE.valueTab === "partner"}">
                <i data-lucide="users" class="w-4 h-4"></i><span>Partner Value</span>
              </button>
            </div>
            <div class="bg-white rounded-2xl shadow-md p-6 hover:shadow-lg transition-shadow duration-300 relative">
              <div id="customerTab" class="tabcontent ${STATE.valueTab === 'customer' ? '' : 'hidden'}" role="tabpanel" aria-labelledby="customer-tab">
                <div class="flex flex-col md:flex-row gap-6">
                  <div class="flex-1">
                    <h2 id="custValueTitle" class="text-xl font-semibold editable">Customer Business Value</h2>
                    <p id="custValueDesc" class="mt-2 text-gray-700 editable">Delivers immediate value to end users and IT teams by streamlining application delivery and reducing operational friction during ongoing IT change.</p>
                  </div>
                  <div class="flex-1">
                    <h3 class="text-lg font-medium">Quantifiable Metrics</h3>
                    <ul class="mt-2 space-y-2">
                      <li id="custMetric1" class="flex items-center gap-2 editable"><i data-lucide="check" class="w-4 h-4 text-green-500"></i> Reduce app-related support tickets</li>
                      <li id="custMetric2" class="flex items-center gap-2 editable"><i data-lucide="check" class="w-4 h-4 text-green-500"></i> Decrease manual packaging and deployment effort</li>
                      <li id="custMetric3" class="flex items-center gap-2 editable"><i data-lucide="check" class="w-4 h-4 text-green-500"></i> Accelerate platform migrations without retraining users</li>
                      <li id="custMetric4" class="flex items-center gap-2 editable"><i data-lucide="check" class="w-4 h-4 text-green-500"></i> Improve audit readiness through standardized delivery</li>
                    </ul>
                  </div>
                </div>
                <div class="mt-6 overflow-x-auto">
                  <h3 class="text-lg font-medium">Comparison</h3>
                  <table class="min-w-full border-collapse mt-2">
                    <thead>
                      <tr class="bg-gray-100">
                        <th id="custTableHeader1" class="p-2 text-left editable">Feature</th>
                        <th id="custTableHeader2" class="p-2 text-center editable">Without Recast</th>
                        <th id="custTableHeader3" class="p-2 text-center editable">With Recast</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr class="border-t">
                        <td id="custFeature1" class="p-2 editable">Consistent application delivery</td>
                        <td class="p-2 text-center"><i data-lucide="x" class="w-5 h-5 text-red-500"></i></td>
                        <td class="p-2 text-center"><i data-lucide="check" class="w-5 h-5 text-green-500"></i></td>
                      </tr>
                      <tr class="border-t">
                        <td id="custFeature2" class="p-2 editable">Automated application updates</td>
                        <td class="p-2 text-center"><i data-lucide="x" class="w-5 h-5 text-red-500"></i></td>
                        <td class="p-2 text-center"><i data-lucide="check" class="w-5 h-5 text-green-500"></i></td>
                      </tr>
                      <tr class="border-t">
                        <td id="custFeature3" class="p-2 editable">Unified application management</td>
                        <td class="p-2 text-center"><i data-lucide="x" class="w-5 h-5 text-red-500"></i></td>
                        <td class="p-2 text-center"><i data-lucide="check" class="w-5 h-5 text-green-500"></i></td>
                      </tr>
                      <tr class="border-t">
                        <td id="custFeature4" class="p-2 editable">Reduced application version sprawl</td>
                        <td class="p-2 text-center"><i data-lucide="x" class="w-5 h-5 text-red-500"></i></td>
                        <td class="p-2 text-center"><i data-lucide="check" class="w-5 h-5 text-green-500"></i></td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <div id="partnerTab" class="tabcontent ${STATE.valueTab === 'partner' ? '' : 'hidden'}" role="tabpanel" aria-labelledby="partner-tab">
                <div class="flex flex-col md:flex-row gap-6">
                  <div class="flex-1">
                    <h2 id="partValueTitle" class="text-xl font-semibold editable">Partner Business Value</h2>
                    <p id="partValueDesc" class="mt-2 text-gray-700 editable">Enables partners to deliver repeatable, scalable application delivery services while reducing custom work, escalations, and delivery risk across customer environments.</p>
                  </div>
                  <div class="flex-1">
                    <h3 class="text-lg font-medium">Quantifiable Metrics</h3>
                    <ul class="mt-2 space-y-2">
                      <li id="partMetric1" class="flex items-center gap-2 editable"><i data-lucide="check" class="w-4 h-4 text-green-500"></i> Faster, more predictable deployments across customers</li>
                      <li id="partMetric2" class="flex items-center gap-2 editable"><i data-lucide="check" class="w-4 h-4 text-green-500"></i> Reduced post-deployment support and escalations</li>
                      <li id="partMetric3" class="flex items-center gap-2 editable"><i data-lucide="check" class="w-4 h-4 text-green-500"></i> Improved customer satisfaction through consistent outcomes</li>
                      <li id="partMetric4" class="flex items-center gap-2 editable"><i data-lucide="check" class="w-4 h-4 text-green-500"></i> Ability to scale services without linear headcount growth</li>
                    </ul>
                  </div>
                </div>
                <div class="mt-6 overflow-x-auto">
                  <h3 class="text-lg font-medium">Comparison</h3>
                  <table class="min-w-full border-collapse mt-2">
                    <thead>
                      <tr class="bg-gray-100">
                        <th id="partTableHeader1" class="p-2 text-left editable">Feature</th>
                        <th id="partTableHeader2" class="p-2 text-center editable">Without Recast</th>
                        <th id="partTableHeader3" class="p-2 text-center editable">With Recast</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr class="border-t">
                        <td id="partFeature1" class="p-2 editable">Scalable delivery model</td>
                        <td class="p-2 text-center"><i data-lucide="x" class="w-5 h-5 text-red-500"></i></td>
                        <td class="p-2 text-center"><i data-lucide="check" class="w-5 h-5 text-green-500"></i></td>
                      </tr>
                      <tr class="border-t">
                        <td id="partFeature2" class="p-2 editable">Standardized partner workflows</td>
                        <td class="p-2 text-center"><i data-lucide="x" class="w-5 h-5 text-red-500"></i></td>
                        <td class="p-2 text-center"><i data-lucide="check" class="w-5 h-5 text-green-500"></i></td>
                      </tr>
                      <tr class="border-t">
                        <td id="partFeature3" class="p-2 editable">Efficient service delivery</td>
                        <td class="p-2 text-center"><i data-lucide="x" class="w-5 h-5 text-red-500"></i></td>
                        <td class="p-2 text-center"><i data-lucide="check" class="w-5 h-5 text-green-500"></i></td>
                      </tr>
                      <tr class="border-t">
                        <td id="partFeature4" class="p-2 editable">Revenue scalability</td>
                        <td class="p-2 text-center"><i data-lucide="x" class="w-5 h-5 text-red-500"></i></td>
                        <td class="p-2 text-center"><i data-lucide="check" class="w-5 h-5 text-green-500"></i></td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="absolute bottom-4 right-4 flex gap-2">
                <button id="editSaveBtn" type="button" data-action="toggle-value-edit" class="px-4 py-2 rounded-full bg-blue-600 text-white hover:bg-blue-700 focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2">${STATE.isValueEditing ? 'Save' : 'Edit'}</button>
                ${STATE.isValueEditing ? `<button id="resetValueBtn" type="button" data-action="reset-value" class="px-4 py-2 rounded-full bg-gray-200 text-gray-900 hover:bg-gray-300 focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2">Reset</button>` : ''}
              </div>
            </div>
          </div>
        `;
      }
      function loadValueContent() {
        document.querySelectorAll('.editable').forEach(el => {
          const saved = localStorage.getItem(el.id);
          if (saved !== null) el.innerHTML = saved;
        });
      }
      function resetValueContent() {
        VALUE_EDITABLE_IDS.forEach(id => localStorage.removeItem(id));
        STATE.isValueEditing = false;
        render();
      }
      /* =========================
         APP ICONS + CATALOG (UNCHANGED)
         ========================= */
      function shade(hex, m) {
        const c = hex.replace("#", "");
        const n = [0, 1, 2].map((i) => parseInt(c.slice(i * 2, i * 2 + 2), 16));
        const s = n.map((v) => Math.max(0, Math.min(255, Math.round(v * m))));
        return "#" + s.map((v) => v.toString(16).padStart(2, "0")).join("");
      }
      function appIconShell(inner, { bgA = "#FFFFFF", bgB = "#F3F4F6", stroke = "rgba(15,23,42,.10)" } = {}) {
        const id = "sh" + Math.random().toString(16).slice(2);
        return `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="24" height="24" role="img">
            <defs>
              <linearGradient id="${id}g" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0" stop-color="${bgA}"/>
                <stop offset="1" stop-color="${bgB}"/>
              </linearGradient>
              <filter id="${id}d" x="-30%" y="-30%" width="160%" height="160%">
                <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="rgba(15,23,42,0.18)"/>
              </filter>
              <linearGradient id="${id}h" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0" stop-color="rgba(255,255,255,0.55)"/>
                <stop offset="0.55" stop-color="rgba(255,255,255,0.10)"/>
                <stop offset="1" stop-color="rgba(255,255,255,0.00)"/>
              </linearGradient>
            </defs>
            <rect x="2.2" y="2.2" width="43.6" height="43.6" rx="14" fill="url(#${id}g)" stroke="${stroke}" filter="url(#${id}d)"/>
            <path d="M9 13c6-7 24-6 30 0" fill="none" stroke="url(#${id}h)" stroke-width="6" stroke-linecap="round" opacity="0.9"/>
            ${inner}
          </svg>
        `;
      }
      function mark(letter, color) {
        const baseA = shade(color, 0.88);
        const baseB = shade(color, 1.08);
        const inner = `
          <g>
            <circle cx="24" cy="24" r="14" fill="rgba(255,255,255,0.18)"/>
            <text x="50%" y="56%" text-anchor="middle" font-size="${letter.length > 2 ? 14 : 18}" font-family="Inter,Segoe UI,Arial" font-weight="800" fill="rgba(255,255,255,0.95)">${letter}</text>
          </g>
        `;
        return appIconShell(inner, {
          bgA: baseA,
          bgB: baseB,
          stroke: "rgba(255,255,255,.18)",
        });
      }
      function logo(name, letter, color) {
        return { name, svg: mark(letter, color) };
      }
      function multiLogo(name, colors) {
        const inner = `
          <g transform="translate(7 9)">
            <rect x="0" y="0" width="34" height="30" rx="10" fill="rgba(255,255,255,0.35)"/>
            ${colors
              .map((c, i) => `<rect x="${5 + i * 7}" y="6" width="5" height="18" rx="3" fill="${c}" opacity="0.95"></rect>`)
              .join("")}
          </g>
        `;
        return { name, svg: appIconShell(inner, { bgA: "#FFFFFF", bgB: "#EEF2FF" }) };
      }
      function triLogo(name, r1, r2, r3, r4) {
        const inner = `
          <g>
            <circle cx="24" cy="24" r="14" fill="${r4}" opacity="0.95"/>
            <path d="M24 10 A14 14 0 0 1 38 24 L24 24 Z" fill="${r1}"/>
            <path d="M38 24 A14 14 0 0 1 24 38 L24 24 Z" fill="${r2}"/>
            <path d="M24 38 A14 14 0 0 1 24 10 L24 24 Z" fill="${r3}"/>
          </g>
        `;
        return { name, svg: appIconShell(inner, { bgA: "#FFFFFF", bgB: "#F8FAFC" }) };
      }
      function ringLogo(name, c1, c2) {
        const inner = `
          <g>
            <circle cx="24" cy="24" r="13.5" fill="${c1}" opacity="0.95"/>
            <circle cx="20" cy="20" r="9" fill="${c2}" opacity="0.95"/>
            <circle cx="24" cy="24" r="7.5" fill="rgba(255,255,255,0.35)"/>
          </g>
        `;
        return { name, svg: appIconShell(inner, { bgA: "#FFFFFF", bgB: "#F1F5F9" }) };
      }
      function flameLogo(name, c1, c2) {
        const inner = `
          <g>
            <path d="M24 10c6 8-2 10 3 16 4 4 3 11-3 13-6-2-8-9-4-13 6-6-3-8 4-16z" fill="${c1}" opacity="0.95"/>
            <circle cx="26" cy="29" r="4.5" fill="${c2}" opacity="0.95"/>
          </g>
        `;
        return { name, svg: appIconShell(inner, { bgA: "#FFFFFF", bgB: "#FEF3C7" }) };
      }
      const miniApps = [
        logo("Microsoft Word", "W", "#185ABD"),
        logo("Microsoft Teams", "T", "#5B53D6"),
        logo("SAP", "SAP", "#0A6ED1"),
        logo("Zoom", "Z", "#0B5CFF"),
      ];
      const CATALOG = [
        {
          title: "CORE PRODUCTIVITY",
          id: "cat-core",
          items: [
            logo("Microsoft Word", "W", "#185ABD"),
            logo("Microsoft Excel", "X", "#107C41"),
            logo("PowerPoint", "P", "#D24726"),
            logo("Outlook", "O", "#106EBE"),
            logo("Microsoft Teams", "T", "#5B53D6"),
            logo("Google Docs", "Dc", "#1A73E8"),
            logo("Google Sheets", "Sh", "#1E8E3E"),
            logo("Google Slides", "Sl", "#F9AB00"),
          ],
        },
        {
          title: "MESSAGING & MEETINGS",
          id: "cat-collab",
          items: [
            multiLogo("Slack", ["#36C5F0", "#2EB67D", "#E01E5A", "#ECB22E"]),
            logo("Zoom", "Z", "#0B5CFF"),
            logo("Gmail", "G", "#EA4335"),
            logo("Google Meet", "GM", "#0F9D58"),
          ],
        },
        {
          title: "WEB BROWSERS",
          id: "cat-browsers",
          items: [
            triLogo("Google Chrome", "#EA4335", "#FBBC05", "#34A853", "#4285F4"),
            ringLogo("Microsoft Edge", "#0C8EC5", "#0AA0A3"),
            flameLogo("Mozilla Firefox", "#FF7139", "#FFCC00"),
          ],
        },
        {
          title: "ENTERPRISE APPS",
          id: "cat-enterprise",
          items: [
            logo("Salesforce", "SF", "#00A1E0"),
            logo("Workday", "WD", "#1F5BFF"),
            logo("ServiceNow", "SN", "#0F766E"),
            logo("SAP", "SAP", "#0A6ED1"),
            logo("Oracle NetSuite", "NS", "#C74634"),
          ],
        },
        {
          title: "SECURITY & ACCESS",
          id: "cat-security",
          items: [
            logo("Duo", "D", "#16A34A"),
            logo("Okta", "O", "#007DC1"),
            logo("Ping Identity", "P", "#C0172C"),
            logo("Cisco AnyConnect", "AC", "#0EA5E9"),
            logo("Microsoft Defender", "MD", "#0067B8"),
            logo("CrowdStrike Falcon", "CS", "#D61F26"),
          ],
        },
        {
          title: "STORAGE & CREATIVE",
          id: "cat-storage",
          items: [
            logo("Adobe Acrobat", "A", "#ED2224"),
            logo("Dropbox", "DB", "#0061FF"),
            logo("Box", "BX", "#0061D5"),
            logo("OneDrive", "OD", "#0A5BD5"),
            logo("ZoomIt / Sysinternals", "ZI", "#334155"),
          ],
        },
      ];
      const appConfigs = [
        { stage: "Prod", policy: "MFA + VPN", region: "AMER", device: "Windows" },
        { stage: "QA", policy: "Compliant only", region: "APAC", device: "Any" },
        { stage: "Dev", policy: "MFA required", region: "EMEA", device: "Mac" },
        { stage: "Prod", policy: "VPN only", region: "Global", device: "Windows" },
        { stage: "QA", policy: "MFA required", region: "AMER", device: "Any" },
        { stage: "Dev", policy: "MFA required", region: "APAC", device: "Mac" },
        { stage: "Prod", policy: "Compliant only", region: "EMEA", device: "Windows" },
        { stage: "QA", policy: "VPN only", region: "Global", device: "Any" },
      ];
      let flatIndex = 0;
      CATALOG.forEach((sec) =>
        sec.items.forEach((itm) => {
          itm.config = appConfigs[flatIndex % appConfigs.length];
          flatIndex++;
        })
      );
      /* =========================
         PER-USER CURRENT STATE STORAGE (UNCHANGED)
         ========================= */
      const USER_ID = String(window.APP_USER_ID || "guest");
      const PAGE_SCOPE = location.origin + location.pathname + location.search;
      const STORAGE_KEY = `currentState:${USER_ID}:${PAGE_SCOPE}`;
      const ITEMS_KEY = `items:${USER_ID}:${PAGE_SCOPE}`;
      let DEFAULT_CURRENT_STATE = null;
      const $ = (sel, ctx = document) => ctx.querySelector(sel);
      const fields = {
        changeIntro: () => $("#changeIntro"),
        changeBullets: () => $("#changeBullets"),
        changeAnalyst: () => $("#changeAnalyst"),
        nowIntro: () => $("#nowIntro"),
        nowBullets: () => $("#nowBullets"),
        nowAnalyst: () => $("#nowAnalyst"),
        recastIntro: () => $("#recastIntro"),
        recastBullets: () => $("#recastBullets"),
        recastAnalyst: () => $("#recastAnalyst"),
      };
      function captureDefaultsOnce() {
        if (DEFAULT_CURRENT_STATE) return;
        DEFAULT_CURRENT_STATE = STATE.defaultsCurrentState();
      }
      function readFields() {
        return {
          change: {
            intro: fields.changeIntro()?.value ?? "",
            bullets: fields.changeBullets()?.value ?? "",
            analyst: fields.changeAnalyst()?.value ?? "",
          },
          now: {
            intro: fields.nowIntro()?.value ?? "",
            bullets: fields.nowBullets()?.value ?? "",
            analyst: fields.nowAnalyst()?.value ?? "",
          },
          recast: {
            intro: fields.recastIntro()?.value ?? "",
            bullets: fields.recastBullets()?.value ?? "",
            analyst: fields.recastAnalyst()?.value ?? "",
          },
        };
      }
      function writeFields(data) {
        if (!data) return;
        if (fields.changeIntro()) fields.changeIntro().value = data.change.intro ?? "";
        if (fields.changeBullets()) fields.changeBullets().value = data.change.bullets ?? "";
        if (fields.changeAnalyst()) fields.changeAnalyst().value = data.change.analyst ?? "";
        if (fields.nowIntro()) fields.nowIntro().value = data.now.intro ?? "";
        if (fields.nowBullets()) fields.nowBullets().value = data.now.bullets ?? "";
        if (fields.nowAnalyst()) fields.nowAnalyst().value = data.now.analyst ?? "";
        if (fields.recastIntro()) fields.recastIntro().value = data.recast.intro ?? "";
        if (fields.recastBullets()) fields.recastBullets().value = data.recast.bullets ?? "";
        if (fields.recastAnalyst()) fields.recastAnalyst().value = data.recast.analyst ?? "";
      }
      function loadDraft() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          return raw ? JSON.parse(raw) : null;
        } catch {
          return null;
        }
      }
      function saveDraft(payload) {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
        } catch (e) {
          console.warn("Save failed (storage blocked or full):", e);
        }
      }
      function clearDraft() {
        try {
          localStorage.removeItem(STORAGE_KEY);
        } catch {}
      }
      function loadItems() {
        try {
          const raw = localStorage.getItem(ITEMS_KEY);
          return raw ? JSON.parse(raw) : [];
        } catch {
          return [];
        }
      }
      function saveItems() {
        try {
          localStorage.setItem(ITEMS_KEY, JSON.stringify(STATE.items));
        } catch (e) {
          console.warn("Items save failed:", e);
        }
      }
      function initCurrentStateModal() {
        captureDefaultsOnce();
        const draft = loadDraft();
        if (draft) writeFields(draft);
        const saveBtn = $("#btnSaveCurrentState");
        const resetBtn = $("#btnResetCurrentState");
        if (saveBtn && !saveBtn.dataset.wired) {
          saveBtn.dataset.wired = "1";
          saveBtn.addEventListener("click", (e) => {
            e.preventDefault();
            saveDraft(readFields());
          });
        }
        if (resetBtn && !resetBtn.dataset.wired) {
          resetBtn.dataset.wired = "1";
          resetBtn.addEventListener("click", (e) => {
            e.preventDefault();
            clearDraft();
            writeFields(DEFAULT_CURRENT_STATE);
            STATE.currentState = STATE.defaultsCurrentState();
            render();
          });
        }
      }
      /* =========================
         CURRENT STATE EDITOR MODAL (UNCHANGED)
         ========================= */
      function renderModal() {
        if (!STATE.modalOpen) return "";
        const buf = STATE.editBuffers;
        const toLines = (arr) => arr.join("\n");
        const ensure = (v) => v ?? "";
        return `
          <div role="dialog" aria-modal="true" aria-labelledby="cs-editor-title" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 overflow-auto p-4 md:p-8 animate-overlayFade">
            <div class="w-[95vw] h-[95vh] bg-white rounded-2xl shadow-2xl p-6 overflow-y-auto animate-modalEnter">
              <div class="flex items-center justify-between">
                <h2 id="cs-editor-title" class="text-lg font-medium tracking-normal">Edit Current State</h2>
                <button type="button" class="bg-transparent text-gray-900 p-1.5 focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2 rounded" data-action="close-modal" aria-label="Close">
                  <i data-lucide="x" class="w-3.5 h-3.5"></i>
                </button>
              </div>
              <p class="mt-0.5 text-[13px] text-gray-700">Edit the introduction, bullets (one per line, max 4), and analyst trend for each section.</p>
              <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-2">
                ${editorSection(
                  "change",
                  "Why Change",
                  ensure(buf.change.intro) || STATE.currentState.change.intro,
                  ensure(buf.change.bullets) || toLines(STATE.currentState.change.bullets),
                  ensure(buf.change.analyst) || STATE.currentState.change.analyst
                )}
                ${editorSection(
                  "now",
                  "Why Now",
                  ensure(buf.now.intro) || STATE.currentState.now.intro,
                  ensure(buf.now.bullets) || toLines(STATE.currentState.now.bullets),
                  ensure(buf.now.analyst) || STATE.currentState.now.analyst
                )}
                ${editorSection(
                  "recast",
                  "Why Recast",
                  ensure(buf.recast.intro) || STATE.currentState.recast.intro,
                  ensure(buf.recast.bullets) || toLines(STATE.currentState.recast.bullets),
                  ensure(buf.recast.analyst) || STATE.currentState.recast.analyst
                )}
              </div>
              <div class="mt-4 flex flex-wrap gap-1.5">
                <button id="btnSaveCurrentState" type="button" data-action="save-currentstate" class="inline-flex items-center gap-1.5 bg-blue-600 text-white px-3 py-1.5 text-[13px] font-semibold focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2 rounded hover:bg-blue-700">
                  <i data-lucide="save" class="w-3.5 h-3.5"></i> Save
                </button>
                <button id="btnResetCurrentState" type="button" data-action="reset-currentstate-defaults" class="inline-flex items-center gap-1.5 bg-transparent text-gray-900 border-2 border-gray-900 px-3 py-1.5 text-[13px] font-semibold focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2 rounded hover:text-blue-600 hover:border-blue-600">
                  <i data-lucide="rotate-ccw" class="w-3.5 h-3.5"></i> Reset to default
                </button>
              </div>
            </div>
          </div>
        `;
      }
      function editorSection(key, label, introValue, bulletsValue, analystValue) {
        return `
          <div class="flex flex-col gap-3">
            <span class="text-[13px] font-medium">${label}</span>
            <label class="flex flex-col gap-0.5">
              <span class="text-[11px] text-gray-700">Introduction</span>
              <textarea id="${key}Intro" data-action="edit-buffer" data-key="${key}" data-subkey="intro" class="min-h-[70px] rounded border border-gray-200 bg-white p-2.5 text-[13px] leading-relaxed focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2" aria-label="${label} introduction editor" rows="2">${introValue}</textarea>
            </label>
            <label class="flex flex-col gap-0.5">
              <div class="flex items-center gap-1.5 text-[11px] text-gray-700">
                <i data-lucide="check-circle" class="w-3.5 h-3.5 text-blue-600"></i>
                Bullets (one per line, max 4)
              </div>
              <textarea id="${key}Bullets" data-action="edit-buffer" data-key="${key}" data-subkey="bullets" class="min-h-[140px] rounded border border-gray-200 bg-white p-2.5 text-[13px] leading-relaxed focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2" aria-label="${label} bullets editor" rows="5">${bulletsValue}</textarea>
            </label>
            <label class="flex flex-col gap-0.5">
              <span class="text-[11px] text-gray-700">Analyst Trend</span>
              <textarea id="${key}Analyst" data-action="edit-buffer" data-key="${key}" data-subkey="analyst" class="min-h-[70px] rounded border border-gray-200 bg-white p-2.5 text-[13px] leading-relaxed focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2" aria-label="${label} analyst editor" rows="2">${analystValue}</textarea>
            </label>
          </div>
        `;
      }
      /* =========================
         EVENTS
         ========================= */
      function attachEvents() {
        const root = document.getElementById("app");
        // Tabs
        root.querySelectorAll('[data-action="switch-tab"]').forEach((b) =>
          b.addEventListener("click", (e) => {
            const next = e.currentTarget.getAttribute("data-tab");
            STATE.activeTab = next;
            // stop any running flow visuals when leaving the tab
            // Reset wizard when entering Solution for a clean narrative
            if (next === "solution") {
              STATE.solutionStep = 0;
              STATE.visitedCards = [NEW_CARDS[0].id];
            } else {
              STATE.visitedCards = [];
            }
            render();
          })
        );
        // Generic tab jump (used by wizard final CTA)
        root.querySelectorAll('[data-action="go-tab"]').forEach((b) =>
          b.addEventListener("click", (e) => {
            const tab = e.currentTarget.getAttribute("data-tab");
            if (!tab) return;
            STATE.activeTab = tab;
            render();
          })
        );
        // Why modal
        root.querySelectorAll('[data-action="open-why-modal"]').forEach((b) =>
          b.addEventListener("click", (e) => {
            STATE.openWhyModal = e.currentTarget.getAttribute("data-why");
            render();
          })
        );
        root.querySelectorAll('[data-action="close-why-modal"]').forEach((b) =>
          b.addEventListener("click", () => {
            STATE.openWhyModal = null;
            render();
          })
        );
        root.querySelectorAll('[data-action="advance"]').forEach((b) =>
          b.addEventListener("click", (e) => {
            STATE.activeTab = e.currentTarget.getAttribute("data-next");
            STATE.openWhyModal = null;
            render();
          })
        );
        // Problems selections
        root.querySelectorAll('[data-action="toggle-bullet"]').forEach((inp) =>
          inp.addEventListener("change", (e) => {
            const category = e.target.getAttribute("data-category");
            const index = parseInt(e.target.getAttribute("data-index"), 10);
            if (!STATE.selectedBullets[category]) STATE.selectedBullets[category] = [];
            const arr = STATE.selectedBullets[category];
            if (arr.includes(index)) {
              STATE.selectedBullets[category] = arr.filter((x) => x !== index);
            } else {
              arr.push(index);
            }
            render();
          })
        );
        root.querySelectorAll('[data-action="reset-bullets"]').forEach((b) =>
          b.addEventListener("click", () => {
            STATE.selectedBullets = {};
            render();
          })
        );
        root.querySelectorAll('[data-action="next-tab"]').forEach((b) =>
          b.addEventListener("click", () => {
            STATE.activeTab = "solution";
            STATE.solutionStep = 0;
            STATE.visitedCards = [NEW_CARDS[0].id];
            render();
          })
        );
        // Solution wizard navigation
        root.querySelectorAll('[data-action="solution-prev-card"]').forEach((b) =>
          b.addEventListener("click", () => {
            STATE.solutionStep = Math.max(0, STATE.solutionStep - 1);
            const id = NEW_CARDS[STATE.solutionStep]?.id;
            if (id && !STATE.visitedCards.includes(id)) STATE.visitedCards.push(id);
            render();
          })
        );
        root.querySelectorAll('[data-action="solution-next-card"]').forEach((b) =>
          b.addEventListener("click", () => {
            STATE.solutionStep = Math.min(NEW_CARDS.length - 1, STATE.solutionStep + 1);
            const id = NEW_CARDS[STATE.solutionStep]?.id;
            if (id && !STATE.visitedCards.includes(id)) STATE.visitedCards.push(id);
            render();
          })
        );
        root.querySelectorAll('[data-action="solution-jump-card"]').forEach((b) =>
          b.addEventListener("click", (e) => {
            const idx = Number(e.currentTarget.getAttribute("data-index"));
            if (!Number.isFinite(idx)) return;
            STATE.solutionStep = Math.max(0, Math.min(NEW_CARDS.length - 1, idx));
            const id = NEW_CARDS[STATE.solutionStep]?.id;
            if (id && !STATE.visitedCards.includes(id)) STATE.visitedCards.push(id);
            render();
          })
        );
        // Card bullet selections (still used inside wizard)
        root.querySelectorAll('[data-action="toggle-card-bullet"]').forEach((inp) =>
          inp.addEventListener("change", (e) => {
            const card = e.target.getAttribute("data-card");
            const index = parseInt(e.target.getAttribute("data-index"), 10);
            if (!STATE.selectedCardBullets[card]) STATE.selectedCardBullets[card] = [];
            const arr = STATE.selectedCardBullets[card];
            if (arr.includes(index)) {
              STATE.selectedCardBullets[card] = arr.filter((x) => x !== index);
            } else {
              arr.push(index);
            }
            render();
          })
        );
        // Buckets
        root.querySelectorAll('[data-action="toggle-bucket"]').forEach((b) =>
          b.addEventListener("click", (e) => {
            const id = e.currentTarget.getAttribute("data-bucket");
            STATE.openBuckets[id] = !STATE.openBuckets[id];
            render();
          })
        );
        // ROI inputs
        root.querySelectorAll('[data-action="set-device"]').forEach((b) =>
          b.addEventListener("click", (e) => {
            STATE.ctx.device = e.currentTarget.getAttribute("data-value");
            render();
          })
        );
        root.querySelectorAll('[data-action="set-network"]').forEach((b) =>
          b.addEventListener("click", (e) => {
            STATE.ctx.network = e.currentTarget.getAttribute("data-value");
            render();
          })
        );
        root.querySelectorAll('[data-action="toggle-compliance"]').forEach((b) =>
          b.addEventListener("click", () => {
            STATE.ctx.compliant = !STATE.ctx.compliant;
            render();
          })
        );
        const pack = root.querySelector('[data-action="set-pack-hrs"]');
        if (pack)
          pack.addEventListener("input", (e) => {
            STATE.packHrs = cleanNum(e.target.value);
            render();
          });
        const cfg = root.querySelector('[data-action="set-config-hrs"]');
        if (cfg)
          cfg.addEventListener("input", (e) => {
            STATE.configHrs = cleanNum(e.target.value);
            render();
          });
        const cur = root.querySelector('[data-action="set-current-hrs"]');
        if (cur)
          cur.addEventListener("input", (e) => {
            STATE.currentHrs = cleanNum(e.target.value);
            render();
          });
        root.querySelectorAll('[data-action="add-impact"]').forEach((b) =>
          b.addEventListener("click", (e) => {
            const kind = e.currentTarget.getAttribute("data-kind");
            const val = Number(e.currentTarget.getAttribute("data-value")) || 0;
            if (kind === "minutes") STATE.impact.minutes += val;
            if (kind === "pkgHours") STATE.impact.pkgHours += val;
            if (kind === "riskHrs") STATE.impact.riskHrs += val;
            render();
          })
        );
        root.querySelectorAll('[data-action="set-roi"]').forEach((inp) =>
          inp.addEventListener("input", (e) => {
            const key = e.currentTarget.getAttribute("data-key");
            const v = Number(String(e.target.value).replace(/[^0-9.\-]/g, ""));
            STATE.roiInputs[key] = isFinite(v) ? v : 0;
            render();
          })
        );
        root.querySelectorAll('[data-action="set-impact"]').forEach((inp) =>
          inp.addEventListener("input", (e) => {
            const key = e.currentTarget.getAttribute("data-key");
            const v = Number(String(e.target.value).replace(/[^0-9.\-]/g, ""));
            STATE.impact[key] = isFinite(v) ? v : 0;
            render();
          })
        );
        root.querySelectorAll('[data-action="set-view"]').forEach((b) =>
          b.addEventListener("click", (e) => {
            STATE.activeView = e.currentTarget.getAttribute("data-view");
            render();
          })
        );
        const resetCalc = root.querySelector('[data-action="reset-calculator"]');
        if (resetCalc)
          resetCalc.addEventListener("click", () => {
            STATE.roiInputs = { users: 5000, ticketsPerUserPerMonth: 0.035, avgHandleMins: 18 };
            STATE.impact = { ...STATE.defaults.impact };
            STATE.copied = false;
            render();
          });
        // Flow controls
        const startBtn = root.querySelector('[data-action="start-flow"]');
        if (startBtn) startBtn.addEventListener("click", startFlow);
        const resetBtn = root.querySelector('[data-action="reset-flow"]');
        if (resetBtn) resetBtn.addEventListener("click", resetFlow);
        // App launch animation
        root.querySelectorAll('[data-action="launch-icon"]').forEach((icon) =>
          icon.addEventListener("click", () => {
            icon.classList.add("animate-iconLaunch");
            setTimeout(() => icon.classList.remove("animate-iconLaunch"), 500);
          })
        );
        // Modal controls
        root.querySelectorAll('[data-action="close-modal"]').forEach((b) =>
          b.addEventListener("click", () => {
            STATE.modalOpen = false;
            render();
          })
        );
        // Buffer inputs
        root.querySelectorAll('[data-action="edit-buffer"]').forEach((el) =>
          el.addEventListener("input", (evt) => {
            const key = el.getAttribute("data-key");
            const subkey = el.getAttribute("data-subkey");
            if (!STATE.editBuffers[key]) return;
            STATE.editBuffers[key][subkey] = evt.target.value;
          })
        );
        // New: Item manager and viewer events
        root.querySelectorAll('[data-action="open-item-manager"]').forEach((b) =>
          b.addEventListener("click", () => {
            STATE.itemManagerOpen = true;
            render();
          })
        );
        root.querySelectorAll('[data-action="close-item-manager"]').forEach((b) =>
          b.addEventListener("click", () => {
            STATE.itemManagerOpen = false;
            render();
          })
        );
        root.querySelectorAll('[data-action="upload-more-images"]').forEach((b) =>
          b.addEventListener("click", () => {
            const input = document.getElementById("imageUploadManager");
            if (input) input.click();
          })
        );
        const managerUploadInput = document.getElementById("imageUploadManager");
        if (managerUploadInput) {
          managerUploadInput.addEventListener("change", (e) => {
            const currentLength = STATE.items.length;
            const files = Array.from(e.target.files).slice(0, 5 - currentLength);
            files.forEach((file) => {
              const reader = new FileReader();
              reader.onload = (evt) => {
                STATE.items.push({type: 'image', src: evt.target.result});
                render();
              };
              reader.readAsDataURL(file);
            });
          });
        }
        root.querySelectorAll('[data-action="add-embed"]').forEach((b) =>
          b.addEventListener("click", () => {
            const input = document.getElementById("embedUrlInput");
            const raw = input.value.trim();
            if (!raw) return;
            const sanitized = sanitizeEmbed(raw);
            if (sanitized) {
              STATE.items.push({type: 'embed', src: sanitized});
              input.value = '';
              render();
            } else {
              alert('Invalid embed URL or iframe. Must be a valid HTTPS URL.');
            }
          })
        );
        root.querySelectorAll('[data-action="move-item-up"]').forEach((b) =>
          b.addEventListener("click", (e) => {
            const i = Number(e.currentTarget.getAttribute("data-index"));
            if (i > 0) {
              [STATE.items[i - 1], STATE.items[i]] = [STATE.items[i], STATE.items[i - 1]];
              render();
            }
          })
        );
        root.querySelectorAll('[data-action="move-item-down"]').forEach((b) =>
          b.addEventListener("click", (e) => {
            const i = Number(e.currentTarget.getAttribute("data-index"));
            if (i < STATE.items.length - 1) {
              [STATE.items[i], STATE.items[i + 1]] = [STATE.items[i + 1], STATE.items[i]];
              render();
            }
          })
        );
        root.querySelectorAll('[data-action="delete-item-manager"]').forEach((b) =>
          b.addEventListener("click", (e) => {
            const i = Number(e.currentTarget.getAttribute("data-index"));
            STATE.items.splice(i, 1);
            saveItems();
            render();
          })
        );
        root.querySelectorAll('[data-action="save-items"]').forEach((b) =>
          b.addEventListener("click", () => {
            saveItems();
            STATE.itemManagerOpen = false;
            render();
          })
        );
        root.querySelectorAll('[data-action="open-item-viewer"]').forEach((b) =>
          b.addEventListener("click", () => {
            STATE.itemViewerOpen = true;
            STATE.currentItemIndex = 0;
            STATE.theaterMode = false; // Reset theater mode on open
            render();
          })
        );
        root.querySelectorAll('[data-action="close-item-viewer"]').forEach((b) =>
          b.addEventListener("click", () => {
            STATE.itemViewerOpen = false;
            STATE.theaterMode = false;
            render();
          })
        );
        root.querySelectorAll('[data-action="prev-item"]').forEach((b) =>
          b.addEventListener("click", () => {
            if (STATE.currentItemIndex > 0) {
              STATE.currentItemIndex--;
              render();
            }
          })
        );
        root.querySelectorAll('[data-action="next-item"]').forEach((b) =>
          b.addEventListener("click", () => {
            if (STATE.currentItemIndex < STATE.items.length - 1) {
              STATE.currentItemIndex++;
              render();
            }
          })
        );
        root.querySelectorAll('[data-action="delete-item"]').forEach((b) =>
          b.addEventListener("click", (e) => {
            const i = Number(e.currentTarget.getAttribute("data-index"));
            STATE.items.splice(i, 1);
            saveItems();
            if (STATE.currentItemIndex >= STATE.items.length) STATE.currentItemIndex = STATE.items.length - 1;
            if (STATE.items.length === 0) STATE.itemViewerOpen = false;
            render();
          })
        );
        root.querySelectorAll('[data-action="toggle-theater"]').forEach((b) =>
          b.addEventListener("click", () => {
            STATE.theaterMode = !STATE.theaterMode;
            render();
          })
        );
        // New: Value tab switching and edit toggle
        root.querySelectorAll('[data-action="switch-value-tab"]').forEach((b) =>
          b.addEventListener("click", (e) => {
            STATE.valueTab = e.currentTarget.getAttribute("data-tab");
            STATE.isValueEditing = false; // Reset edit mode on tab switch
            render();
          })
        );
        root.querySelectorAll('[data-action="toggle-value-edit"]').forEach((b) =>
          b.addEventListener("click", () => {
            if (STATE.isValueEditing) {
              // Save mode: store content
              const activePanel = document.getElementById(STATE.valueTab + 'Tab');
              if (activePanel) {
                activePanel.querySelectorAll('.editable').forEach(el => {
                  localStorage.setItem(el.id, el.innerHTML);
                });
              }
            }
            STATE.isValueEditing = !STATE.isValueEditing;
            render(); // Re-render to toggle contenteditable and buttons
          })
        );
        root.querySelectorAll('[data-action="reset-value"]').forEach((b) =>
          b.addEventListener("click", resetValueContent)
        );
        // Apply contenteditable after render if editing
        if (STATE.isValueEditing) {
          const activePanel = document.getElementById(STATE.valueTab + 'Tab');
          if (activePanel) {
            activePanel.querySelectorAll('.editable').forEach(el => {
              el.contentEditable = 'true';
              el.focus(); // Optional: focus first for UX
            });
          }
        }
        // New: Solution modal openers
        root.querySelectorAll('[data-action="open-solution-modal"]').forEach((b) =>
          b.addEventListener("click", (e) => {
            const modalId = e.currentTarget.getAttribute("data-modal");
            STATE.openSolutionModal = modalId;
            STATE.solutionOpenerId = e.currentTarget.id;
            render();
          })
        );
      }
      /* =========================
         FLOW BUILD + ANIMATION (V1 VERSION)
         ========================= */
      let flowTimeouts = [];
      function buildFlow() {
        let base = 0;
        CATALOG.forEach((section) => {
          const mount = document.getElementById(section.id);
          if (!mount) return;
          mount.innerHTML = "";
          section.items.forEach((itm, idx) => {
            const wrap = document.createElement("div");
            wrap.className =
              "flex items-center gap-1 relative transition-all duration-300 show-labels:flex-col show-labels:items-start show-labels:gap-[0.2rem] show-labels:w-[calc(33.333%-0.666rem)] show-labels:mb-1";
            wrap.style.setProperty("--d", (base + idx * 0.2).toFixed(2) + "s");
            const ring = document.createElement("div");
            ring.className =
              "w-[1.95rem] h-[1.95rem] rounded-[0.85rem] grid place-items-center bg-white shadow-[0_8px_18px_rgba(15,23,42,0.06)] ring-1 ring-[rgba(15,23,42,0.08)] transition-all duration-300 hover:shadow-[0_10px_24px_rgba(37,99,235,0.14)] hover:ring-[rgba(37,99,235,0.22)] hover:scale-[1.03] show-labels:w-[1.7rem] show-labels:h-[1.7rem] show-labels:rounded-[0.75rem]";
            ring.innerHTML = itm.svg;
            ring.title = itm.name;
            ring.setAttribute("role", "img");
            ring.setAttribute("aria-label", itm.name);
            wrap.appendChild(ring);
            if (STATE.showLabels) {
              const label = document.createElement("span");
              label.className =
                "text-[0.6rem] text-gray-500 opacity-0 -translate-x-[10px] transition-all duration-300 show-labels:opacity-100 show-labels:translate-x-0 whitespace-normal text-left";
              label.textContent = itm.name;
              wrap.appendChild(label);
              const meta = document.createElement("div");
              meta.className =
                "text-[0.5rem] text-gray-500 opacity-0 translate-y-[5px] transition-all duration-300 relative top-auto left-auto z-[5] whitespace-nowrap flex flex-col gap-[0.1rem] items-start w-full justify-start show-labels:opacity-100 show-labels:translate-y-0";
              meta.innerHTML = `<span>Stage: ${itm.config.stage}</span><span>Policy: ${itm.config.policy}</span><span>Region: ${itm.config.region}</span><span>Device: ${itm.config.device}</span>`;
              wrap.appendChild(meta);
            }
            mount.appendChild(wrap);
          });
          base += 1.2;
        });
        buildTiles(document.getElementById("flowConnA"), 14, 3);
        buildTiles(document.getElementById("flowConnB"), 14, 3.5);
        buildTiles(document.getElementById("flowConnC"), 14, 4);
        buildTiles(document.getElementById("flowGrpA"), 18, 5);
        buildTiles(document.getElementById("flowGrpB"), 18, 5.5);
        buildTiles(document.getElementById("flowGrpC"), 18, 6);
        buildTiles(document.getElementById("flowDevA"), 10, 8);
        buildTiles(document.getElementById("flowDevB"), 10, 8.5);
        buildTiles(document.getElementById("flowDevC"), 10, 9);
        const avatar = document.getElementById("endUserAvatar");
        const badge = document.getElementById("endUserBadge");
        if (avatar) {
          avatar.classList.add("bg-red-600");
          avatar.classList.remove("bg-green-500");
          avatar.textContent = "U";
        }
        if (badge) {
          badge.textContent = "!";
          badge.classList.add("bg-red-600");
          badge.classList.remove("bg-green-500");
          badge.style.opacity = "0";
          badge.style.transform = "translateY(-6px) scale(0.9)";
        }
        const message = document.getElementById("endUserMessage");
        if (message) message.textContent = "Same workspace for the user — even as IT changes platforms behind the scenes.";
        const mini = document.getElementById("miniWorkspace");
        if (mini) mini.classList.add("hidden");
        const counters = document.getElementById("progressCounters");
        if (counters) counters.classList.add("hidden");
        const card = document.getElementById("flowCard");
        if (card) {
          card.classList.remove("run");
        }
        const endCard = document.getElementById("endUserCard");
        if (endCard) endCard.classList.remove("end-user-expand");
        const token = document.querySelector(".flow-token");
        if (token) token.classList.remove("animating");
        document.querySelectorAll(".active").forEach(el => el.classList.remove("active"));
        document.querySelectorAll(".delivered-app").forEach(el => el.classList.remove("visible"));
        const hub = document.querySelector(".recast-hub");
        if (hub) hub.classList.remove("pulsing");
        STATE.progress = { apps: 0, time: 0, tickets: 0 };
        updateProgress();
        const success = document.getElementById("flowSuccess");
        if (success) success.classList.add("hidden");
      }
      function buildTiles(container, count, baseDelay) {
        if (!container) return;
        container.innerHTML = "";
        for (let i = 0; i < count; i++) {
          const d = document.createElement("div");
          d.className = "w-[0.4rem] h-[0.4rem] rounded-[2px] bg-gray-200 opacity-90";
          d.setAttribute("data-anim", "tilePulse");
          d.style.setProperty("--d", (baseDelay + i * 0.1).toFixed(2) + "s");
          container.appendChild(d);
        }
      }
      function startFlow() {
        flowTimeouts.forEach(clearTimeout);
        flowTimeouts = [];
        const card = document.getElementById("flowCard");
        if (!card) return;
        card.classList.remove("run");
        void card.offsetWidth;
        card.classList.add("run");
        const flash = document.getElementById("flowHubFlash");
        const success = document.getElementById("flowSuccess");
        const avatar = document.getElementById("endUserAvatar");
        const badge = document.getElementById("endUserBadge");
        const message = document.getElementById("endUserMessage");
        const mini = document.getElementById("miniWorkspace");
        const counters = document.getElementById("progressCounters");
        const endCard = document.getElementById("endUserCard");
        if (flash) {
          flash.classList.remove("hidden");
          flowTimeouts.push(setTimeout(() => flash.classList.add("hidden"), 2000));
        }
        if (success) success.classList.add("hidden");
        if (counters) counters.classList.remove("hidden");
        let interval = setInterval(updateProgress, 100);
        flowTimeouts.push(setTimeout(() => clearInterval(interval), 11000));
        // New: Top flow token animation
        const token = document.querySelector(".flow-token");
        if (token) {
          token.classList.add("animating");
          // Highlight labels as token passes
          flowTimeouts.push(setTimeout(() => {
            document.getElementById("label-managers").classList.add("highlight");
            setTimeout(() => document.getElementById("label-managers").classList.remove("highlight"), 300);
          }, 1000)); // At 33%
          flowTimeouts.push(setTimeout(() => {
            document.getElementById("label-recast").classList.add("highlight");
            setTimeout(() => document.getElementById("label-recast").classList.remove("highlight"), 300);
            // Pulse hub
            const hub = document.querySelector(".recast-hub");
            if (hub) hub.classList.add("pulsing");
          }, 2000)); // At 66%
          flowTimeouts.push(setTimeout(() => {
            document.getElementById("label-user").classList.add("highlight");
            setTimeout(() => document.getElementById("label-user").classList.remove("highlight"), 300);
          }, 3000)); // At 100%
          // Repeat logic if needed, but since animation-iteration-count=3, highlights can be timed accordingly
        }
        // New: Backend cascade
        const cascadeSections = [
          ...document.querySelectorAll("#platformsSection > div"),
          ...document.querySelectorAll("#groupsSection > div"),
          ...document.querySelectorAll("#devicesSection > div")
        ];
        cascadeSections.forEach((section, i) => {
          flowTimeouts.push(setTimeout(() => {
            section.classList.add("active");
            flowTimeouts.push(setTimeout(() => section.classList.remove("active"), 400));
          }, 4000 + i * 400)); // Start after ~4s, 400ms per
        });
        // New: Fan-out to devices after cascade (approx 4s + 4*400ms = 5.6s)
        const deviceBoxes = document.querySelectorAll("#devicesSection > div");
        deviceBoxes.forEach((box, i) => {
          flowTimeouts.push(setTimeout(() => {
            const app = box.querySelector(".delivered-app");
            if (app) app.classList.add("visible");
          }, 6000 + i * 300));
        });
        setTimeout(() => {
          if (avatar) {
            avatar.style.background = 'var(--re-green)';
          }
          if (badge) {
            badge.textContent = '✓';
            badge.style.background = 'var(--re-green)';
          }
          if (message) message.textContent = 'Apps on demand — no waiting, no tickets. Workspace launches the correct app instantly.';
          if (mini) mini.classList.remove("hidden");
          if (endCard) endCard.classList.add("end-user-expand");
          if (success) success.classList.remove("hidden");
        }, 11000);
        setTimeout(() => card.classList.remove("run"), 12000);
      }
      function updateProgress() {
        if (STATE.progress.apps < 128) STATE.progress.apps += 4;
        if (STATE.progress.time < 46) STATE.progress.time += 2;
        if (STATE.progress.tickets < 73) STATE.progress.tickets += 3;
        const apps = STATE.progress.apps > 128 ? 128 : STATE.progress.apps;
        const time = STATE.progress.time > 46 ? 46 : STATE.progress.time;
        const tickets = STATE.progress.tickets > 73 ? 73 : STATE.progress.tickets;
        setText("appsProcessed", apps);
        setText("timeSaved", time);
        setText("ticketsAvoided", tickets);
      }
      function setText(id, value) {
        const el = document.getElementById(id);
        if (el) el.textContent = String(value);
      }
      function resetFlow() {
        flowTimeouts.forEach(clearTimeout);
        flowTimeouts = [];
        STATE.progress = { apps: 0, time: 0, tickets: 0 };
        STATE.showLabels = false;
        buildFlow();
      }
      /* =========================
         ESC HANDLING (safe, attach once)
         ========================= */
      let escapeWired = false;
      function wireEscapeOnce() {
        if (escapeWired) return;
        escapeWired = true;
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && (STATE.modalOpen || STATE.openWhyModal || STATE.itemViewerOpen || STATE.itemManagerOpen || STATE.openSolutionModal)) {
            if (STATE.openSolutionModal) {
              closeSolutionModal();
            } else {
              STATE.modalOpen = false;
              STATE.openWhyModal = null;
              STATE.itemViewerOpen = false;
              STATE.itemManagerOpen = false;
              STATE.theaterMode = false;
              render();
            }
          }
        });
      }
      /* =========================
         BOOT
         ========================= */
      document.addEventListener("DOMContentLoaded", () => {
        wireEscapeOnce();
        // Load cached items
        STATE.items = loadItems();
        // Ensure wizard has a starting “explored” state
        STATE.visitedCards = [NEW_CARDS[0].id];
        render();
      });
    </script>
  </body>
</html>
