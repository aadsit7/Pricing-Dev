<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Recast ‚Äî Compact Click-Through (Realistic Catalog)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="dark light">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://unpkg.com">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      :root {
        --bg-main: #f9fafb;
        --text-primary: #111827;
        --primary: #0070F3;
        --primary-hover: #005AD0;
        --radius: 1rem;
        --border-subtle: #e5e7eb;
        --shadow-card: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        --shadow-hover: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      }
      html, body {
        background: var(--bg-main);
        color: var(--text-primary);
        font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      }
      .focus-ring:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; }
      .section-card { border-radius: var(--radius); background: #ffffff; box-shadow: var(--shadow-card); transition: box-shadow 300ms ease, transform 300ms ease; }
      .section-card:hover { box-shadow: var(--shadow-hover); transform: translateY(-2px); }
      .sub-card { border-radius: calc(var(--radius) / 1.5); border: 1px solid var(--border-subtle); background: #f9fafb; transition: box-shadow 300ms ease; }
      .tile { width: 0.45rem; height: 0.45rem; border-radius: 2px; background: #e5e7eb; opacity: 0.9; }
      .run .tile { animation: tilePulse 1s ease-in-out var(--d, 0s) 1 forwards; }
      @keyframes tilePulse { 0% { transform: scale(0.7); background: #e5e7eb; opacity: 0.4; } 60% { transform: scale(1); background: var(--primary); opacity: 1; } 100% { background: #e5e7eb; opacity: 0.9; } }
      .flow-bar { height: 0.22rem; border-radius: 2px; transform-origin: left center; transform: scaleX(0); }
      .run .flow-bar { animation: barGrow 0.9s ease forwards var(--d, 0s); }
      @keyframes barGrow { to { transform: scaleX(1); } }
      .bolt-line { width: 0.22rem; border-radius: 2px; transform-origin: top center; transform: scaleY(0); }
      .run .bolt-line { animation: boltDrop 0.9s ease forwards var(--d, 0s); }
      @keyframes boltDrop { to { transform: scaleY(1); } }
      .logo-ring { width: 2.1rem; height: 2.1rem; border-radius: 9999px; display: grid; place-items: center; background: #ffffff; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1); transition: all 0.3s ease; }
      .logo-ring:hover { box-shadow: 0 0 8px rgba(37,99,235,0.3); transform: scale(1.05); }
      .logo-wrap { display: flex; align-items: center; gap: 0.4rem; position: relative; transition: all 300ms ease; }
      .logo-name { font-size: 0.7rem; color: #6b7280; opacity: 0; transform: translateX(-10px); transition: all 0.3s ease; }
      .show-labels .logo-wrap { flex-direction: column; align-items: flex-start; gap: 0.2rem; }
      .show-labels .logo-name { opacity: 1; transform: translateX(0); white-space: normal; text-align: left; }
      .show-labels .logo-wrap .logo-ring { width: 1.8rem; height: 1.8rem; }
      .run .logo-ring { animation: appLiftPulse 1.2s cubic-bezier(0.2, 0.8, 0.2, 1) var(--d, 0s) 1 forwards; }
      @keyframes appLiftPulse { 0% { transform: translateY(0) scale(1); filter: saturate(0.4); opacity: 0.65; } 30% { transform: translateY(-4px) scale(1.05); } 60% { transform: translateY(-2px) scale(1.02); filter: saturate(1); opacity: 1; } 100% { transform: translateY(0) scale(1); } }
      .user-beam { height: 0.38rem; border-radius: 2px; transform-origin: left center; transform: scaleX(0); }
      .run .user-beam { animation: barGrow 1s ease forwards var(--d, 0s); }
      .badge { width: 1.15rem; height: 1.15rem; border-radius: 9999px; opacity: 0; transform: translateY(-6px) scale(0.9); }
      .run .badge { animation: badgeDrop 0.8s ease-out var(--d, 0s) forwards; }
      @keyframes badgeDrop { to { opacity: 1; transform: translateY(0) scale(1); } }
      .cat-row { display: grid; grid-template-columns: 15ch 1fr; gap: 0.5rem; align-items: center; border-top: 1px solid #e5e7eb; padding-top: 0.5rem; transition: all 300ms ease; }
      .cat-row:first-child { border-top: none; padding-top: 0; }
      .cat-title { font-size: 0.7rem; letter-spacing: 0.08em; display: flex; align-items: center; gap: 0.5rem; }
      .re-primary { background: var(--primary) !important; color: #fff !important; border: 0; border-radius: 9999px; padding: 0.5rem 1.5rem; transition: background 0.2s ease, transform 0.2s ease; }
      .re-primary:hover { background: var(--primary-hover) !important; transform: scale(1.02); }
      .re-primary:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; }
      .re-secondary { background: transparent !important; color: var(--text-primary) !important; border: 2px solid var(--text-primary) !important; border-radius: 9999px; padding: 0.5rem 1.5rem; transition: all 0.2s ease, transform 0.2s ease; }
      .re-secondary:hover { color: var(--primary) !important; border-color: var(--primary) !important; transform: scale(1.02); }
      @media (prefers-reduced-motion: reduce) {
        .accordion-content { transition: none !important; }
      }
      .modal-overlay { transition: opacity 300ms ease; }
      .modal-content { transition: transform 300ms cubic-bezier(0.2, 0.8, 0.2, 1), opacity 300ms ease; }
      .modal-open .modal-content { transform: scale(1); opacity: 1; }
      .modal-closed .modal-content { transform: scale(0.95); opacity: 0; }
      .check-appear{opacity:0;animation:fadeInOut 1.5s ease var(--d,0s) forwards}
      @keyframes fadeInOut{0%{opacity:0}30%{opacity:1}70%{opacity:1}100%{opacity:0}}
      .flow-connect{background-image:linear-gradient(to right, transparent 50%, #e5e7eb 50%);background-size:4px 1px;background-repeat:repeat-x;height:1px;opacity:0.5}
      .end-user-expand{transition:all 0.5s ease;transform:scale(1.05);background:#ffffff;border-color:#10b981}
      .icon-launch{animation:iconLaunch 0.5s ease forwards}
      @keyframes iconLaunch{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}
      .tagline-fade{opacity:0;animation:fadeIn 1s ease 10s forwards}
      @keyframes fadeIn{to{opacity:1}}
      .overlay-tag{opacity:0;transition:opacity 0.3s ease;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,0.9);padding:1rem;border-radius:var(--radius);box-shadow:var(--shadow-card);z-index:10}
      .show-labels .overlay-tag{opacity:1;transition-delay:0.5s}
      .meta-label{font-size:0.6rem;color:#6b7280;opacity:0;transform:translateY(5px);transition:all 0.3s ease;position:relative;top:auto;left:auto;z-index:5;white-space:nowrap;display:flex;flex-direction:column;gap:0.1rem;align-items:flex-start;width:100%;justify-content:flex-start}
      .show-labels .meta-label{opacity:1;transform:translateY(0)}
      .show-labels .cat-row{grid-template-columns:15ch 1fr;gap:1rem}
      .show-labels #flowCard .flex-wrap{gap:1rem}
      .show-labels .logo-wrap{width:calc(33.333% - 0.666rem);margin-bottom:0.5rem}
    </style>
  </head>
  <body class="min-h-screen antialiased">
    <div id="app" class="min-h-screen px-6 lg:px-12 grid gap-6"></div>
    <script>
      const STATE = {
        activeTab: 'problems',
        impact: { minutes: 9, pkgHours: 6, riskHrs: 22.5 },
        defaults: { impact: { minutes: 9, pkgHours: 6, riskHrs: 22.5 } },
        ctx: { device: 'Windows', network: 'Corporate', compliant: true },
        packHrs: 8, configHrs: 2, currentHrs: 24,
        roiInputs: { users: 5000, ticketsPerUserPerMonth: 0.035, avgHandleMins: 18 },
        copied: false,
        showLabels: false,
        showSolutionCards: true,
        openWhy: null,
        openWhyModal: null,
        openCards: { core: false, onboarding: false, trust: false },
        visitedCards: [],
        openBuckets: { one: false, zero: false, per: false },
        modalOpen: false,
        editBuffers: { change: { intro: '', bullets: '', analyst: '' }, now: { intro: '', bullets: '', analyst: '' }, recast: { intro: '', bullets: '', analyst: '' } },
        currentState: {
          change: {
            intro: "The app layer has become the biggest slowdown in IT. Teams are drowning in apps, constant updates, and one-off fixes, and every project ends up paying the price.",
            bullets: [
              'There are too many apps to manage by hand. Commercial, internal, and legacy software are spread across Intune, ConfigMgr, VDI, Windows, and macOS.',
              'Headcount hasn‚Äôt grown, but the work has exploded. Most teams are already over capacity and spend most of their day reacting to app issues.',
              'Big initiatives keep getting stuck. Cloud moves, Citrix or AVD projects, hardware refreshes, and AI efforts all run into the same wall ‚Äî app readiness.',
              'Technical debt keeps piling up. Different versions of the same app are everywhere, creating more risk, more tickets, and slower recovery when things break.'
            ],
            analyst: "When the application layer is a mess, transformation projects stall or fail. It‚Äôs not because the strategy is wrong, but because there‚Äôs no capacity left to execute."
          },
          now: {
            intro: "IT teams are being asked to manage more apps and more change with the same people and the same tools. The gap between what‚Äôs expected and what‚Äôs possible keeps getting wider.",
            bullets: [
              'App updates and complexity keep increasing, but team size stays the same. You can‚Äôt scale people the way you scale software.',
              'Internal and custom apps don‚Äôt update themselves, so every change adds more manual work, more dependencies, and more risk.',
              'Leadership wants progress on AI, modernization, and new platforms, but the teams who could drive that progress are stuck keeping apps running.',
              'The longer this goes on, the worse it gets. Version sprawl grows, security and compliance get harder, and cleanup costs rise fast.'
            ],
            analyst: "In the next few years, the organizations that succeed with AI and modernization will be the ones that fix app delivery first. Everyone else will hit a hard capacity wall."
          },
          recast: {
            intro: "Recast‚Äôs Application Workspace solves the core problem. It gives IT one place to package, update, and manage every application so the app layer stops slowing everything down.",
            bullets: [
              'One workspace for every app, whether commercial, internal, or legacy. Installs, updates, and access all handled consistently across Intune, ConfigMgr, AVD, and other systems.',
              'Automates what teams still do by hand ‚Äî packaging, versioning, and pushing updates, especially for internal and custom apps.',
              'Reduces technical debt and version sprawl, which means fewer variables when something breaks and far fewer app-related tickets.',
              'Frees up IT capacity. What used to take hours now takes minutes, so migrations, pilots, patch cycles, and AI projects can finally move at business speed.'
            ],
            analyst: "Recast turns app management from a drag on every project into a stable foundation. Readiness stops being the blocker and becomes the default."
          }
        },
        defaultsCurrentState() {
          return JSON.parse(JSON.stringify({
            change: {
              intro: "The app layer has become the biggest slowdown in IT. Teams are drowning in apps, constant updates, and one-off fixes, and every project ends up paying the price.",
              bullets: [
                'There are too many apps to manage by hand. Commercial, internal, and legacy software are spread across Intune, ConfigMgr, VDI, Windows, and macOS.',
                'Headcount hasn‚Äôt grown, but the work has exploded. Most teams are already over capacity and spend most of their day reacting to app issues.',
                'Big initiatives keep getting stuck. Cloud moves, Citrix or AVD projects, hardware refreshes, and AI efforts all run into the same wall ‚Äî app readiness.',
                'Technical debt keeps piling up. Different versions of the same app are everywhere, creating more risk, more tickets, and slower recovery when things break.'
              ],
              analyst: "When the application layer is a mess, transformation projects stall or fail. It‚Äôs not because the strategy is wrong, but because there‚Äôs no capacity left to execute."
            },
            now: {
              intro: "IT teams are being asked to manage more apps and more change with the same people and the same tools. The gap between what‚Äôs expected and what‚Äôs possible keeps getting wider.",
              bullets: [
                'App updates and complexity keep increasing, but team size stays the same. You can‚Äôt scale people the way you scale software.',
                'Internal and custom apps don‚Äôt update themselves, so every change adds more manual work, more dependencies, and more risk.',
                'Leadership wants progress on AI, modernization, and new platforms, but the teams who could drive that progress are stuck keeping apps running.',
                'The longer this goes on, the worse it gets. Version sprawl grows, security and compliance get harder, and cleanup costs rise fast.'
              ],
              analyst: "In the next few years, the organizations that succeed with AI and modernization will be the ones that fix app delivery first. Everyone else will hit a hard capacity wall."
            },
            recast: {
              intro: "Recast‚Äôs Application Workspace solves the core problem. It gives IT one place to package, update, and manage every application so the app layer stops slowing everything down.",
              bullets: [
                'One workspace for every app, whether commercial, internal, or legacy. Installs, updates, and access all handled consistently across Intune, ConfigMgr, AVD, and other systems.',
                'Automates what teams still do by hand ‚Äî packaging, versioning, and pushing updates, especially for internal and custom apps.',
                'Reduces technical debt and version sprawl, which means fewer variables when something breaks and far fewer app-related tickets.',
                'Frees up IT capacity. What used to take hours now takes minutes, so migrations, pilots, patch cycles, and AI projects can finally move at business speed.'
              ],
              analyst: "Recast turns app management from a drag on every project into a stable foundation. Readiness stops being the blocker and becomes the default."
            }
          }));
        },
        progress: { apps: 0, time: 0, tickets: 0 }
      };
      const TABS = [
        { id: 'problems', label: 'Current State', icon: 'alert-triangle' },
        { id: 'solution', label: 'Recast Approach', icon: 'workflow' },
        { id: 'roi', label: 'Business Impact', icon: 'bar-chart-3' }
      ];
      const NEW_CARDS = [
        {
          id: 'core',
          icon: 'layers',
          title: 'How Recast Does It.',
          bullets: [
            'One workspace to package, deploy, update, and retire apps across Intune, SCCM, Citrix, Omnissa, and Azure.',
            '8,000+ pre-tested enterprise apps ready to deploy instantly.',
            'Automated patching and validation keep apps secure and compliant.',
            'Unified dashboard for visibility and governance across all environments.',
            'Policy-driven automation reduces manual work by over 60%.',
            'End users get the right app instantly ‚Äî no tickets, no delays.'
          ],
          closer: 'Configured once ‚Äî Delivered everywhere.',
          timeline: false,
          bgHeader: 'bg-[#f9fafb]',
          bgContent: 'bg-[#f9fafb]'
        },
        {
          id: 'onboarding',
          icon: 'clock',
          title: 'Onboard & Up to Speed Fast.',
          bullets: [
            'Standard rollout in 4‚Äì6 weeks (Kickoff ‚Äî Implementation ‚Äî UAT ‚Äî Launch ‚Äî Enablement).',
            'No new infrastructure ‚Äî integrates with your existing management tools.',
            'Guided setup with dedicated Customer Success Manager.',
            'Typical resource: 1‚Äì2 IT engineers part-time.',
            'Enablement includes training, certification, and success planning.'
          ],
          closer: 'From first call to production in weeks, not months.',
          timeline: true,
          bgHeader: 'bg-[#f9fafb]',
          bgContent: 'bg-[#f9fafb]'
        },
        {
          id: 'trust',
          icon: 'shield-check',
          title: 'Trusted by Customers',
          bullets: [
            '60M+ endpoints across 130+ countries.',
            '70k+ Customers & Trusted by global organizations| Citibank, McKinsey & Company, U.S. Air Force, FEMA, Hitachi, Johns Hopkins, Costco, Government of Canada.',
            '87 CSAT Score | Most trusted in the industry',
            'Proven scalability from small pilots to global deployments.',
            'Backed by enterprise-grade support and compliance alignment (SOC 2, ISO 27001).'
          ],
          closer: 'Trusted by organizations that can‚Äôt afford downtime.',
          timeline: false,
          bgHeader: 'bg-[#f9fafb]',
          bgContent: 'bg-[#f9fafb]'
        }
      ];
      const onboardingMiniTimelineEnabled = true;
      function cx(...a){ return a.filter(Boolean).join(' '); }
      function round(n){ return Math.round(n*100)/100; }
      function num(n){ return new Intl.NumberFormat().format(Math.round(n)); }
      function routeRecommendation(ctx){
        if(!ctx.compliant) return 'Web';
        if(ctx.device==='Windows' && ctx.network!=='Home') return 'Local';
        return 'VDI';
      }
      function cleanNum(v){ v = Number(String(v).replace(/[^0-9.\-]/g,'')); return isFinite(v) ? v : 0; }
      function render(){
        const root=document.getElementById('app');
        root.innerHTML = `
          <header class="pt-8 pb-6">
            <h1 class="text-3xl font-semibold leading-tight">Recast Software</h1>
            <p class="mt-2 max-w-2xl text-base text-gray-700 leading-relaxed">
              Recast works across SCCM, Intune, Citrix, VMware Workspace ONE, and more‚Äîmaking the tools you already use faster, smarter, and easier to manage.
            </p>
            <nav class="mt-6 flex overflow-x-auto gap-2" role="tablist" aria-label="Demo sections">
              ${TABS.map(t=>`
                <button role="tab" class="${cx('flex items-center gap-2 px-6 py-2 rounded-full text-base font-medium transition-all duration-300 focus-ring', STATE.activeTab===t.id ? 'bg-blue-600 text-white shadow-sm' : 'bg-white text-gray-700')}" data-action="switch-tab" data-tab="${t.id}" aria-selected="${STATE.activeTab===t.id}">
                  <i data-lucide="${t.icon}" class="w-5 h-5"></i>${t.label}
                </button>
              `).join('')}
            </nav>
          </header>
          <main class="pb-16">${renderActivePanel()}</main>
          ${renderModal()}
          ${renderWhyModal()}
        `;
        lucide.createIcons();
        attachEvents();
        if (STATE.activeTab === 'solution') { buildFlow(); }
        if (STATE.activeTab === 'roi') { updateROIOutputs(); }
        if (STATE.activeTab === 'solution') { attachAccordionKeyboard(); }
      }
      function chip(label,value,tone){
        const tones={emerald:'from-emerald-400/80 to-teal-400/80',sky:'from-sky-400/80 to-indigo-400/80',yellow:'from-yellow-300/90 to-amber-400/90'};
        return `
          <div class="section-card p-6 rounded-2xl bg-white shadow-md hover:shadow-lg transition-shadow duration-300">
            <div class="text-base text-gray-700">${label}</div>
            <div class="mt-2 inline-flex items-center gap-2 rounded-full bg-gradient-to-r px-4 py-2 text-gray-900 ${tones[tone]}">
              <i data-lucide="badge-check" class="w-5 h-5"></i><span class="text-xl font-semibold tabular-nums">${value}</span>
            </div>
          </div>
        `;
      }
      function renderActivePanel(){
        if (STATE.activeTab==='problems') return renderProblems();
        if (STATE.activeTab==='solution') return renderSolution();
        if (STATE.activeTab==='roi') return renderROI();
        return '';
      }
      function renderProblems(){
        const items=[
          {t:'Fragmented delivery',s:'Windows / Mac / VDI / Web ‚Äî users guess the right way.',i:'layers'},
          {t:'Packaging backlog',s:'Rebuild per version; updates stall.',i:'boxes'},
          {t:'Zero-day exposure',s:'Patching takes days, not minutes.',i:'shield'},
          {t:'Slow upgrades',s:'Stuck to old images; change is slow.',i:'layout-grid'}
        ];
        return `
          <section id="panel-problems" class="grid gap-6">
            <div class="grid grid-cols-12 gap-6">
              ${items.map(p=>`
                <article class="col-span-3 section-card p-6 rounded-2xl bg-white shadow-md hover:shadow-lg transition-shadow duration-300">
                  <div class="flex items-center gap-2"><i data-lucide="${p.i}" class="w-6 h-6 text-blue-600"></i><h3 class="text-xl font-medium">${p.t}</h3></div>
                  <p class="mt-2 text-base text-gray-700 leading-relaxed">${p.s}</p>
                </article>
              `).join('')}
            </div>
            <div class="grid grid-cols-12 gap-6">
              ${calloutDropdown('change','alert-triangle','Why Change','bg-white')}
              ${calloutDropdown('now','clock-4','Why Now','bg-white')}
              ${calloutDropdown('recast','sparkles','Why Recast','bg-white', true)}
            </div>
          </section>
        `;
      }
      function calloutDropdown(id, icon, label, headerTone, cta=false){
        return `
          <div class="col-span-4">
            <button
              type="button"
              class="w-full section-card p-6 rounded-2xl bg-white shadow-md hover:shadow-lg transition-shadow duration-300 focus-ring"
              data-action="open-why-modal"
              data-why="${id}"
            >
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <i data-lucide="${icon}" class="w-6 h-6 text-blue-600" aria-hidden="true"></i>
                  <span class="text-xl font-medium">${label}</span>
                </div>
                <i data-lucide="chevron-right" class="w-6 h-6 text-gray-700 transition-transform duration-150" aria-hidden="true"></i>
              </div>
            </button>
          </div>
        `;
      }
      function renderWhyModal(){
        if(!STATE.openWhyModal) return '';
        const id = STATE.openWhyModal;
        const iconMap = { change: 'alert-triangle', now: 'clock-4', recast: 'sparkles' };
        const labelMap = { change: 'Why Change', now: 'Why Now', recast: 'Why Recast' };
        const data = STATE.currentState[id];
        const cta = id === 'recast';
        return `
          <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/20 modal-overlay" role="dialog" aria-modal="true" aria-labelledby="why-modal-title-${id}">
            <div class="w-full max-w-4xl mx-4 bg-white rounded-2xl shadow-md overflow-hidden transform modal-content" style="max-height: 95vh; overflow-y: auto;">
              <div class="px-12 py-6 flex items-center justify-between border-b border-gray-200">
                <div class="flex items-center gap-3">
                  <i data-lucide="${iconMap[id]}" class="w-8 h-8 text-blue-600" aria-hidden="true"></i>
                  <h2 id="why-modal-title-${id}" class="text-3xl font-medium leading-tight text-gray-900">${labelMap[id]}</h2>
                </div>
                <button type="button" class="text-gray-500 hover:text-gray-700 focus-ring p-2" data-action="close-why-modal" aria-label="Close">
                  <i data-lucide="x" class="w-6 h-6"></i>
                </button>
              </div>
              <div class="p-12">
                <p class="text-base text-gray-700 leading-relaxed mb-6">${data.intro}</p>
                <div class="space-y-4">
                  ${data.bullets.map(b=>`
                    <div class="bg-white p-6 rounded-2xl shadow-md flex items-start gap-3 hover:shadow-lg transition-shadow duration-300">
                      <i data-lucide="check-circle" class="w-6 h-6 text-blue-600 flex-shrink-0 mt-0.5"></i>
                      <p class="text-base text-gray-700 leading-relaxed">${b}</p>
                    </div>
                  `).join('')}
                </div>
                <div class="mt-6 bg-white p-6 rounded-2xl shadow-md hover:shadow-lg transition-shadow duration-300 flex items-start gap-3">
                  <i data-lucide="lightbulb" class="w-6 h-6 text-yellow-400 flex-shrink-0 mt-0.5"></i>
                  <p class="text-base italic text-gray-700 leading-relaxed">${data.analyst}</p>
                </div>
                ${cta?`
                  <div class="mt-8 flex justify-center">
                    <button id="btnAdvanceToSolution" type="button" data-action="advance" data-next="solution" class="inline-flex bg-blue-600 hover:bg-blue-700 text-white text-base font-medium px-6 py-3 items-center gap-3 rounded-full shadow-sm focus-ring transition-shadow duration-300">
                      <i data-lucide="arrow-right" class="w-5 h-5"></i>
                      How Recast solves it
                    </button>
                  </div>
                `:''}
              </div>
            </div>
          </div>
        `;
      }
      function popoutCard(card){
        const expanded = STATE.openCards[card.id];
        const contentId = `card-content-${card.id}`;
        return `
          <div class="section-card rounded-2xl bg-white shadow-md hover:shadow-lg transition-shadow duration-300 overflow-hidden">
            <button
              type="button"
              class="accordion-header w-full p-6 flex justify-between items-center focus-ring"
              data-action="toggle-card"
              data-card="${card.id}"
              aria-expanded="${expanded}"
              aria-controls="${contentId}"
            >
              <div class="flex items-center gap-2">
                <i data-lucide="${card.icon}" class="w-6 h-6 text-blue-600" aria-hidden="true"></i>
                <span class="text-xl font-medium text-gray-900">${card.title}</span>
              </div>
              <i data-lucide="chevron-down" class="w-6 h-6 text-gray-700 transition-transform duration-300 ${expanded ? 'rotate-180' : ''}" aria-hidden="true"></i>
            </button>
            <div id="${contentId}" class="accordion-content px-6 pb-6 overflow-hidden" style="max-height:${expanded?'1200px':'0'};opacity:${expanded?'1':'0'};transition:max-height 300ms cubic-bezier(0.2, 0.8, 0.2, 1),opacity 300ms ease">
              <ul class="list-disc pl-6 space-y-3 text-base text-gray-700 leading-relaxed">
                ${card.bullets.map(b=>`<li>${b}</li>`).join('')}
              </ul>
              ${card.timeline && onboardingMiniTimelineEnabled && expanded ? renderMiniTimeline() : ''}
              <p class="mt-4 italic text-base text-gray-700 leading-relaxed">${card.closer}</p>
            </div>
          </div>
        `;
      }
      function renderMiniTimeline(){
        const phases = [
          {icon: 'play-circle', label: 'Kickoff'},
          {icon: 'hammer', label: 'Implementation'},
          {icon: 'check-circle', label: 'UAT'},
          {icon: 'flag', label: 'Launch'},
          {icon: 'book-open', label: 'Enablement'}
        ];
        return `
          <div class="flex items-center justify-between mt-4" aria-hidden="true">
            ${phases.map((p, i) => `
              ${i > 0 ? '<div class="flex-1 h-px bg-gray-200 mx-2"></div>' : ''}
              <div class="flex flex-col items-center">
                <i data-lucide="${p.icon}" class="w-5 h-5 text-blue-600"></i>
                <span class="text-sm mt-1 text-gray-700">${p.label}</span>
              </div>
            `).join('')}
          </div>
        `;
      }
      function bucketAccordion(id, icon, label, contentFunc, headerTone='bg-white'){
        const expanded = STATE.openBuckets[id];
        const contentId = `bucket-content-${id}`;
        return `
          <div class="section-card rounded-2xl bg-white shadow-md hover:shadow-lg transition-shadow duration-300 overflow-hidden">
            <button
              type="button"
              class="w-full p-6 flex justify-between items-center focus-ring"
              data-action="toggle-bucket"
              data-bucket="${id}"
              aria-expanded="${expanded}"
              aria-controls="${contentId}"
            >
              <div class="flex items-center gap-2">
                <i data-lucide="${icon}" class="w-6 h-6 text-blue-600" aria-hidden="true"></i>
                <span class="text-xl font-medium text-gray-900">${label}</span>
              </div>
              <i data-lucide="${expanded?'chevron-up':'chevron-down'}" class="w-6 h-6 text-gray-700 transition-transform duration-300" aria-hidden="true"></i>
            </button>
            <div id="${contentId}" class="accordion-content px-6 pb-6 overflow-hidden" style="max-height:${expanded?'1200px':'0'};opacity:${expanded?'1':'0'};transition:max-height 300ms cubic-bezier(0.2, 0.8, 0.2, 1),opacity 300ms ease">
              ${expanded ? contentFunc() : ''}
            </div>
          </div>
        `;
      }
      function onePackageContent(){
        const saved=Math.max(0, Number(STATE.packHrs)-Number(STATE.configHrs));
        return `
          <div class="p-6">
            <div class="sub-card p-6 rounded-2xl border border-gray-200">
              <div class="flex items-center gap-2 text-xl font-medium"><i data-lucide="wand-sparkles" class="w-6 h-6"></i> Hours Saved from Packaging</div>
              <label class="mt-4 flex items-center gap-2 text-base">
                <span class="text-gray-700">Hours/package</span>
                <input class="w-20 rounded-full bg-gray-100 px-4 py-2 focus-ring" value="${STATE.packHrs}" inputmode="decimal" data-action="set-pack-hrs" aria-label="Hours per package">
                <span>‚Üí</span>
                <input class="w-20 rounded-full bg-gray-100 px-4 py-2 focus-ring" value="${STATE.configHrs}" inputmode="decimal" data-action="set-config-hrs" aria-label="Hours to configure">
              </label>
              <div class="mt-4 flex items-center justify-between rounded-full bg-gray-100 px-4 py-2"><span class="tabular-nums">${STATE.packHrs} ‚Üí ${STATE.configHrs} hrs</span><strong class="tabular-nums">${saved} hrs saved</strong></div>
              <div class="mt-4 flex flex-wrap gap-2">
                <span class="rounded-full px-4 py-2 bg-gray-100 text-base">‚òÅÔ∏è Cloud</span>
                <span class="rounded-full px-4 py-2 bg-gray-100 text-base">üñ•Ô∏è On-Prem</span>
                <span class="rounded-full px-4 py-2 bg-gray-100 text-base">üîÄ Hybrid</span>
              </div>
              <button type="button" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 text-base font-medium w-full rounded-full shadow-sm focus-ring transition-shadow duration-300" data-action="add-impact" data-kind="pkgHours" data-value="${saved}">Add to impact</button>
            </div>
          </div>
        `;
      }
      function zeroDayContent(){
        const reduced=Math.max(0, Number(STATE.currentHrs)-1.5);
        return `
          <div class="p-6">
            <div class="sub-card p-6 rounded-2xl border border-gray-200">
              <div class="flex items-center gap-2 text-xl font-medium"><i data-lucide="shield-check" class="w-6 h-6"></i> Hours Saved from Faster Patching</div>
              <label class="mt-4 flex items-center gap-2 text-base">
                <span class="text-gray-700">Current hrs</span>
                <input class="w-24 rounded-full bg-gray-100 px-4 py-2 focus-ring" value="${STATE.currentHrs}" inputmode="decimal" data-action="set-current-hrs" aria-label="Current time to deploy (hours)">
              </label>
              <div class="mt-4 flex items-center justify-between rounded-full bg-gray-100 px-4 py-2"><span class="tabular-nums">${STATE.currentHrs} ‚Üí 1.5 hrs</span><strong class="tabular-nums">${round(reduced)} hrs reduced</strong></div>
              <button type="button" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 text-base font-medium w-full rounded-full shadow-sm focus-ring transition-shadow duration-300" data-action="add-impact" data-kind="riskHrs" data-value="${reduced}">Add to impact</button>
            </div>
          </div>
        `;
      }
      function perUserContent(){
        const totalMin = Math.max(0, Number(STATE.impact.minutes));
        return `
          <div class="p-6">
            <div class="sub-card p-6 rounded-2xl border border-gray-200">
              <div class="flex items-center gap-2 text-xl font-medium"><i data-lucide="mouse-pointer" class="w-6 h-6"></i> Reactive Work Reduced</div>
              <div class="mt-4 flex items-center justify-between rounded-full bg-gray-100 px-4 py-2">
                <span class="tabular-nums">18 ‚Üí ${totalMin} min</span>
                <strong class="tabular-nums">${totalMin} min saved</strong>
              </div>
            </div>
            <div class="mt-4 grid grid-cols-3 gap-2">
              ${['Windows','Mac'].map(d=>pill(d,STATE.ctx.device===d,'set-device',d)).join('')}
              ${['Corporate','VPN'].map(n=>pill(n,STATE.ctx.network===n,'set-network',n)).join('')}
              ${pill(STATE.ctx.compliant?'Compliant':'Non-compliant',STATE.ctx.compliant,'toggle-compliance','')}
            </div>
            <div class="mt-4"><button type="button" class="bg-white text-gray-900 border border-gray-300 hover:border-blue-600 px-6 py-3 text-base w-full rounded-full shadow-sm focus-ring transition-shadow duration-300" data-action="add-impact" data-kind="minutes" data-value="2">Add to impact (+2 min saved per user)</button></div>
          </div>
        `;
      }
      function renderSolution(){
        return `
          <section id="panel-solution" class="grid grid-cols-12 gap-6">
            <div class="col-span-6 section-card p-6 rounded-2xl bg-white shadow-md hover:shadow-lg transition-shadow duration-300">
              ${renderFlow()}
            </div>
            <div class="col-span-6 flex flex-col gap-6">
              ${NEW_CARDS.map(card => popoutCard(card)).join('')}
            </div>
          </section>
        `;
      }
      function pill(label,active,action,value){
        return `<button type="button" class="${cx('px-4 py-2 border text-base rounded-full transition-shadow duration-300 focus-ring',active?'bg-blue-600 text-white shadow-sm':'bg-white text-gray-900 border-gray-300 hover:border-blue-600')}" data-action="${action}" data-value="${String(value)}">${label}</button>`;
      }
      function renderFlow(){
        return `
            <div class="flex items-center justify-between gap-3">
              <div class="flex items-center gap-2">
                <div class="h-8 w-8 rounded-full grid place-items-center bg-gray-900"><i data-lucide="boxes" class="h-5 w-5 text-white"></i></div>
                <div>
                  <h3 class="text-xl font-medium">Application Workspace</h3>
                  <div class="text-base text-gray-700">Curated & secured catalog</div>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <button type="button" class="bg-white text-gray-900 border border-gray-300 hover:border-blue-600 px-4 py-2 rounded-full text-base focus-ring transition-shadow duration-300" data-action="toggle-labels">${STATE.showLabels?'Hide':'Show'} labels</button>
                <button type="button" data-action="start-flow" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full text-base font-medium shadow-sm focus-ring transition-shadow duration-300">Start</button>
                <button type="button" data-action="reset-flow" class="bg-white text-gray-900 border border-gray-300 hover:border-blue-600 px-4 py-2 rounded-full text-base focus-ring transition-shadow duration-300">Reset</button>
              </div>
            </div>
            <div id="flowCard" class="mt-6 sub-card p-6 rounded-2xl relative bg-gradient-to-b from-white to-gray-50 shadow-inner ${STATE.showLabels ? 'show-labels' : ''}" role="region" aria-label="Animated flow">
              <div id="progressCounters" class="hidden mb-4 grid grid-cols-3 gap-4 text-base text-center">
                <div><span class="font-medium tabular-nums" id="appsProcessed">0</span> apps processed</div>
                <div><span class="font-medium tabular-nums" id="timeSaved">0</span> hours saved</div>
                <div><span class="font-medium tabular-nums" id="ticketsAvoided">0</span> tickets avoided</div>
              </div>
              <div class="space-y-4 relative">
                ${CATALOG.map(s=>`
                  <div class="cat-row">
                    <div class="cat-title uppercase text-gray-700 text-base"><i data-lucide="folder" class="w-5 h-5"></i>${s.title}</div>
                    <div id="${s.id}" class="flex flex-wrap gap-4"></div>
                  </div>
                `).join('')}
                <div id="overlayTag" class="overlay-tag hidden text-center text-base text-gray-700">Every app mapped to stage, policy, region, and device.</div>
              </div>
              <div id="flowHubFlash" class="mt-4 hidden text-blue-600"><span class="inline-flex items-center gap-2 text-base"><i data-lucide="bolt" class="h-5 w-5"></i><span>Update published</span></span></div>
              <div class="mt-6 grid grid-cols-3 gap-4 relative" aria-hidden="true">
                ${['A','B','C'].map((k,i)=>`
                  <div class="sub-card p-4 rounded-2xl border border-gray-200 relative">
                    <div class="text-base text-gray-700">${['Existing Platforms','Staged Rings','Access & Policy'][i]}</div>
                    <div id="flowConn${k}" class="mt-2 grid grid-cols-10 gap-2"></div>
                    <div class="mt-2 flow-bar w-full rounded-full" style="background:linear-gradient(to right,#0070F3,#005AD0);--d:${3 + .5*i}s"></div>
                    <i data-lucide="check-circle" class="check-appear absolute top-2 right-2 w-5 h-5 text-green-500" style="--d:${4 + .5*i}s"></i>
                  </div>
                `).join('')}
                <div class="flow-connect absolute top-[-0.5rem] left-0 w-full"></div>
              </div>
              <div class="mt-6 grid grid-cols-3 gap-4 relative" aria-hidden="true">
                ${['A','B','C'].map((k,i)=>`
                  <div class="sub-card p-4 rounded-2xl border border-gray-200 relative">
                    <div class="text-base text-gray-700">${['Business Unit','Subsidiary','Region'][i]}</div>
                    <div id="flowGrp${k}" class="mt-2 grid grid-cols-8 gap-2"></div>
                    <div class="mx-auto mt-2 bolt-line h-16 w-1 rounded-full" style="background:linear-gradient(to bottom,#0A1C60,#0070F3);--d:${5 + .5*i}s"></div>
                    <i data-lucide="shield-check" class="check-appear absolute top-2 right-2 w-5 h-5 text-green-500" style="--d:${6 + .5*i}s"></i>
                  </div>
                `).join('')}
                <div class="flow-connect absolute top-[-0.5rem] left-0 w-full"></div>
              </div>
              <div class="mt-6 grid grid-cols-3 gap-4 relative" aria-hidden="true">
                ${['A','B','C'].map((k,i)=>`
                  <div class="sub-card p-4 rounded-2xl border border-gray-200 text-center relative">
                    <i data-lucide="${['monitor-smartphone','laptop','smartphone'][i]}" class="h-6 w-6 text-gray-700"></i>
                    <div id="flowDev${k}" class="mt-2 grid grid-cols-6 gap-2"></div>
                    <div class="mt-2 text-base text-gray-700">${['Windows & macOS','VDI / Web','Mobile'][i]}</div>
                    <i data-lucide="check-circle" class="check-appear absolute top-2 right-2 w-5 h-5 text-green-500" style="--d:${8 + .5*i}s"></i>
                  </div>
                `).join('')}
                <div class="flow-connect absolute top-[-0.5rem] left-0 w-full"></div>
              </div>
              <div class="mt-6">
                <div id="endUserCard" class="sub-card p-6 rounded-2xl border border-gray-200 transition-all duration-500">
                  <div class="flex items-center gap-3">
                    <div id="endUserAvatar" class="h-10 w-10 grid place-items-center font-bold text-white rounded-full" style="background:#EA4335">U</div>
                    <div class="text-base">
                      <div class="font-medium text-gray-900">End user</div>
                      <div id="endUserMessage" class="text-gray-700">Apps on demand ‚Äî no waiting, no tickets.</div>
                    </div>
                  </div>
                  <div class="mt-4 user-beam rounded-full" style="background:linear-gradient(to right,#0070F3,#005AD0);--d:10s"></div>
                  <div class="relative mt-4 rounded-2xl border border-gray-200 bg-gray-50 p-6">
                    <i data-lucide="laptop" class="h-6 w-6 text-gray-700"></i>
                    <div id="endUserBadge" class="absolute right-4 top-4 badge grid place-items-center font-bold text-black rounded-full" style="--d:11s;background:#E11D48">!</div>
                    <div class="mt-2 text-base text-gray-700">Workspace launches the correct app instantly</div>
                  </div>
                  <div id="miniWorkspace" class="mt-4 hidden grid grid-cols-4 gap-4">
                    ${miniApps.map(app => `<div class="logo-ring cursor-pointer rounded-full" data-action="launch-icon">${app.svg}</div>`).join('')}
                  </div>
                </div>
                <div id="flowSuccess" class="mt-4 hidden inline-flex items-center gap-2 text-base tagline-fade" style="color:#10B981"><i data-lucide="sparkles" class="h-5 w-5"></i><span>Configured once ‚Üí delivered everywhere.</span></div>
              </div>
            </div>
        `;
      }
      const miniApps = [
        logo('Microsoft Word','W','#185ABD'),
        logo('Microsoft Teams','T','#5B53D6'),
        logo('SAP','SAP','#0A6ED1'),
        logo('Zoom','Z','#0B5CFF')
      ];
      function renderROI(){
        const r = calcROI();
        return `
          <section id="panel-roi" class="grid grid-cols-12 gap-6">
            <div class="col-span-4 section-card p-6 rounded-2xl bg-white shadow-md hover:shadow-lg transition-shadow duration-300">
              <h3 class="text-xl font-medium mb-4 text-gray-900">Assumptions</h3>
              <div class="grid grid-cols-1 gap-4">
                ${numInput('# users','users', r.i.users)}
                ${numInput('Tickets per user / mo','ticketsPerUserPerMonth', r.i.ticketsPerUserPerMonth)}
                ${numInput('Avg handle (mins)','avgHandleMins', r.i.avgHandleMins)}
              </div>
              <div class="mt-6 space-y-4">
                ${bucketAccordion('per', 'mouse-pointer', 'Reactive Work Reduced', perUserContent)}
                ${bucketAccordion('one', 'wand-sparkles', 'Hours Saved from Packaging', onePackageContent)}
                ${bucketAccordion('zero', 'shield-check', 'Hours Saved from Faster Patching', zeroDayContent)}
              </div>
              <div class="mt-6">
                <button type="button" data-action="open-currentstate-editor" class="inline-flex items-center gap-2 bg-white text-gray-900 border border-gray-300 hover:border-blue-600 px-6 py-3 text-base rounded-full shadow-sm focus-ring transition-shadow duration-300">
                  <i data-lucide="edit-3" class="w-5 h-5"></i> Edit Current State
                </button>
              </div>
            </div>
            <div class="col-span-4 section-card p-6 rounded-2xl bg-white shadow-md hover:shadow-lg transition-shadow duration-300">
              <h3 class="text-xl font-medium mb-4 text-gray-900">Results</h3>
              <div class="space-y-4 text-base">
                ${kv('Hours Returned / Month', num(round(r.totalHoursMonth)))}
                ${kv('Hours Returned / Year', num(round(r.totalHoursYear)))}
              </div>
              <div class="mt-6 flex flex-wrap gap-4">
                <button type="button" data-action="reset-calculator" class="inline-flex items-center gap-2 bg-white text-gray-900 border border-gray-300 hover:border-blue-600 px-6 py-3 text-base rounded-full shadow-sm focus-ring transition-shadow duration-300">Reset</button>
                <button type="button" data-action="copy-onepager" class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 text-base rounded-full shadow-sm focus-ring transition-shadow duration-300">
                  <i data-lucide="clipboard" class="w-5 h-5"></i> ${STATE.copied ? 'Copied!' : 'Copy capacity summary'}
                </button>
              </div>
            </div>
            <div class="col-span-4 section-card p-6 rounded-2xl bg-white shadow-md hover:shadow-lg transition-shadow duration-300">
              <h3 class="text-xl font-medium mb-4 text-gray-900">Impact Breakdown</h3>
              <div class="space-y-4 text-base">
                ${kv('Packaging Work Reduced / Month', num(round(r.packagingHoursMonth)))}
                ${kv('Zero-Day Patch Time Reduced / Month', num(round(r.patchHoursMonth)))}
                ${kv('App-Related Reactive Work Reduced / Month', num(round(r.reactiveHoursMonth)))}
                ${kv('App Version Reduction (estimated)', '30-50% fewer active versions')}
                ${kv('Faster Patch Window', `${STATE.currentHrs} ‚Üí 1.5 hrs (${r.patchReductionPct}% reduction)`)}
                ${kv('Tickets Avoided (est.)', num(round(r.ticketsAvoided)) + ' / month')}
              </div>
            </div>
          </section>
        `;
      }
      function calcROI(){
        const i = STATE.roiInputs;
        const ticketsMonth = i.users * i.ticketsPerUserPerMonth;
        const reactiveHoursMonth = (STATE.impact.minutes * i.users) / 60;
        const packagingHoursMonth = STATE.impact.pkgHours;
        const patchHoursMonth = STATE.impact.riskHrs;
        const totalHoursMonth = reactiveHoursMonth + packagingHoursMonth + patchHoursMonth;
        const totalHoursYear = totalHoursMonth * 12;
        const ticketsAvoided = (STATE.impact.minutes * i.users) / i.avgHandleMins;
        const patchReductionPct = STATE.currentHrs > 0 ? Math.round((STATE.impact.riskHrs / STATE.currentHrs) * 100) : 0;
        return {
          i,
          ticketsMonth: round(ticketsMonth),
          reactiveHoursMonth: round(reactiveHoursMonth),
          packagingHoursMonth: round(packagingHoursMonth),
          patchHoursMonth: round(patchHoursMonth),
          totalHoursMonth,
          totalHoursYear,
          ticketsAvoided,
          patchReductionPct
        };
      }
      function updateROIOutputs(){}
      function setText(id, value){ const el=document.getElementById(id); if(el) el.textContent = String(value); }
      function kv(label,value){
        return `<div class="flex items-center justify-between rounded-full bg-gray-100 px-4 py-3"><span class="text-gray-700">${label}</span><span class="font-medium tabular-nums">${value}</span></div>`;
      }
      function numInput(label,key,value){
        return `<label class="flex flex-col gap-1 text-base"><span class="text-gray-700">${label}</span><input class="rounded-full border border-gray-200 bg-gray-50 px-4 py-3 focus-ring" inputmode="decimal" value="${value}" data-action="set-roi" data-key="${key}"></label>`;
      }
      const CATALOG=[
        {title:'CORE PRODUCTIVITY',id:'cat-core',items:[
          logo('Microsoft Word','W','#185ABD'),
          logo('Microsoft Excel','X','#107C41'),
          logo('PowerPoint','P','#D24726'),
          logo('Outlook','O','#106EBE'),
          logo('Microsoft Teams','T','#5B53D6'),
          logo('Google Docs','Dc','#1A73E8'),
          logo('Google Sheets','Sh','#1E8E3E'),
          logo('Google Slides','Sl','#F9AB00')
        ]},
        {title:'MESSAGING & MEETINGS',id:'cat-collab',items:[
          multiLogo('Slack',['#36C5F0','#2EB67D','#E01E5A','#ECB22E']),
          logo('Zoom','Z','#0B5CFF'),
          logo('Gmail','G','#EA4335'),
          logo('Google Meet','GM','#0F9D58')
        ]},
        {title:'WEB BROWSERS',id:'cat-browsers',items:[
          triLogo('Google Chrome','#EA4335','#FBBC05','#34A853','#4285F4'),
          ringLogo('Microsoft Edge','#0C8EC5','#0AA0A3'),
          flameLogo('Mozilla Firefox','#FF7139','#FFCC00')
        ]},
        {title:'ENTERPRISE APPS',id:'cat-enterprise',items:[
          logo('Salesforce','SF','#00A1E0'),
          logo('Workday','WD','#1F5BFF'),
          logo('ServiceNow','SN','#81B29A'),
          logo('SAP','SAP','#0A6ED1'),
          logo('Oracle NetSuite','NS','#C74634')
        ]},
        {title:'SECURITY & ACCESS',id:'cat-security',items:[
          logo('Duo','D','#3CB371'),
          logo('Okta','O','#007DC1'),
          logo('Ping Identity','P','#C0172C'),
          logo('Cisco AnyConnect','AC','#00B5AD'),
          logo('Microsoft Defender','MD','#0067B8'),
          logo('CrowdStrike Falcon','CS','#D61F26')
        ]},
        {title:'STORAGE & CREATIVE',id:'cat-storage',items:[
          logo('Adobe Acrobat','A','#ED2224'),
          logo('Dropbox','DB','#0061FF'),
          logo('Box','BX','#0061D5'),
          logo('OneDrive','OD','#0A5BD5'),
          logo('ZoomIt / Sysinternals','ZI','#58595B')
        ]}
      ];
      const appConfigs = [
        {stage:'Prod', policy:'MFA + VPN', region:'AMER', device:'Windows'},
        {stage:'QA', policy:'Compliant only', region:'APAC', device:'Any'},
        {stage:'Dev', policy:'MFA required', region:'EMEA', device:'Mac'},
        {stage:'Prod', policy:'VPN only', region:'Global', device:'Windows'},
        {stage:'QA', policy:'MFA required', region:'AMER', device:'Any'},
        {stage:'Dev', policy:'MFA required', region:'APAC', device:'Mac'},
        {stage:'Prod', policy:'Compliant only', region:'EMEA', device:'Windows'},
        {stage:'QA', policy:'VPN only', region:'Global', device:'Any'}
      ];
      let flatIndex = 0;
      CATALOG.forEach(sec => sec.items.forEach(itm => { itm.config = appConfigs[flatIndex % appConfigs.length]; flatIndex++; }));
      function logo(name,letter,color){ return { name, svg: mark(letter,color) }; }
      function mark(letter,color){
        return `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="32" height="32" role="img" aria-label="${letter}">
            <defs><linearGradient id="g${letter.replace(/\W/g,'')}" x1="0" x2="1"><stop offset="0" stop-color="${shade(color,.9)}"/><stop offset="1" stop-color="${shade(color,1.1)}"/></linearGradient></defs>
            <rect x="1.5" y="1.5" width="45" height="45" rx="12" fill="url(#g${letter.replace(/\W/g,'')})" stroke="rgba(0,0,0,.15)"/>
          <text x="50%" y="56%" text-anchor="middle" font-size="22" font-family="Inter,Segoe UI,Arial" font-weight="800" fill="#0A1C60">${letter}</text>
          </svg>`;
      }
      function multiLogo(name,colors){
        const slices=colors.map((c,i)=>`<rect x="${4+i*9}" y="8" width="7" height="32" rx="4" fill="${c}"></rect>`).join('');
        return { name, svg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="32" height="32" role="img" aria-label="${name}"><rect x="1.5" y="1.5" width="45" height="45" rx="12" fill="#F7F9FB" stroke="rgba(0,0,0,.15)"/>${slices}</svg>` };
      }
      function triLogo(name,r1,r2,r3,r4){
        return { name, svg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="32" height="32" aria-label="${name}"><rect x="1.5" y="1.5" width="45" height="45" rx="12" fill="#F7F9FB" stroke="rgba(0,0,0,.15)"/><circle cx="24" cy="24" r="12" fill="${r4}"/><path d="M24 12 A12 12 0 0 1 36 24 L24 24 Z" fill="${r1}"/><path d="M36 24 A12 12 0 0 1 24 36 L24 24 Z" fill="${r2}"/><path d="M24 36 A12 12 0 0 1 24 12 L24 24 Z" fill="${r3}"/></svg>` };
      }
      function ringLogo(name,c1,c2){
        return { name, svg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="32" height="32" aria-label="${name}"><rect x="1.5" y="1.5" width="45" height="45" rx="12" fill="#F7F9FB" stroke="rgba(0,0,0,.15)"/><circle cx="24" cy="24" r="11" fill="${c1}"/><circle cx="20" cy="20" r="8" fill="${c2}"/></svg>` };
      }
      function flameLogo(name,c1,c2){
        return { name, svg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="32" height="32" aria-label="${name}"><rect x="1.5" y="1.5" width="45" height="45" rx="12" fill="#F7F9FB" stroke="rgba(0,0,0,.15)"/><path d="M24 12c5 7-2 9 3 14 3 3 2 9-3 11-5-2-6-8-3-11 5-5-3-7 3-14z" fill="${c1}"/><circle cx="26" cy="28" r="4" fill="${c2}"/></svg>` };
      }
      function shade(hex,m){ const c=hex.replace('#',''); const n=[0,1,2].map(i=>parseInt(c.slice(i*2,i*2+2),16)); const s=n.map(v=>Math.max(0,Math.min(255,Math.round(v*m)))); return '#'+s.map(v=>v.toString(16).padStart(2,'0')).join(''); }
      const USER_ID = String(window.APP_USER_ID || "guest");
      const PAGE_SCOPE = location.origin + location.pathname + location.search;
      const STORAGE_KEY = `currentState:${USER_ID}:${PAGE_SCOPE}`;
      let DEFAULT_CURRENT_STATE = null;
      const $ = (sel, ctx = document) => ctx.querySelector(sel);
      const fields = {
        changeIntro: () => $('#changeIntro'),
        changeBullets: () => $('#changeBullets'),
        changeAnalyst: () => $('#changeAnalyst'),
        nowIntro: () => $('#nowIntro'),
        nowBullets: () => $('#nowBullets'),
        nowAnalyst: () => $('#nowAnalyst'),
        recastIntro: () => $('#recastIntro'),
        recastBullets: () => $('#recastBullets'),
        recastAnalyst: () => $('#recastAnalyst')
      };
      function captureDefaultsOnce(){
        if (DEFAULT_CURRENT_STATE) return;
        DEFAULT_CURRENT_STATE = STATE.defaultsCurrentState();
      }
      function readFields(){
        return {
          change: {
            intro: fields.changeIntro()?.value ?? "",
            bullets: fields.changeBullets()?.value ?? "",
            analyst: fields.changeAnalyst()?.value ?? ""
          },
          now: {
            intro: fields.nowIntro()?.value ?? "",
            bullets: fields.nowBullets()?.value ?? "",
            analyst: fields.nowAnalyst()?.value ?? ""
          },
          recast: {
            intro: fields.recastIntro()?.value ?? "",
            bullets: fields.recastBullets()?.value ?? "",
            analyst: fields.recastAnalyst()?.value ?? ""
          }
        };
      }
      function writeFields(data){
        if(!data) return;
        if(fields.changeIntro()) fields.changeIntro().value = data.change.intro ?? "";
        if(fields.changeBullets()) fields.changeBullets().value = data.change.bullets ?? "";
        if(fields.changeAnalyst()) fields.changeAnalyst().value = data.change.analyst ?? "";
        if(fields.nowIntro()) fields.nowIntro().value = data.now.intro ?? "";
        if(fields.nowBullets()) fields.nowBullets().value = data.now.bullets ?? "";
        if(fields.nowAnalyst()) fields.nowAnalyst().value = data.now.analyst ?? "";
        if(fields.recastIntro()) fields.recastIntro().value = data.recast.intro ?? "";
        if(fields.recastBullets()) fields.recastBullets().value = data.recast.bullets ?? "";
        if(fields.recastAnalyst()) fields.recastAnalyst().value = data.recast.analyst ?? "";
      }
      function loadDraft(){
        try{
          const raw = localStorage.getItem(STORAGE_KEY);
          return raw ? JSON.parse(raw) : null;
        }catch{return null;}
      }
      function saveDraft(payload){
        try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(payload)); }
        catch(e){ console.warn('Save failed (storage blocked or full):', e); }
      }
      function clearDraft(){
        try{ localStorage.removeItem(STORAGE_KEY); }catch{}
      }
      function initCurrentStateModal(){
        captureDefaultsOnce();
        const draft = loadDraft();
        if(draft) writeFields(draft);
        const saveBtn = $('#btnSaveCurrentState');
        const resetBtn = $('#btnResetCurrentState');
        if (saveBtn && !saveBtn.dataset.wired){
          saveBtn.dataset.wired = "1";
          saveBtn.addEventListener('click', (e)=>{
            e.preventDefault();
            saveDraft(readFields());
          });
        }
        if (resetBtn && !resetBtn.dataset.wired){
          resetBtn.dataset.wired = "1";
          resetBtn.addEventListener('click', (e)=>{
            e.preventDefault();
            clearDraft();
            writeFields(DEFAULT_CURRENT_STATE);
            STATE.currentState = STATE.defaultsCurrentState();
            render();
          });
        }
      }
      function renderModal(){
        if(!STATE.modalOpen) return '';
        const buf = STATE.editBuffers;
        const toLines = arr => arr.join('\n');
        const ensure = v => v ?? '';
        return `
          <div role="dialog" aria-modal="true" aria-labelledby="cs-editor-title" class="fixed inset-0 z-50 flex items-center justify-center bg-black/20 overflow-auto p-6 lg:p-12">
            <div class="w-full max-w-6xl bg-white rounded-2xl shadow-md p-12 overflow-y-auto" style="max-height: 95vh;">
              <div class="flex items-center justify-between">
                <h2 id="cs-editor-title" class="text-xl font-medium">Edit Current State</h2>
                <button type="button" class="text-gray-500 hover:text-gray-700 p-2 focus-ring rounded-full" data-action="close-modal" aria-label="Close">
                  <i data-lucide="x" class="w-6 h-6"></i>
                </button>
              </div>
              <p class="mt-2 text-base text-gray-700 leading-relaxed">Edit the introduction, bullets (one per line, max 4), and analyst trend for each section.</p>
              <div class="mt-6 grid grid-cols-3 gap-6">
                ${editorSection('change','Why Change', ensure(buf.change.intro) || STATE.currentState.change.intro, ensure(buf.change.bullets) || toLines(STATE.currentState.change.bullets), ensure(buf.change.analyst) || STATE.currentState.change.analyst)}
                ${editorSection('now','Why Now', ensure(buf.now.intro) || STATE.currentState.now.intro, ensure(buf.now.bullets) || toLines(STATE.currentState.now.bullets), ensure(buf.now.analyst) || STATE.currentState.now.analyst)}
                ${editorSection('recast','Why Recast', ensure(buf.recast.intro) || STATE.currentState.recast.intro, ensure(buf.recast.bullets) || toLines(STATE.currentState.recast.bullets), ensure(buf.recast.analyst) || STATE.currentState.recast.analyst)}
              </div>
              <div class="mt-6 flex flex-wrap gap-4">
                <button id="btnSaveCurrentState" type="button" data-action="save-currentstate" class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 text-base font-medium rounded-full shadow-sm focus-ring transition-shadow duration-300">
                  <i data-lucide="save" class="w-5 h-5"></i> Save
                </button>
                <button id="btnResetCurrentState" type="button" data-action="reset-currentstate-defaults" class="inline-flex items-center gap-2 bg-white text-gray-900 border border-gray-300 hover:border-blue-600 px-6 py-3 text-base font-medium rounded-full shadow-sm focus-ring transition-shadow duration-300">
                  <i data-lucide="rotate-ccw" class="w-5 h-5"></i> Reset to default
                </button>
              </div>
            </div>
          </div>
        `;
      }
      function editorSection(key,label,introValue,bulletsValue,analystValue){
        return `
          <div class="flex flex-col gap-4">
            <span class="text-base font-medium text-gray-900">${label}</span>
            <label class="flex flex-col gap-1">
              <span class="text-base text-gray-700">Introduction</span>
              <textarea id="${key}Intro" data-action="edit-buffer" data-key="${key}" data-subkey="intro" class="min-h-[80px] rounded-2xl border border-gray-200 bg-white p-4 text-base leading-relaxed focus-ring" rows="2">${introValue}</textarea>
            </label>
            <label class="flex flex-col gap-1">
              <div class="flex items-center gap-2 text-base text-gray-700">
                <i data-lucide="check-circle" class="w-5 h-5 text-blue-600"></i>
                Bullets (one per line, max 4)
              </div>
              <textarea id="${key}Bullets" data-action="edit-buffer" data-key="${key}" data-subkey="bullets" class="min-h-[160px] rounded-2xl border border-gray-200 bg-white p-4 text-base leading-relaxed focus-ring" rows="6">${bulletsValue}</textarea>
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-base text-gray-700">Analyst Trend</span>
              <textarea id="${key}Analyst" data-action="edit-buffer" data-key="${key}" data-subkey="analyst" class="min-h-[80px] rounded-2xl border border-gray-200 bg-white p-4 text-base leading-relaxed focus-ring" rows="2">${analystValue}</textarea>
            </label>
          </div>
        `;
      }
      function attachEvents(){
        const root=document.getElementById('app');
        root.querySelectorAll('[data-action="switch-tab"]').forEach(b=>b.addEventListener('click',e=>{
          STATE.activeTab=e.currentTarget.getAttribute('data-tab');
          STATE.visitedCards = [];
          render();
        }));
        root.querySelectorAll('[data-action="advance"]').forEach(b=>b.addEventListener('click',e=>{
          STATE.activeTab=e.currentTarget.getAttribute('data-next');
          STATE.openWhyModal = null;
          render();
        }));
        root.querySelectorAll('[data-action="open-why-modal"]').forEach(b=>b.addEventListener('click',e=>{
          const id=e.currentTarget.getAttribute('data-why');
          STATE.openWhyModal = id;
          render();
        }));
        root.querySelectorAll('[data-action="close-why-modal"]').forEach(b=>b.addEventListener('click',()=>{
          STATE.openWhyModal = null;
          render();
        }));
        root.querySelectorAll('[data-action="toggle-card"]').forEach(b=>b.addEventListener('click',e=>{
          const id=e.currentTarget.getAttribute('data-card');
          const wasOpen = STATE.openCards[id];
          Object.keys(STATE.openCards).forEach(k => STATE.openCards[k] = false);
          STATE.openCards[id] = !wasOpen;
          if (STATE.openCards[id] && !STATE.visitedCards.includes(id)) {
            STATE.visitedCards.push(id);
          }
          render();
          if (STATE.openCards[id]) {
            setTimeout(() => {
              e.currentTarget.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 200);
          }
        }));
        root.querySelectorAll('[data-action="toggle-bucket"]').forEach(b=>b.addEventListener('click',e=>{
          const id=e.currentTarget.getAttribute('data-bucket');
          STATE.openBuckets[id] = !STATE.openBuckets[id];
          render();
        }));
        root.querySelectorAll('[data-action="set-device"]').forEach(b=>b.addEventListener('click',e=>{ STATE.ctx.device=e.currentTarget.getAttribute('data-value'); render(); }));
        root.querySelectorAll('[data-action="set-network"]').forEach(b=>b.addEventListener('click',e=>{ STATE.ctx.network=e.currentTarget.getAttribute('data-value'); render(); }));
        root.querySelectorAll('[data-action="toggle-compliance"]').forEach(b=>b.addEventListener('click',()=>{ STATE.ctx.compliant=!STATE.ctx.compliant; render(); }));
        const pack=root.querySelector('[data-action="set-pack-hrs"]'); if(pack) pack.addEventListener('input',e=>{ STATE.packHrs=cleanNum(e.target.value); render(); });
        const cfg=root.querySelector('[data-action="set-config-hrs"]'); if(cfg) cfg.addEventListener('input',e=>{ STATE.configHrs=cleanNum(e.target.value); render(); });
        const cur=root.querySelector('[data-action="set-current-hrs"]'); if(cur) cur.addEventListener('input',e=>{ STATE.currentHrs=cleanNum(e.target.value); render(); });
        root.querySelectorAll('[data-action="add-impact"]').forEach(b=>b.addEventListener('click',e=>{
          const kind=e.currentTarget.getAttribute('data-kind'); const val=Number(e.currentTarget.getAttribute('data-value'))||0;
          if (kind==='minutes') STATE.impact.minutes+=val;
          if (kind==='pkgHours') STATE.impact.pkgHours+=val;
          if (kind==='riskHrs') STATE.impact.riskHrs+=val;
          updateROIOutputs();
          render();
        }));
        root.querySelectorAll('[data-action="set-roi"]').forEach(inp=>inp.addEventListener('input',e=>{
          const key=e.currentTarget.getAttribute('data-key');
          const v=Number(String(e.target.value).replace(/[^0-9.\-]/g,''));
          STATE.roiInputs[key]=isFinite(v)?v:0;
          render();
        }));
        const resetCalc=root.querySelector('[data-action="reset-calculator"]');
        if(resetCalc) resetCalc.addEventListener('click', ()=>{
          STATE.roiInputs = { users: 5000, ticketsPerUserPerMonth: 0.035, avgHandleMins: 18 };
          STATE.impact = { ...STATE.defaults.impact };
          STATE.copied = false;
          render();
        });
        const copyBtn=root.querySelector('[data-action="copy-onepager"]');
        if(copyBtn) copyBtn.addEventListener('click', async ()=>{
          const r = calcROI();
          const body =
 `Recast Application Workspace ‚Äî Capacity Dashboard
 Assumptions
  - Users: ${r.i.users}
  - Tickets per user / month: ${r.i.ticketsPerUserPerMonth}
  - Avg handle: ${r.i.avgHandleMins} mins
 Observed impact
  - Minutes saved per user (monthly): ${STATE.impact.minutes}
  - Packaging hours avoided: ${STATE.impact.pkgHours}
  - Zero-day hours avoided: ${STATE.impact.riskHrs}
 Outcomes
  - Hours Returned / Month: ${round(r.totalHoursMonth)}
  - Hours Returned / Year: ${round(r.totalHoursYear)}
  - Packaging Work Reduced / Month: ${round(r.packagingHoursMonth)}
  - Zero-Day Patch Time Reduced / Month: ${round(r.patchHoursMonth)}
  - App-Related Reactive Work Reduced / Month: ${round(r.reactiveHoursMonth)}
  - Tickets Avoided (est.): ${round(r.ticketsAvoided)} / month
  - Faster Patch Window: ${STATE.currentHrs} to 1.5 hrs (${r.patchReductionPct}% reduction)
  - App Version Reduction (estimated): 30-50% fewer active versions
 Notes: Illustrative; replace with your data.`;
          try { await navigator.clipboard.writeText(body); } catch {
            const ta=document.createElement('textarea'); ta.value=body; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
          }
          STATE.copied = true; render(); setTimeout(()=>{ STATE.copied = false; render(); }, 1200);
        });
        const startBtn=root.querySelector('[data-action="start-flow"]'); if(startBtn) startBtn.addEventListener('click', startFlow);
        const resetBtn=root.querySelector('[data-action="reset-flow"]'); if(resetBtn) resetBtn.addEventListener('click', resetFlow);
        const toggleLabels=root.querySelector('[data-action="toggle-labels"]'); if(toggleLabels) toggleLabels.addEventListener('click', ()=>{ STATE.showLabels=!STATE.showLabels; toggleOverlay(); buildFlow(); });
        root.querySelectorAll('[data-action="launch-icon"]').forEach(icon=>icon.addEventListener('click', ()=>{ icon.classList.add('icon-launch'); setTimeout(()=>icon.classList.remove('icon-launch'), 500); }));
        const openEditor=root.querySelector('[data-action="open-currentstate-editor"]');
        if(openEditor) openEditor.addEventListener('click', ()=>{
          STATE.modalOpen = true;
          STATE.editBuffers = { change: { intro: '', bullets: '', analyst: '' }, now: { intro: '', bullets: '', analyst: '' }, recast: { intro: '', bullets: '', analyst: '' } };
          render();
          setTimeout(()=>{ lucide.createIcons(); }, 0);
          setTimeout(()=>{ initCurrentStateModal(); }, 0);
        });
      }
      function toggleOverlay(){
        const overlay = document.getElementById('overlayTag');
        if(STATE.showLabels){
          overlay.classList.remove('hidden');
          setTimeout(()=>{ overlay.classList.add('hidden'); },3000);
        }
      }
      function buildFlow(){
        let base=0;
        CATALOG.forEach(section=>{
          const mount=document.getElementById(section.id); if(!mount) return;
          mount.innerHTML='';
          section.items.forEach((itm,idx)=>{
            const wrap=document.createElement('div'); wrap.className='logo-wrap'; wrap.style.setProperty('--d',(base+idx*0.2).toFixed(2)+'s');
            const ring=document.createElement('div'); ring.className='logo-ring rounded-full'; ring.innerHTML=itm.svg; ring.title=itm.name; ring.setAttribute('role','img'); ring.setAttribute('aria-label',itm.name);
            wrap.appendChild(ring);
            if(STATE.showLabels){
              const label=document.createElement('span'); label.className='logo-name text-base'; label.textContent=itm.name; wrap.appendChild(label);
              const meta=document.createElement('div'); meta.className='meta-label text-base';
              meta.innerHTML = `<span>Stage: ${itm.config.stage}</span><span>Policy: ${itm.config.policy}</span><span>Region: ${itm.config.region}</span><span>Device: ${itm.config.device}</span>`;
              wrap.appendChild(meta);
            }
            mount.appendChild(wrap);
          });
          base+=1.5;
        });
        buildTiles(document.getElementById('flowConnA'), 14, 3);
        buildTiles(document.getElementById('flowConnB'), 14, 3.5);
        buildTiles(document.getElementById('flowConnC'), 14, 4);
        buildTiles(document.getElementById('flowGrpA'), 18, 5);
        buildTiles(document.getElementById('flowGrpB'), 18, 5.5);
        buildTiles(document.getElementById('flowGrpC'), 18, 6);
        buildTiles(document.getElementById('flowDevA'), 10, 8);
        buildTiles(document.getElementById('flowDevB'), 10, 8.5);
        buildTiles(document.getElementById('flowDevC'), 10, 9);
        const avatar=document.getElementById('endUserAvatar');
        const badge=document.getElementById('endUserBadge');
        if(avatar){ avatar.style.background='#EA4335'; avatar.textContent='U'; }
        if(badge){ badge.textContent='!'; badge.style.background='#E11D48'; }
        const message = document.getElementById('endUserMessage');
        if(message) message.textContent = 'Apps on demand ‚Äî no waiting, no tickets.';
        const mini = document.getElementById('miniWorkspace');
        if(mini) mini.classList.add('hidden');
        const counters = document.getElementById('progressCounters');
        if(counters) counters.classList.add('hidden');
        const card = document.getElementById('flowCard');
        if(card) card.classList.remove('run');
        if(STATE.showLabels) card.classList.add('show-labels');
        else card.classList.remove('show-labels');
        const endCard = document.getElementById('endUserCard');
        if(endCard) endCard.classList.remove('end-user-expand');
        STATE.progress = { apps: 0, time: 0, tickets: 0 };
        updateProgress();
        const success=document.getElementById('flowSuccess'); if(success) success.classList.add('hidden');
      }
      function buildTiles(container,count,baseDelay){
        if(!container) return; container.innerHTML='';
        for(let i=0;i<count;i++){ const d=document.createElement('div'); d.className='tile rounded-full'; d.style.setProperty('--d',(baseDelay+i*0.1).toFixed(2)+'s'); container.appendChild(d); }
      }
      function startFlow(){
        const card=document.getElementById('flowCard'); if(!card) return;
        card.classList.remove('run'); void card.offsetWidth; card.classList.add('run');
        const flash=document.getElementById('flowHubFlash'); const success=document.getElementById('flowSuccess');
        const avatar=document.getElementById('endUserAvatar'); const badge=document.getElementById('endUserBadge');
        const message = document.getElementById('endUserMessage'); const mini = document.getElementById('miniWorkspace');
        const counters = document.getElementById('progressCounters'); const endCard = document.getElementById('endUserCard');
        if(flash){ flash.classList.remove('hidden'); setTimeout(()=>flash.classList.add('hidden'),2000); }
        if(success) success.classList.add('hidden');
        if(counters) counters.classList.remove('hidden');
        let interval = setInterval(updateProgress, 100);
        setTimeout(()=>{
          if(avatar){ avatar.style.background= '#10B981'; }
          if(badge){ badge.textContent='‚úì'; badge.style.background= '#10B981'; }
          if(message) message.textContent = 'Apps on demand ‚Äî no waiting, no tickets. Workspace launches the correct app instantly.';
          if(mini) mini.classList.remove('hidden');
          if(endCard) endCard.classList.add('end-user-expand');
          if(success) success.classList.remove('hidden');
          clearInterval(interval);
        }, 11000);
        setTimeout(()=> card.classList.remove('run'), 12000);
      }
      function updateProgress(){
        if(STATE.progress.apps < 128) STATE.progress.apps += 4;
        if(STATE.progress.time < 46) STATE.progress.time += 2;
        if(STATE.progress.tickets < 73) STATE.progress.tickets += 3;
        setText('appsProcessed', STATE.progress.apps > 128 ? 128 : STATE.progress.apps);
        setText('timeSaved', STATE.progress.time > 46 ? 46 : STATE.progress.time);
        setText('ticketsAvoided', STATE.progress.tickets > 73 ? 73 : STATE.progress.tickets);
      }
      function resetFlow(){
        STATE.progress = { apps: 0, time: 0, tickets: 0 };
        STATE.showLabels = false;
        buildFlow();
      }
      function attachAccordionKeyboard(){
        document.addEventListener('keydown', (e) => {
          const target = e.target;
          if (!target.classList.contains('accordion-header')) return;
          const headers = Array.from(document.querySelectorAll('.accordion-header'));
          const idx = headers.indexOf(target);
          if (e.key === 'ArrowDown') {
            const nextIdx = (idx + 1) % headers.length;
            headers[nextIdx].focus();
            e.preventDefault();
          } else if (e.key === 'ArrowUp') {
            const prevIdx = (idx - 1 + headers.length) % headers.length;
            headers[prevIdx].focus();
            e.preventDefault();
          } else if (e.key === 'Home') {
            headers[0].focus();
            e.preventDefault();
          } else if (e.key === 'End') {
            headers[headers.length - 1].focus();
            e.preventDefault();
          } else if (e.key === 'Enter' || e.key === ' ') {
            target.click();
            e.preventDefault();
          }
        });
      }
      document.addEventListener('DOMContentLoaded', render);
      document.addEventListener('click', (e)=>{
        const act = e.target.closest('[data-action]');
        if(!act) return;
        const action = act.getAttribute('data-action');
        if(action==='close-modal'){
          STATE.modalOpen=false; render();
        }
        if(action==='edit-buffer'){
          const key = act.getAttribute('data-key');
          const subkey = act.getAttribute('data-subkey');
          act.addEventListener('input', (evt)=>{ STATE.editBuffers[key][subkey] = evt.target.value; });
        }
        if(action==='save-currentstate'){
          const parseLines = (s)=> (s||'').split('\n').map(l=>l.trim()).filter(Boolean).slice(0,4);
          const fallback = STATE.defaultsCurrentState();
          const formData = readFields();
          STATE.currentState = {
            change: {
              intro: formData.change.intro.trim() || fallback.change.intro,
              bullets: parseLines(formData.change.bullets) || fallback.change.bullets,
              analyst: formData.change.analyst.trim() || fallback.change.analyst
            },
            now: {
              intro: formData.now.intro.trim() || fallback.now.intro,
              bullets: parseLines(formData.now.bullets) || fallback.now.bullets,
              analyst: formData.now.analyst.trim() || fallback.now.analyst
            },
            recast: {
              intro: formData.recast.intro.trim() || fallback.recast.intro,
              bullets: parseLines(formData.recast.bullets) || fallback.recast.bullets,
              analyst: formData.recast.analyst.trim() || fallback.recast.analyst
            }
          };
          saveDraft({
            change: {
              intro: $('#changeIntro')?.value || '',
              bullets: $('#changeBullets')?.value || '',
              analyst: $('#changeAnalyst')?.value || ''
            },
            now: {
              intro: $('#nowIntro')?.value || '',
              bullets: $('#nowBullets')?.value || '',
              analyst: $('#nowAnalyst')?.value || ''
            },
            recast: {
              intro: $('#recastIntro')?.value || '',
              bullets: $('#recastBullets')?.value || '',
              analyst: $('#recastAnalyst')?.value || ''
            }
          });
          STATE.modalOpen=false;
          STATE.activeTab='problems';
          STATE.openWhy=null;
          render();
        }
        if(action==='reset-currentstate-defaults'){
          clearDraft();
          captureDefaultsOnce();
          writeFields(DEFAULT_CURRENT_STATE);
          STATE.currentState = STATE.defaultsCurrentState();
          render();
        }
      });
      document.addEventListener('keydown',(e)=>{
        if(e.key==='Escape' && (STATE.modalOpen || STATE.openWhyModal)){
          STATE.modalOpen=false;
          STATE.openWhyModal=null;
          render();
        }
      });
    </script>
  </body>
</html>
