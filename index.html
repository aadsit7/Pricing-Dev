<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Recast — Compact Click-Through (Realistic Catalog)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="dark light">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://unpkg.com">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    :root {
      --re-navy: #0F1D6B;
      --re-accent: #1D6BFF;
      --re-blue-mid: #284CBA;
      --re-blue-bright: #1D6BFF;
      --re-blue-light: #5BA4FF;
      --re-orange: #FF6B00;
      --re-white: #FFFFFF;
      --radius: 12px;
      --border-subtle: rgba(255,255,255,0.12);
      --shadow-soft: 0 4px 20px rgba(0,0,0,0.15);
    }
    html, body {
      background: var(--re-navy);
      color: var(--re-white);
      font-family: 'Inter', sans-serif;
    }
    .focus-ring:focus-visible {
      outline: 2px solid var(--re-blue-light);
      outline-offset: 2px;
    }
    .section-card {
      border-radius: var(--radius);
      border: 1px solid var(--border-subtle);
      background: rgba(255,255,255,0.04);
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow-soft);
    }
    .sub-card {
      border-radius: calc(var(--radius) - 4px);
      border: 1px solid var(--border-subtle);
      background: rgba(255,255,255,0.03);
    }
    .tile {
      width: 0.5rem;
      height: 0.5rem;
      border-radius: 3px;
      background: #334155;
      opacity: 0.85;
    }
    .run .tile {
      animation: tilePulse 1.2s ease-in-out var(--d,0s) 1 forwards;
    }
    @keyframes tilePulse {
      0% { transform: scale(0.6); background: #334155; opacity: 0.3; }
      50% { transform: scale(1.1); background: var(--re-blue-light); opacity: 1; }
      100% { transform: scale(1); background: #334155; opacity: 0.85; }
    }
    .flow-bar {
      height: 0.25rem;
      border-radius: 9999px;
      transform-origin: left center;
      transform: scaleX(0);
    }
    .run .flow-bar {
      animation: barGrow 1s cubic-bezier(0.4,0,0.2,1) forwards var(--d,0s);
    }
    @keyframes barGrow {
      to { transform: scaleX(1); }
    }
    .bolt-line {
      width: 0.25rem;
      border-radius: 9999px;
      transform-origin: top center;
      transform: scaleY(0);
    }
    .run .bolt-line {
      animation: boltDrop 1s cubic-bezier(0.4,0,0.2,1) forwards var(--d,0s);
    }
    @keyframes boltDrop {
      to { transform: scaleY(1); }
    }
    .logo-ring {
      width: 2.2rem;
      height: 2.2rem;
      border-radius: 9999px;
      display: grid;
      place-items: center;
      background: #0b1445;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.12), 0 2px 4px rgba(0,0,0,0.1);
    }
    .logo-wrap {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: transform 0.3s ease;
    }
    .logo-wrap:hover {
      transform: translateY(-2px);
    }
    .logo-name {
      font-size: 0.75rem;
      color: #e5e7eb;
      white-space: nowrap;
    }
    .run .logo-ring {
      animation: appPop 0.9s cubic-bezier(0.2,0.8,0.2,1) var(--d,0s) 1 forwards;
    }
    @keyframes appPop {
      0% { transform: scale(0.8); filter: saturate(0.5); opacity: 0.6; }
      60% { transform: scale(1.05); filter: saturate(1); opacity: 1; }
      100% { transform: scale(1); }
    }
    .user-beam {
      height: 0.3rem;
      border-radius: 9999px;
      transform-origin: left center;
      transform: scaleX(0);
    }
    .run .user-beam {
      animation: barGrow 1.1s cubic-bezier(0.4,0,0.2,1) forwards var(--d,0s);
    }
    .badge {
      width: 1.2rem;
      height: 1.2rem;
      border-radius: 9999px;
      opacity: 0;
      transform: translateY(-8px) scale(0.8);
    }
    .run .badge {
      animation: badgeDrop 0.9s ease-out var(--d,0s) forwards;
    }
    @keyframes badgeDrop {
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .cat-row {
      display: grid;
      grid-template-columns: 16ch 1fr;
      gap: 0.6rem;
      align-items: center;
    }
    .cat-title {
      font-size: 0.75rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      opacity: 0.95;
    }
    .re-primary {
      background: var(--re-accent) !important;
      color: #fff !important;
      border: 0;
      border-radius: var(--radius);
      box-shadow: 0 8px 20px rgba(29,107,255,0.28), inset 0 1px 0 rgba(255,255,255,0.1);
      transition: all 0.2s ease;
    }
    .re-primary:hover {
      background: #1559ff !important;
      transform: translateY(-1px);
    }
    .re-primary:focus-visible {
      outline: 2px solid var(--re-blue-light);
      outline-offset: 2px;
    }
    .re-secondary {
      background: transparent !important;
      color: #fff !important;
      border: 1px solid rgba(255,255,255,0.25) !important;
      border-radius: var(--radius);
      transition: all 0.2s ease;
    }
    .re-secondary:hover {
      color: var(--re-blue-light) !important;
      border-color: var(--re-blue-light) !important;
      background: rgba(91,164,255,0.08) !important;
    }
  </style>
</head>
<body class="min-h-screen antialiased">
  <div id="app" class="min-h-screen"></div>

  <script>
    const STATE = {
      activeTab: 'today',
      impact: { minutes: 9, pkgHours: 6, riskHrs: 0 },
      defaults: { impact: { minutes: 9, pkgHours: 6, riskHrs: 0 } },
      ctx: { device: 'Windows', network: 'Corporate', compliant: true },
      packHrs: 8, configHrs: 2, currentHrs: 24,
      roiInputs: { users: 5000, ticketsPerUserPerMonth: 0.035, avgHandleMins: 18, loadedCostPerHour: 85, recastAnnualCost: 120000 },
      copied: false,
      showLabels: false,
      showSolutionCards: true,
      openWhy: null,
      modalOpen: false,
      modalKind: null,
      invoker: null,
      editBuffers: { change: '', now: '', recast: '' },
      todayAgenda: {
        title: 'Agenda',
        overviewText: ['Why Change | Why Now | Why Recast','Our Approach','Business Impact'].join('\n')
      },
      defaultsAgenda() {
        return JSON.parse(JSON.stringify({
          title: 'Agenda',
          overviewText: ['Why Change | Why Now | Why Recast','Our Approach','Business Impact'].join('\n')
        }));
      },
      currentStateTexts: {
        change: [
          'Apps have become the new supply chain bottleneck. Business initiatives stall when applications aren’t packaged, patched, and ready.',
          'Scale has outgrown people. Thousands of apps and constant updates can’t be managed manually anymore.',
          'Innovation depends on delivery. Cloud, AI, and security investments fail if apps lag behind.'
        ],
        now: [
          'App updates went from yearly to daily. IT must keep up or risk falling behind instantly.',
          'IT is asked to do ten times more with fewer people. Every hour wasted on manual app management blocks everything else from moving forward.',
          'Security stakes are higher. Outdated apps are the fastest-growing attack surface.'
        ],
        recast: [
          'One platform, Complete control. Package, patch, and deliver 7,000+ apps from one workspace.',
          'Scale without strain. Automates what people can’t keep up with manually.',
          'Apps stop blocking innovation. By removing friction, Recast clears the path for cloud, security, and AI projects to move faster, safer, with less risk.'
        ]
      },
      defaultsCurrentState() {
        return JSON.parse(JSON.stringify({
          change: [
            'App management is the #1 bottleneck. New devices, platforms, and projects stall until apps are packaged, patched, and proven.',
            'Too many apps, too many updates. Thousands of apps, constant versions — IT can’t keep up, slowing adoption and raising risk.',
            'Innovation waits on apps. Every transformation — cloud, security, AI — gets delayed if app delivery isn’t solved first.'
          ],
          now: [
            'Faster change cycles. OS updates, AI tools, and SaaS shifts are constant — apps must keep pace.',
            'Rising risk. Zero-days and compliance rules make delayed patching unacceptable',
            'Shrinking teams. IT capacity isn’t growing, but demands are. Fix app management first, or nothing else moves.'
          ],
          recast: [
            'One platform for every app. Package, patch, and deliver from a single place across all devices and management tools.',
            'Proven scale. 7,000+ curated apps, automated updates, and instant delivery slash manual effort.',
            'Fuel for innovation. By removing app friction, Recast lets enterprises adopt new tech faster, safer, and with less risk.'
          ]
        }));
      }
    };

    const TABS = [
      { id: 'today', label: 'Today', icon: 'calendar-clock' },
      { id: 'problems', label: 'Current State', icon: 'alert-triangle' },
      { id: 'solution', label: 'Recast Approach', icon: 'workflow' },
      { id: 'roi', label: 'Business Impact', icon: 'bar-chart-3' }
    ];

    function cx(...a){ return a.filter(Boolean).join(' '); }
    function round(n){ return Math.round(n*100)/100; }
    function num(n){ return new Intl.NumberFormat().format(Math.round(n)); }
    function routeRecommendation(ctx){
      if(!ctx.compliant) return 'Web';
      if(ctx.device==='Windows' && ctx.network!=='Home') return 'Local';
      return 'VDI';
    }
    function cleanNum(v){ v = Number(String(v).replace(/[^0-9.\-]/g,'')); return isFinite(v) ? v : 0; }

    function render(){
      const root=document.getElementById('app');
      root.innerHTML = `
        <div id="siteRoot" ${STATE.modalOpen ? 'inert aria-hidden="true"' : ''}>
          <header class="relative">
            <div class="relative mx-auto max-w-7xl px-6 pt-10 pb-8">
              <h1 class="text-5xl md:text-6xl font-bold leading-tight tracking-tight">Recast Software</h1>
              <p class="mt-3 max-w-3xl text-lg leading-relaxed opacity-85">
                ${STATE.activeTab==='problems' || STATE.activeTab==='today'
                  ? 'Application Workspace | Modern Application Delivery, Simplified'
                  : 'Recast works across SCCM, Intune, Citrix, VMware Workspace ONE, and more—making the tools you already use faster, smarter, and easier to manage'}
              </p>
            </div>
            <div class="relative mx-auto max-w-7xl px-6">
              <div id="tablist" role="tablist" aria-label="Demo sections" class="flex w-full flex-wrap gap-3 rounded-lg bg-white/5 p-2 ring-1 ring-white/15 backdrop-blur-sm">
                ${TABS.map(t=>`
                  <button type="button"
                    id="tab-${t.id}"
                    role="tab"
                    class="${cx('inline-flex items-center gap-2 px-4 py-2 text-base font-medium focus-ring transition rounded-md', STATE.activeTab===t.id ? 're-primary' : 'text-white hover:bg-white/10')}"
                    data-action="switch-tab" data-tab="${t.id}"
                    aria-controls="panel-${t.id}"
                    aria-selected="${STATE.activeTab===t.id}"
                    tabindex="${STATE.activeTab===t.id? '0':'-1'}">
                    <i data-lucide="${t.icon}" class="w-5 h-5"></i><span>${t.label}</span>
                  </button>
                `).join('')}
              </div>
            </div>
          </header>

          <main class="mx-auto max-w-7xl px-6 pb-20">
            ${STATE.activeTab!=='problems' && STATE.activeTab!=='today' ? `
            <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
              ${chip('Minutes saved (per user/per month)', String(STATE.impact.minutes), 'emerald')}
              ${chip('Packaging hours avoided', String(STATE.impact.pkgHours), 'sky')}
              ${chip('Zero-day window reduced (hrs)', String(round(STATE.impact.riskHrs)), 'yellow')}
            </div>` : ''}
            <section class="mt-8">${renderActivePanel()}</section>
          </main>
        </div>
        ${renderModal()}
      `;
      if (window.lucide?.createIcons) { try { window.lucide.createIcons(); } catch {} }
      attachEvents();
      wireTabsKeyboard();
      if (STATE.activeTab === 'solution') { buildFlow(); }
      if (STATE.activeTab === 'roi') { updateROIOutputs(); }
      if (STATE.modalOpen) { setupModalA11y(); }
    }

    function chip(label,value,tone){
      const tones={emerald:'from-emerald-500/90 to-teal-500/90',sky:'from-sky-500/90 to-indigo-500/90',yellow:'from-yellow-400/90 to-amber-500/90'};
      return `
        <div class="section-card p-4">
          <div class="text-sm opacity-85">${label}</div>
          <div class="mt-2 inline-flex items-center gap-2 rounded-md bg-gradient-to-r px-3 py-1 text-slate-900 font-medium ${tones[tone]}">
            <i data-lucide="badge-check" class="w-5 h-5"></i><span class="text-base tabular-nums">${value}</span>
          </div>
        </div>
      `;
    }

    function renderActivePanel(){
      if (STATE.activeTab==='today') return renderToday();
      if (STATE.activeTab==='problems') return renderProblems();
      if (STATE.activeTab==='solution') return renderSolution();
      if (STATE.activeTab==='roi') return renderROI();
      return '';
    }

    function mdInline(str){
      return str
        .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
        .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
        .replace(/\*(.+?)\*/g,'<em>$1</em>');
    }
    function parseBullets(text){
      const lines = (text||'').split('\n').map(l=>l.replace(/\t/g,'  '));
      const root = [];
      const stack = [{level:0, children:root}];
      lines.forEach(raw=>{
        const m = raw.match(/^(\s*)(.*)$/);
        const level = Math.floor((m[1]||'').length/2)+1;
        const content = (m[2]||'').trim();
        if(!content) return;
        while(stack.length && stack[stack.length-1].level>=level) stack.pop();
        const node = { text: content, children: [] };
        stack[stack.length-1].children.push(node);
        stack.push({level, children: node.children});
      });
      return root;
    }
    function bulletsToHTML(nodes){
      if(!nodes.length) return '';
      return `<ul class="mt-4 list-disc pl-6 text-xl leading-relaxed space-y-3">${nodes.map(n=>`
        <li>${mdInline(n.text)}${n.children?.length?bulletsToHTMLSmall(n.children):''}</li>
      `).join('')}</ul>`;
    }
    function bulletsToHTMLSmall(nodes){
      return `<ul class="mt-2 list-circle pl-6 text-lg leading-relaxed space-y-2 opacity-90">${nodes.map(n=>`
        <li>${mdInline(n.text)}${n.children?.length?bulletsToHTMLSmall(n.children):''}</li>
      `).join('')}</ul>`;
    }

    function renderToday(){
      const a = STATE.todayAgenda;
      const tree = parseBullets(a.overviewText);
      return `
        <section id="panel-today" role="tabpanel" aria-labelledby="tab-today" class="space-y-8">
          <div class="flex items-start justify-between gap-4">
            <div>
              <h2 class="text-5xl font-bold leading-none tracking-tight">${mdInline(a.title)}</h2>
              ${bulletsToHTML(tree)}
            </div>
            <div class="shrink-0">
              <button type="button" data-action="open-agenda-editor" class="inline-flex items-center gap-2 re-secondary px-4 py-3 text-base font-medium focus-ring" aria-label="Edit Agenda">
                Edit
              </button>
            </div>
          </div>
          <div class="pt-24"></div>
        </section>
      `;
    }

    function renderProblems(){
      const items=[
        {t:'Fragmented delivery',s:'Windows / Mac / VDI / Web — users guess the right way.',i:'layers'},
        {t:'Packaging backlog',s:'Rebuild per version; updates stall.',i:'package'},
        {t:'Zero-day exposure',s:'Patching takes days, not minutes.',i:'shield-alert'},
        {t:'Slow upgrades',s:'Stuck to old images; change is slow.',i:'refresh-cw'}
      ];
      return `
        <section id="panel-problems" role="tabpanel" aria-labelledby="tab-problems" class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            ${items.map(p=>`
              <article class="section-card p-5 transition hover:translate-y-[-2px]">
                <div class="flex items-center gap-3"><i data-lucide="${p.i}" class="w-6 h-6 text-var(--re-orange)"></i><h3 class="text-lg font-semibold">${p.t}</h3></div>
                <p class="mt-2 text-base opacity-85">${p.s}</p>
              </article>
            `).join('')}
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-stretch">
            ${calloutDropdown('change','alert-triangle','Why Change',STATE.currentStateTexts.change, 'bg-[rgba(255,255,255,0.05)]')}
            ${calloutDropdown('now','clock-4','Why Now',STATE.currentStateTexts.now, 'bg-[rgba(255,255,255,0.05)]')}
            ${calloutDropdown('recast','sparkles','Why Recast',STATE.currentStateTexts.recast, 'bg-[rgba(255,255,255,0.05)]', true)}
          </div>
        </section>
      `;
    }

    function calloutDropdown(id, icon, label, bullets, headerTone, cta=false){
      const expanded = STATE.openWhy === id;
      const contentId = `why-content-${id}`;
      return `
        <div class="h-full flex flex-col">
          <button
            type="button"
            class="w-full overflow-hidden ring-1 ring-white/15 focus-ring transition hover:ring-white/25 hover:translate-y-[-2px]"
            data-action="toggle-why"
            data-why="${id}"
            aria-expanded="${expanded}"
            aria-controls="${contentId}"
            style="border-radius: var(--radius); box-shadow: var(--shadow-soft)"
          >
            <div class="${cx('flex items-center justify-between px-6 py-4', headerTone)}" style="border-bottom: 1px solid var(--border-subtle)">
              <div class="flex items-center gap-3">
                <i data-lucide="${icon}" class="w-6 h-6 text-var(--re-orange)" aria-hidden="true"></i>
                <span class="text-2xl font-bold tracking-tight text-white">${label}</span>
              </div>
              <i data-lucide="${expanded?'chevron-up':'chevron-down'}" class="w-6 h-6 text-white/85 transition-transform duration-300 ${expanded?'rotate-180':''}" aria-hidden="true"></i>
            </div>

            <div id="${contentId}" class="bg-white/5 text-white overflow-hidden transition-all duration-300" style="max-height:${expanded?'1200px':'0'};opacity:${expanded?'1':'0'};padding:${expanded?'28px 24px':'0 24px'}">
              <ul class="list-disc pl-6 text-lg leading-relaxed space-y-4 text-white/90">
                ${bullets.map(b=>`<li>${b}</li>`).join('')}
              </ul>
              ${cta?`
                <div class="mt-8 flex justify-end">
                  <button id="btnAdvanceToSolution" type="button" data-action="advance" data-next="solution" class="inline-flex re-primary text-base font-medium px-5 py-3 items-center gap-3 focus-ring">
                    <i data-lucide="arrow-right" class="w-5 h-5"></i>
                    How Recast solves it
                  </button>
                </div>
              `:''}
            </div>
          </button>
        </div>
      `;
    }

    function renderSolution(){
      const saved=Math.max(0, Number(STATE.packHrs)-Number(STATE.configHrs));
      const reduced=Math.max(0, Number(STATE.currentHrs)-1.5);
      const route=routeRecommendation(STATE.ctx);
      return `
        <section id="panel-solution" role="tabpanel" aria-labelledby="tab-solution" class="space-y-6">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            ${renderFlow()}
            <div class="flex flex-col gap-4">
              ${STATE.showSolutionCards ? `
                ${cardUpdateOnce(saved)}
                ${cardZeroDay(reduced)}
                ${cardOneIcon(route)}
              ` : `
                <div class="section-card p-5 flex items-center justify-center">
                  <button type="button" data-action="show-solution-cards" class="re-secondary px-5 py-3 text-base font-medium focus-ring">Show Impact Cards</button>
                </div>
              `}
            </div>
          </div>
        </section>
      `;
    }

    function pill(label,active,action,value){
      return `<button type="button" class="${cx('px-4 py-2 border text-sm font-medium rounded-md transition',active?'re-primary border-transparent':'bg-transparent text-white border-white/20 hover:border-white/30 hover:bg-white/5')}" data-action="${action}" data-value="${String(value)}">${label}</button>`;
    }

    function cardOneIcon(route){
      const totalMin = Math.max(0, Number(STATE.impact.minutes));
      return `
        <div class="section-card p-5">
          <div class="flex items-center gap-3"><i data-lucide="monitor-smartphone" class="w-6 h-6 text-var(--re-orange)"></i><h3 class="text-lg font-semibold">Smart icons → Always the right app (Windows / Mac / VPN / VDI)</h3></div>
          <div class="sub-card p-4 text-base mt-3">
            <div class="flex items-center gap-3 font-medium"><i data-lucide="mouse-pointer-click" class="w-5 h-5"></i> Per-user minutes saved</div>
            <div class="mt-3 flex items-center justify-between rounded bg-black/20 px-4 py-2.5">
              <span class="tabular-nums font-medium">9 → ${totalMin} min</span>
              <strong class="tabular-nums text-var(--re-blue-light)">${totalMin} min saved</strong>
            </div>
          </div>
          <div class="mt-3 grid grid-cols-3 gap-3 text-sm">
            ${['Windows','Mac'].map(d=>pill(d,STATE.ctx.device===d,'set-device',d)).join('')}
            ${['Corporate','VPN'].map(n=>pill(n,STATE.ctx.network===n,'set-network',n)).join('')}
            ${pill(STATE.ctx.compliant?'Compliant':'Non-compliant',STATE.ctx.compliant,'toggle-compliance','')}
          </div>
          <div class="mt-4"><button type="button" class="re-secondary px-4 py-2 text-sm font-medium" data-action="add-impact" data-kind="minutes" data-value="2">Add to impact (+2 min saved per user)</button></div>
        </div>
      `;
    }
    function cardUpdateOnce(saved){
      return `
        <div class="section-card p-5">
          <div class="flex items-center gap-3"><i data-lucide="package-open" class="w-6 h-6 text-var(--re-orange)"></i><h3 class="text-lg font-semibold">One package → Deploy anywhere (cloud / on-prem / hybrid)</h3></div>
          <div class="sub-card p-4 text-base mt-3">
            <div class="flex items-center gap-3 font-medium"><i data-lucide="wand-sparkles" class="w-5 h-5"></i> Critical app updates</div>
            <label class="mt-3 flex items-center gap-3 text-sm">
              <span class="opacity-85">Hours/package</span>
              <input class="w-20 rounded bg-black/20 px-3 py-2 border border-white/15 focus-ring" value="${STATE.packHrs}" inputmode="decimal" data-action="set-pack-hrs" aria-label="Hours per package">
              <span>→</span>
              <input class="w-20 rounded bg-black/20 px-3 py-2 border border-white/15 focus-ring" value="${STATE.configHrs}" inputmode="decimal" data-action="set-config-hrs" aria-label="Hours to configure">
            </label>
            <div class="mt-3 flex items-center justify-between rounded bg-black/20 px-4 py-2.5"><span class="tabular-nums font-medium">${STATE.packHrs} → ${STATE.configHrs} hrs</span><strong class="tabular-nums text-var(--re-blue-light)">${saved} hrs saved</strong></div>
            <div class="mt-3 flex flex-wrap gap-2 text-sm">
              <span class="rounded px-3 py-1 bg-black/20">☁️ Cloud</span>
              <span class="rounded px-3 py-1 bg-black/20">🖥️ On-Prem</span>
              <span class="rounded px-3 py-1 bg-black/20">🔀 Hybrid</span>
            </div>
            <button type="button" class="mt-3 re-primary px-4 py-2 text-sm font-medium" data-action="add-impact" data-kind="pkgHours" data-value="${saved}">Add to impact</button>
          </div>
        </div>
      `;
    }
    function cardZeroDay(reduced){
      return `
        <div class="section-card p-5">
          <div class="flex items-center gap-3"><i data-lucide="shield-check" class="w-6 h-6 text-var(--re-orange)"></i><h3 class="text-lg font-semibold">Zero-Day Patches in Hours</h3></div>
          <div class="sub-card p-4 text-base mt-3">
            <div class="flex items-center gap-3 font-medium"><i data-lucide="shield-alert" class="w-5 h-5"></i> Zero-day rollout</div>
            <label class="mt-3 flex items-center gap-3 text-sm">
              <span class="opacity-85">Current hrs</span>
              <input class="w-24 rounded bg-black/20 px-3 py-2 border border-white/15 focus-ring" value="${STATE.currentHrs}" inputmode="decimal" data-action="set-current-hrs" aria-label="Current time to deploy (hours)">
            </label>
            <div class="mt-3 flex items-center justify-between rounded bg-black/20 px-4 py-2.5"><span class="tabular-nums font-medium">${STATE.currentHrs} → 1.5 hrs</span><strong class="tabular-nums text-var(--re-blue-light)">${round(reduced)} hrs reduced</strong></div>
            <button type="button" class="mt-3 re-primary px-4 py-2 text-sm font-medium" data-action="add-impact" data-kind="riskHrs" data-value="${reduced}">Add to impact</button>
          </div>
        </div>
      `;
    }

    function renderFlow(){
      return `
        <div class="section-card p-5">
          <div class="flex items-center justify-between gap-4">
            <div class="flex items-center gap-3">
              <div class="h-7 w-7 rounded-md grid place-items-center bg-var(--re-blue-mid)"><i data-lucide="boxes" class="h-4 w-4 text-white"></i></div>
              <div>
                <h3 class="text-lg font-semibold">Application Workspace</h3>
                <div class="text-sm opacity-85">Curated & secured catalog</div>
              </div>
            </div>
            <div class="flex items-center gap-3 text-sm">
              <button type="button" class="re-secondary px-4 py-2 font-medium" data-action="toggle-labels">${STATE.showLabels?'Hide':'Show'} labels</button>
              <button type="button" data-action="start-flow" class="re-primary px-4 py-2 font-medium">Start</button>
              <button type="button" data-action="reset-flow" class="re-secondary px-4 py-2 font-medium">Reset</button>
            </div>
          </div>

          <div id="flowCard" class="mt-4 sub-card p-4" role="region" aria-label="Animated flow">
            <div class="space-y-3">
              ${CATALOG.map(s=>`
                <div class="cat-row">
                  <div class="cat-title text-var(--re-orange)">${s.title}</div>
                  <div id="${s.id}" class="flex flex-wrap gap-3"></div>
                </div>
              `).join('')}
            </div>

            <div id="flowHubFlash" class="mt-3 hidden" style="color:var(--re-blue-light)"><span class="inline-flex items-center gap-2 text-sm"><i data-lucide="bolt" class="h-5 w-5"></i><span>Update published</span></span></div>

            <div class="mt-4 grid grid-cols-3 gap-3" aria-hidden="true">
              ${['A','B','C'].map((k,i)=>`
                <div class="sub-card p-3">
                  <div class="text-sm opacity-85">${['Existing Platforms','Staged Rings','Access & Policy'][i]}</div>
                  <div id="flowConn${k}" class="mt-2 grid grid-cols-10 gap-2"></div>
                  <div class="mt-2 flow-bar w-full" style="background:linear-gradient(to right,var(--re-blue-light),var(--re-blue-bright));--d:${.55 + .12*i}s"></div>
                </div>
              `).join('')}
            </div>

            <div class="mt-4 grid grid-cols-3 gap-3" aria-hidden="true">
              ${['A','B','C'].map((k,i)=>`
                <div class="sub-card p-3">
                  <div class="text-sm opacity-85">${['Business Unit','Subsidiary','Region'][i]}</div>
                  <div id="flowGrp${k}" class="mt-2 grid grid-cols-8 gap-2"></div>
                  <div class="mx-auto mt-2 bolt-line h-20 w-1" style="background:linear-gradient(to bottom,#fff,var(--re-blue-light));--d:${1 + .15*i}s"></div>
                </div>
              `).join('')}
            </div>

            <div class="mt-4 grid grid-cols-3 gap-3" aria-hidden="true">
              ${['A','B','C'].map((k,i)=>`
                <div class="sub-card p-3 text-center">
                  <i data-lucide="${['monitor-smartphone','laptop','smartphone'][i]}" class="h-6 w-6 opacity-85"></i>
                  <div id="flowDev${k}" class="mt-2 grid grid-cols-6 gap-2"></div>
                  <div class="mt-2 text-sm opacity-85">${['Windows & macOS','VDI / Web','Mobile'][i]}</div>
                </div>
              `).join('')}
            </div>

            <div class="mt-4">
              <div id="endUserCard" class="sub-card p-4">
                <div class="flex items-center gap-4">
                  <div id="endUserAvatar" class="h-10 w-10 grid place-items-center font-bold text-white rounded-full" style="background:#EA4335">U</div>
                  <div class="text-base">
                    <div class="font-medium">End user</div>
                    <div class="opacity-85 text-sm">Apps on demand — no waiting, no tickets.</div>
                  </div>
                </div>
                <div class="mt-4 user-beam" style="background:linear-gradient(to right,var(--re-blue-light),var(--re-blue-bright));--d:2.1s"></div>
                <div class="relative mt-3 rounded-lg border border-white/15 bg-white/5 p-4">
                  <i data-lucide="laptop" class="h-6 w-6 opacity-85"></i>
                  <div id="endUserBadge" class="absolute right-3 top-3 badge grid place-items-center font-bold text-sm" style="--d:2.4s;background:#E11D48;color:#fff">!</div>
                  <div class="mt-2 text-sm opacity-85">Workspace launches the correct app instantly</div>
                </div>
              </div>
              <div id="flowSuccess" class="mt-3 hidden inline-flex items-center gap-2 text-base" style="color:#10B981"><i data-lucide="sparkles" class="h-5 w-5"></i><span>Configured once → delivered everywhere.</span></div>
            </div>
          </div>
        </div>
      `;
    }

    function renderROI(){
      const r = calcROI();
      return `
        <section id="panel-roi" role="tabpanel" aria-labelledby="tab-roi" class="space-y-6">
          <div class="section-card p-5"><div class="text-base font-medium leading-relaxed">Planting consistency in app delivery today is what prevents outages and chaos three years from now.</div></div>

          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            ${kpiId('users','FTEs freed', r.fteEquivalent, 'Equivalent IT capacity', 'kpi-fte')}
            ${kpiId('timer','Hours saved / mo', r.totalHoursSavedMonth, 'Per-user minutes × users + packaging + zero-day', 'kpi-hours')}
            ${kpiId('line-chart','$ saved / yr', '$'+num(r.dollarSavedYear), 'Productivity Impact', 'kpi-year')}
            ${kpiId('rocket','Tickets / mo', num(r.ticketsMonth), 'Scale context', 'kpi-tickets')}
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="section-card p-5 lg:col-span-2">
              <h3 class="text-lg font-semibold">Assumptions (edit)</h3>
              <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                ${numInput('# users','users', r.i.users)}
                ${numInput('Tickets per user / mo','ticketsPerUserPerMonth', r.i.ticketsPerUserPerMonth)}
                ${numInput('Avg handle (mins)','avgHandleMins', r.i.avgHandleMins)}
                ${numInput('Loaded cost ($/hr)','loadedCostPerHour', r.i.loadedCostPerHour)}
                ${numInput('Recast annual cost ($)','recastAnnualCost', r.i.recastAnnualCost)}
              </div>
              <div class="mt-6 flex flex-wrap gap-3">
                <button type="button" data-action="open-currentstate-editor" class="inline-flex items-center gap-2 re-secondary px-5 py-3 text-base font-medium focus-ring">
                  <i data-lucide="edit-3" class="w-5 h-5"></i> Current State
                </button>
                <button type="button" data-action="open-agenda-editor" class="inline-flex items-center gap-2 re-secondary px-5 py-3 text-base font-medium focus-ring">
                  <i data-lucide="edit-3" class="w-5 h-5"></i> Agenda
                </button>
              </div>
            </div>

            <div class="section-card p-5">
              <h3 class="text-lg font-semibold">Results</h3>
              <div class="mt-4 space-y-3 text-base">
                ${kvId('Hours saved / month', r.totalHoursSavedMonth, 'res-hours')}
                ${kvId('$ saved / month', '$'+num(r.dollarSavedMonth), 'res-month')}
                ${kvId('$ saved / year', '$'+num(r.dollarSavedYear), 'res-year')}
                ${kvId('Net benefit / year', '$'+num(r.netBenefitYear), 'res-net')}
                ${kvId('ROI', r.roiPct+'%', 'res-roi')}
                ${kvId('Equivalent IT FTEs freed', r.fteEquivalent, 'res-fte')}
              </div>
              <div class="mt-6 flex flex-wrap gap-3">
                <button type="button" data-action="reset-calculator" class="inline-flex items-center gap-2 re-secondary px-5 py-3 text-base font-medium focus-ring">Reset</button>
                <button type="button" data-action="copy-onepager" class="inline-flex items-center gap-2 re-primary px-5 py-3 text-base font-medium focus-ring">
                  <i data-lucide="clipboard" class="w-5 h-5"></i> ${STATE.copied ? 'Copied!' : 'Copy executive one-pager'}
                </button>
              </div>
            </div>
          </div>

        </section>
      `;
    }

    function calcROI(){
      const i = STATE.roiInputs;
      const ticketsMonth = i.users * i.ticketsPerUserPerMonth;
      const hoursFromMinutes = (STATE.impact.minutes * i.users) / 60;
      const totalHoursSavedMonth = hoursFromMinutes + STATE.impact.pkgHours + STATE.impact.riskHrs;
      const dollarSavedMonth = totalHoursSavedMonth * i.loadedCostPerHour;
      const dollarSavedYear = dollarSavedMonth * 12;
      const netBenefitYear = dollarSavedYear - i.recastAnnualCost;
      const roiPct = i.recastAnnualCost ? round((netBenefitYear / i.recastAnnualCost) * 100) : 0;
      const fteHoursYear = 2080;
      const fteEquivalent = round((totalHoursSavedMonth * 12) / fteHoursYear);
      return {
        i,
        ticketsMonth,
        hoursFromMinutes: round(hoursFromMinutes),
        totalHoursSavedMonth: round(totalHoursSavedMonth),
        dollarSavedMonth: round(dollarSavedMonth),
        dollarSavedYear: round(dollarSavedYear),
        netBenefitYear: round(netBenefitYear),
        roiPct,
        fteEquivalent
      };
    }
    function updateROIOutputs(){
      const r = calcROI();
      setText('kpi-hours', r.totalHoursSavedMonth);
      setText('kpi-year', '$'+num(r.dollarSavedYear));
      setText('kpi-fte', r.fteEquivalent);
      setText('kpi-tickets', num(r.ticketsMonth));
      setText('res-hours', r.totalHoursSavedMonth);
      setText('res-month', '$'+num(r.dollarSavedMonth));
      setText('res-year', '$'+num(r.dollarSavedYear));
      setText('res-net', '$'+num(r.netBenefitYear));
      setText('res-roi', r.roiPct+'%');
      setText('res-fte', r.fteEquivalent);
    }
    function setText(id, value){ const el=document.getElementById(id); if(el) el.textContent = String(value); }

    function kpiId(icon,label,value,hint,id){
      return `
        <div class="section-card p-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm opacity-85">${label}</div>
              <div id="${id}" class="text-2xl font-bold tabular-nums">${value}</div>
            </div>
            <i data-lucide="${icon}" class="w-6 h-6 text-var(--re-orange)"></i>
          </div>
          ${hint ? `<div class="mt-2 text-sm opacity-80">${hint}</div>` : ''}
        </div>
      `;
    }
    function kvId(label,value,id){
      return `<div class="flex items-center justify-between rounded-md bg-black/20 px-4 py-3"><span class="opacity-85 font-medium">${label}</span><span id="${id}" class="font-bold tabular-nums text-var(--re-blue-light)">${value}</span></div>`;
    }
    function numInput(label,key,value){
      return `<label class="flex flex-col gap-2 text-base"><span class="text-sm opacity-85">${label}</span><input class="rounded-md border border-white/15 bg-black/20 px-4 py-3 text-base focus-ring" inputmode="decimal" value="${value}" data-action="set-roi" data-key="${key}"></label>`;
    }

    const CATALOG=[
      {title:'CORE PRODUCTIVITY',id:'cat-core',items:[
        logo('Microsoft Word','W','#185ABD'),
        logo('Microsoft Excel','X','#107C41'),
        logo('PowerPoint','P','#D24726'),
        logo('Outlook','O','#106EBE'),
        logo('Microsoft Teams','T','#5B53D6'),
        logo('Google Docs','Dc','#1A73E8'),
        logo('Google Sheets','Sh','#1E8E3E'),
        logo('Google Slides','Sl','#F9AB00')
      ]},
      {title:'MESSAGING & MEETINGS',id:'cat-collab',items:[
        multiLogo('Slack',['#36C5F0','#2EB67D','#E01E5A','#ECB22E']),
        logo('Zoom','Z','#0B5CFF'),
        logo('Gmail','G','#EA4335'),
        logo('Google Meet','GM','#0F9D58')
      ]},
      {title:'WEB BROWSERS',id:'cat-browsers',items:[
        triLogo('Google Chrome','#EA4335','#FBBC05','#34A853','#4285F4'),
        ringLogo('Microsoft Edge','#0C8EC5','#0AA0A3'),
        flameLogo('Mozilla Firefox','#FF7139','#FFCC00')
      ]},
      {title:'ENTERPRISE APPS',id:'cat-enterprise',items:[
        logo('Salesforce','SF','#00A1E0'),
        logo('Workday','WD','#1F5BFF'),
        logo('ServiceNow','SN','#81B29A'),
        logo('SAP','SAP','#0A6ED1'),
        logo('Oracle NetSuite','NS','#C74634')
      ]},
      {title:'SECURITY & ACCESS',id:'cat-security',items:[
        logo('Duo','D','#3CB371'),
        logo('Okta','O','#007DC1'),
        logo('Ping Identity','P','#C0172C'),
        logo('Cisco AnyConnect','AC','#00B5AD'),
        logo('Microsoft Defender','MD','#0067B8'),
        logo('CrowdStrike Falcon','CS','#D61F26')
      ]},
      {title:'STORAGE & CREATIVE',id:'cat-storage',items:[
        logo('Adobe Acrobat','A','#ED2224'),
        logo('Dropbox','DB','#0061FF'),
        logo('Box','BX','#0061D5'),
        logo('OneDrive','OD','#0A5BD5'),
        logo('ZoomIt / Sysinternals','ZI','#58595B')
      ]}
    ];

    function logo(name,letter,color){ return { name, svg: mark(letter,color) }; }
    function mark(letter,color){
      return `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="28" height="28" role="img" aria-label="${letter}">
          <defs><linearGradient id="g${letter.replace(/\W/g,'')}" x1="0" x2="1"><stop offset="0" stop-color="${shade(color,.95)}"/><stop offset="1" stop-color="${shade(color,1.05)}"/></linearGradient></defs>
          <rect x="1.5" y="1.5" width="45" height="45" rx="12" fill="url(#g${letter.replace(/\W/g,'')})" stroke="rgba(255,255,255,.12)"/>
          <text x="50%" y="56%" text-anchor="middle" font-size="24" font-family="Inter, sans-serif" font-weight="700" fill="white">${letter}</text>
        </svg>`;
    }
    function multiLogo(name,colors){
      const slices=colors.map((c,i)=>`<rect x="${4+i*10}" y="8" width="8" height="32" rx="4" fill="${c}"></rect>`).join('');
      return { name, svg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="28" height="28" role="img" aria-label="${name}"><rect x="1.5" y="1.5" width="45" height="45" rx="12" fill="#111827" stroke="rgba(255,255,255,.12)"/>${slices}</svg>` };
    }
    function triLogo(name,r1,r2,r3,r4){
      return { name, svg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="28" height="28" aria-label="${name}"><rect x="1.5" y="1.5" width="45" height="45" rx="12" fill="#111827" stroke="rgba(255,255,255,.12)"/><circle cx="24" cy="24" r="13" fill="${r4}"/><path d="M24 12 A12 12 0 0 1 36 24 L24 24 Z" fill="${r1}"/><path d="M36 24 A12 12 0 0 1 24 36 L24 24 Z" fill="${r2}"/><path d="M24 36 A12 12 0 0 1 24 12 L24 24 Z" fill="${r3}"/></svg>` };
    }
    function ringLogo(name,c1,c2){
      return { name, svg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="28" height="28" aria-label="${name}"><rect x="1.5" y="1.5" width="45" height="45" rx="12" fill="#111827" stroke="rgba(255,255,255,.12)"/><circle cx="24" cy="24" r="12" fill="${c1}"/><circle cx="20" cy="20" r="9" fill="${c2}"/></svg>` };
    }
    function flameLogo(name,c1,c2){
      return { name, svg: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="28" height="28" aria-label="${name}"><rect x="1.5" y="1.5" width="45" height="45" rx="12" fill="#111827" stroke="rgba(255,255,255,.12)"/><path d="M24 12c5 7-2 9 3 14 3 3 2 9-3 11-5-2-6-8-3-11 5-5-3-7 3-14z" fill="${c1}"/><circle cx="26" cy="28" r="5" fill="${c2}"/></svg>` };
    }
    function shade(hex,m){ const c=hex.replace('#',''); const n=[0,1,2].map(i=>parseInt(c.slice(i*2,i*2+2),16)); const s=n.map(v=>Math.max(0,Math.min(255,Math.round(v*m)))); return '#'+s.map(v=>v.toString(16).padStart(2,'0')).join(''); }

    const USER_ID = String(window.APP_USER_ID || "guest");
    const PAGE_SCOPE = location.origin + location.pathname + location.search;
    const STORAGE_KEY = `currentState:${USER_ID}:${PAGE_SCOPE}`;
    let DEFAULT_CURRENT_STATE = null;

    const $ = (sel, ctx = document) => ctx.querySelector(sel);
    const fields = {
      whyChange: () => $('#whyChange'),
      whyNow: () => $('#whyNow'),
      whyRecast: () => $('#whyRecast'),
    };

    function captureDefaultsOnce(){
      if (DEFAULT_CURRENT_STATE) return;
      DEFAULT_CURRENT_STATE = {
        whyChange: fields.whyChange()?.value ?? "",
        whyNow: fields.whyNow()?.value ?? "",
        whyRecast: fields.whyRecast()?.value ?? "",
      };
    }
    function readFields(){
      return {
        whyChange: fields.whyChange()?.value ?? "",
        whyNow: fields.whyNow()?.value ?? "",
        whyRecast: fields.whyRecast()?.value ?? "",
      };
    }
    function writeFields(data){
      if(!data) return;
      if(fields.whyChange()) fields.whyChange().value = data.whyChange ?? "";
      if(fields.whyNow()) fields.whyNow().value = data.whyNow ?? "";
      if(fields.whyRecast()) fields.whyRecast().value = data.whyRecast ?? "";
    }
    function loadDraft(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : null;
      }catch{return null;}
    }
    function saveDraft(payload){
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(payload)); }
      catch(e){ console.warn('Save failed (storage blocked or full):', e); }
    }
    function clearDraft(){
      try{ localStorage.removeItem(STORAGE_KEY); }catch{}
    }
    function initCurrentStateModal(){
      captureDefaultsOnce();
      const draft = loadDraft();
      if(draft) writeFields(draft);
      const saveBtn = $('#btnSaveCurrentState');
      const resetBtn = $('#btnResetCurrentState');
      if (saveBtn && !saveBtn.dataset.wired){
        saveBtn.dataset.wired = "1";
        saveBtn.addEventListener('click', (e)=>{
          e.preventDefault();
          saveDraft(readFields());
        });
      }
      if (resetBtn && !resetBtn.dataset.wired){
        resetBtn.dataset.wired = "1";
        resetBtn.addEventListener('click', (e)=>{
          e.preventDefault();
          clearDraft();
          writeFields(DEFAULT_CURRENT_STATE);
        });
      }
    }

    const AGENDA_STORAGE_KEY = `agenda:${USER_ID}:${PAGE_SCOPE}`;
    function loadAgendaDraft(){
      try{ const raw = localStorage.getItem(AGENDA_STORAGE_KEY); return raw ? JSON.parse(raw) : null; }catch{return null;}
    }
    function saveAgendaDraft(payload){
      try{ localStorage.setItem(AGENDA_STORAGE_KEY, JSON.stringify(payload)); }catch(e){ console.warn('Agenda save failed:', e); }
    }
    function clearAgendaDraft(){ try{ localStorage.removeItem(AGENDA_STORAGE_KEY); }catch{} }

    function renderModal(){
      if(!STATE.modalOpen) return '';
      if (STATE.modalKind === 'agenda') {
        const a = STATE.todayAgenda;
        const draft = loadAgendaDraft();
        const titleVal = draft?.title ?? a.title;
        const overviewVal = (draft?.overviewText ?? a.overviewText);
        return `
          <div role="dialog" aria-modal="true" aria-labelledby="agenda-editor-title" class="fixed inset-0 z-50 overflow-auto bg-white">
            <div class="relative mx-auto max-w-6xl px-8 py-12 text-var(--re-navy)">
              <div class="flex items-center justify-between">
                <h2 id="agenda-editor-title" class="text-3xl font-bold">Edit Today Agenda</h2>
                <button type="button" class="p-3 rounded-md border border-var(--re-navy)/20 focus-ring" data-action="close-modal" aria-label="Close">
                  <i data-lucide="x" class="w-6 h-6 text-var(--re-navy)"></i>
                </button>
              </div>
              <p class="mt-2 text-base text-var(--re-navy)/80">Update the agenda title and Overview bullets. Use two leading spaces for sub-bullets. Supports **bold** and *italics*.</p>
              <div class="mt-6 grid grid-cols-1 gap-6">
                <label class="flex flex-col gap-3">
                  <span class="text-base font-medium">Agenda Title</span>
                  <input id="agendaTitle" class="rounded-md border border-var(--re-navy)/20 px-4 py-3 text-lg" value="${titleVal}" aria-label="Agenda Title">
                </label>
                <label class="flex flex-col gap-3">
                  <span class="text-base font-medium">Overview (bullets)</span>
                  <textarea id="agendaOverview" class="min-h-[280px] rounded-md border border-var(--re-navy)/20 p-4 leading-relaxed text-lg" aria-label="Agenda Overview bullets" placeholder="One item per line. Use two spaces for sub-bullets.">${overviewVal}</textarea>
                </label>
              </div>
              <div class="mt-8 flex flex-wrap gap-3">
                <button type="button" data-action="save-agenda" class="inline-flex items-center gap-3 bg-var(--re-accent) text-white px-5 py-3 rounded-md focus-ring">
                  <i data-lucide="save" class="w-5 h-5"></i> Save
                </button>
                <button type="button" data-action="reset-agenda-defaults" class="inline-flex items-center gap-3 border border-var(--re-navy)/20 px-5 py-3 rounded-md focus-ring">
                  <i data-lucide="rotate-ccw" class="w-5 h-5"></i> Reset to default
                </button>
              </div>
            </div>
          </div>
        `;
      }

      const buf = STATE.editBuffers;
      const toLines = arr => arr.join('\n');
      const ensure = v => v ?? '';
      return `
        <div role="dialog" aria-modal="true" aria-labelledby="cs-editor-title" class="fixed inset-0 z-50 overflow-auto bg-white">
          <div class="relative mx-auto max-w-6xl px-8 py-12 text-var(--re-navy)">
            <div class="flex items-center justify-between">
              <h2 id="cs-editor-title" class="text-3xl font-bold">Edit Current State</h2>
              <button type="button" class="p-3 rounded-md border border-var(--re-navy)/20 focus-ring" data-action="close-modal" aria-label="Close">
                <i data-lucide="x" class="w-6 h-6 text-var(--re-navy)"></i>
              </button>
            </div>
            <p class="mt-2 text-base text-var(--re-navy)/80">Enter up to three bullet points per section. Each new line becomes a bullet.</p>
            <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-6">
              ${editorBox('change','Why Change', ensure(buf.change) || toLines(STATE.currentStateTexts.change))}
              ${editorBox('now','Why Now', ensure(buf.now) || toLines(STATE.currentStateTexts.now))}
              ${editorBox('recast','Why Recast', ensure(buf.recast) || toLines(STATE.currentStateTexts.recast))}
            </div>
            <div class="mt-8 flex flex-wrap gap-3">
              <button id="btnSaveCurrentState" type="button" data-action="save-currentstate" class="inline-flex items-center gap-3 bg-var(--re-accent) text-white px-5 py-3 rounded-md focus-ring">
                <i data-lucide="save" class="w-5 h-5"></i> Save
              </button>
              <button id="btnResetCurrentState" type="button" data-action="reset-currentstate-defaults" class="inline-flex items-center gap-3 border border-var(--re-navy)/20 px-5 py-3 rounded-md focus-ring">
                <i data-lucide="rotate-ccw" class="w-5 h-5"></i> Reset to default
              </button>
            </div>
          </div>
        </div>
      `;
    }
    function editorBox(key,label,value){
      const idMap = { change:'whyChange', now:'whyNow', recast:'whyRecast' };
      const tid = idMap[key] || ('why-'+key);
      return `
        <label class="flex flex-col gap-3">
          <span class="text-base font-semibold">${label}</span>
          <textarea id="${tid}" data-autosave data-action="edit-buffer" data-key="${key}" class="min-h-[200px] rounded-md border border-var(--re-navy)/20 p-4 text-lg leading-relaxed focus-ring" aria-label="${label} editor" placeholder="One bullet per line (max 3)">${value}</textarea>
        </label>
      `;
    }

    function attachEvents(){
      const root=document.getElementById('app');

      root.querySelectorAll('[data-action="switch-tab"]').forEach(b=>b.addEventListener('click',e=>{
        STATE.activeTab=e.currentTarget.getAttribute('data-tab');
        if(STATE.activeTab==='solution'){ STATE.showSolutionCards=false; }
        render();
        $('#tab-'+STATE.activeTab)?.focus();
      }));
      root.querySelectorAll('[data-action="advance"]').forEach(b=>b.addEventListener('click',e=>{
        STATE.activeTab=e.currentTarget.getAttribute('data-next'); 
        if(STATE.activeTab==='solution'){ STATE.showSolutionCards=false; }
        render();
        $('#tab-'+STATE.activeTab)?.focus();
      }));

      root.querySelectorAll('[data-action="toggle-why"]').forEach(b=>b.addEventListener('click',e=>{
        const id=e.currentTarget.getAttribute('data-why');
        STATE.openWhy = (STATE.openWhy === id) ? null : id;
        render();
      }));

      root.querySelectorAll('[data-action="set-device"]').forEach(b=>b.addEventListener('click',e=>{ STATE.ctx.device=e.currentTarget.getAttribute('data-value'); render(); }));
      root.querySelectorAll('[data-action="set-network"]').forEach(b=>b.addEventListener('click',e=>{ STATE.ctx.network=e.currentTarget.getAttribute('data-value'); render(); }));
      root.querySelectorAll('[data-action="toggle-compliance"]').forEach(b=>b.addEventListener('click',()=>{ STATE.ctx.compliant=!STATE.ctx.compliant; render(); }));

      const pack=root.querySelector('[data-action="set-pack-hrs"]'); if(pack) pack.addEventListener('input',e=>{ STATE.packHrs=cleanNum(e.target.value); render(); });
      const cfg=root.querySelector('[data-action="set-config-hrs"]'); if(cfg) cfg.addEventListener('input',e=>{ STATE.configHrs=cleanNum(e.target.value); render(); });
      const cur=root.querySelector('[data-action="set-current-hrs"]'); if(cur) cur.addEventListener('input',e=>{ STATE.currentHrs=cleanNum(e.target.value); render(); });

      root.querySelectorAll('[data-action="add-impact"]').forEach(b=>b.addEventListener('click',e=>{
        const kind=e.currentTarget.getAttribute('data-kind'); const val=Number(e.currentTarget.getAttribute('data-value'))||0;
        if (kind==='minutes') STATE.impact.minutes+=val;
        if (kind==='pkgHours') STATE.impact.pkgHours+=val;
        if (kind==='riskHrs') STATE.impact.riskHrs+=val;
        updateROIOutputs();
        render();
      }));

      root.querySelectorAll('[data-action="set-roi"]').forEach(inp=>inp.addEventListener('input',e=>{
        const key=e.currentTarget.getAttribute('data-key');
        const v=Number(String(e.target.value).replace(/[^0-9.\-]/g,'')); 
        STATE.roiInputs[key]=isFinite(v)?v:0;
        updateROIOutputs();
        render();
      }));

      const resetCalc=root.querySelector('[data-action="reset-calculator"]');
      if(resetCalc) resetCalc.addEventListener('click', ()=>{
        STATE.roiInputs = { users: 5000, ticketsPerUserPerMonth: 0.035, avgHandleMins: 18, loadedCostPerHour: 85, recastAnnualCost: 120000 };
        STATE.impact = { ...STATE.defaults.impact };
        STATE.copied = false;
        render();
      });

      const copyBtn=root.querySelector('[data-action="copy-onepager"]');
      if(copyBtn) copyBtn.addEventListener('click', async ()=>{
        const i = STATE.roiInputs;
        const ticketsMonth = i.users * i.ticketsPerUserPerMonth;
        const hoursFromMinutes = (STATE.impact.minutes * i.users) / 60;
        const totalHoursSavedMonth = hoursFromMinutes + STATE.impact.pkgHours + STATE.impact.riskHrs;
        const dollarSavedMonth = totalHoursSavedMonth * i.loadedCostPerHour;
        const dollarSavedYear = dollarSavedMonth * 12;
        const netBenefitYear = dollarSavedYear - i.recastAnnualCost;
        const roiPct = i.recastAnnualCost ? (netBenefitYear / i.recastAnnualCost) * 100 : 0;
        const fteHoursYear = 2080;
        const fteEquivalent = (totalHoursSavedMonth * 12) / fteHoursYear;
        const body =
`Recast Application Workspace — Executive One-Pager

Assumptions
 - Users: ${i.users}
 - Tickets per user / month: ${i.ticketsPerUserPerMonth}
 - Avg handle: ${i.avgHandleMins} mins
 - Loaded cost: $${i.loadedCostPerHour}/hr
 - Subscription (annual): $${i.recastAnnualCost}

Observed demo impact (illustrative)
 - Minutes saved per user (monthly): ${STATE.impact.minutes}
 - Packaging hours avoided (org): ${STATE.impact.pkgHours}
 - Zero-day window reduced (hrs): ${STATE.impact.riskHrs}

Calculated outcomes
 - Tickets / month: ${num(ticketsMonth)}
 - Hours saved / month: ${round(totalHoursSavedMonth)}
 - $ saved / month: $${num(dollarSavedMonth)}
 - $ saved / year: $${num(dollarSavedYear)}
 - Net benefit / year: $${num(netBenefitYear)}
 - ROI: ${round(roiPct)}%
 - Equivalent IT FTEs freed: ${round(fteEquivalent)}

Notes: Illustrative; replace with your data.`;
        try { await navigator.clipboard.writeText(body); } catch {
          const ta=document.createElement('textarea'); ta.value=body; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
        }
        STATE.copied = true; render(); setTimeout(()=>{ STATE.copied = false; render(); }, 1200);
      });

      const startBtn=root.querySelector('[data-action="start-flow"]'); if(startBtn) startBtn.addEventListener('click', startFlow);
      const resetBtn=root.querySelector('[data-action="reset-flow"]'); if(resetBtn) resetBtn.addEventListener('click', resetFlow);
      const toggleLabels=root.querySelector('[data-action="toggle-labels"]'); if(toggleLabels) toggleLabels.addEventListener('click', ()=>{ STATE.showLabels=!STATE.showLabels; buildFlow(); render(); });

      const showCards=root.querySelector('[data-action="show-solution-cards"]');
      if(showCards) showCards.addEventListener('click', ()=>{ STATE.showSolutionCards=true; render(); });

      const openEditor=root.querySelector('[data-action="open-currentstate-editor"]');
      if(openEditor) openEditor.addEventListener('click', (ev)=>{
        STATE.invoker = ev.currentTarget;
        STATE.modalOpen = true;
        STATE.modalKind = 'currentstate';
        STATE.editBuffers = { change: '', now: '', recast: '' };
        render();
        setTimeout(()=>{ try { window.lucide.createIcons(); } catch{} }, 0);
        setTimeout(()=>{ initCurrentStateModal(); }, 0);
      });

      const openAgendaBtns = root.querySelectorAll('[data-action="open-agenda-editor"]');
      openAgendaBtns.forEach(btn=>{
        btn.addEventListener('click', (ev)=>{
          STATE.invoker = ev.currentTarget;
          STATE.modalOpen = true;
          STATE.modalKind = 'agenda';
          render();
          setTimeout(()=>{ try { window.lucide.createIcons(); } catch{} }, 0);
        });
      });
    }

    function wireTabsKeyboard(){
      const tablist = document.getElementById('tablist');
      if(!tablist || tablist.dataset.kb) return;
      tablist.dataset.kb = "1";
      tablist.addEventListener('keydown', (e)=>{
        const tabs = Array.from(tablist.querySelectorAll('[role="tab"]'));
        const current = document.activeElement;
        const idx = tabs.indexOf(current);
        if(idx===-1) return;
        let next = idx;
        if(e.key==='ArrowRight') { next = (idx+1)%tabs.length; e.preventDefault(); }
        if(e.key==='ArrowLeft') { next = (idx-1+tabs.length)%tabs.length; e.preventDefault(); }
        if(e.key==='Home') { next = 0; e.preventDefault(); }
        if(e.key==='End') { next = tabs.length-1; e.preventDefault(); }
        if(next!==idx){ tabs[next].focus(); }
        if(e.key==='Enter' || e.key===' ') {
          const tab = tabs[idx];
          const id = tab.getAttribute('data-tab');
          STATE.activeTab = id;
          render();
          $('#tab-'+STATE.activeTab)?.focus();
          e.preventDefault();
        }
      });
    }

    function setupModalA11y(){
      const dialog = document.querySelector('[role="dialog"]');
      if(!dialog) return;
      const focusables = dialog.querySelectorAll('button,[href],input,textarea,select,[tabindex]:not([tabindex="-1"])');
      const first = focusables[0]; const last = focusables[focusables.length-1];
      if(first) first.focus();
      function trap(e){
        if(e.key!=='Tab') return;
        if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); }
        else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); }
      }
      dialog.addEventListener('keydown', trap);
    }

    function buildFlow(){
      let base=0;
      CATALOG.forEach(section=>{
        const mount=document.getElementById(section.id); if(!mount) return;
        mount.innerHTML='';
        section.items.forEach((itm,idx)=>{
          const wrap=document.createElement('div'); wrap.className='logo-wrap'; wrap.style.setProperty('--d',(base+idx*0.06).toFixed(2)+'s');
          const ring=document.createElement('div'); ring.className='logo-ring'; ring.innerHTML=itm.svg; ring.title=itm.name; ring.setAttribute('role','img'); ring.setAttribute('aria-label',itm.name);
          wrap.appendChild(ring);
          if(STATE.showLabels){ const label=document.createElement('span'); label.className='logo-name'; label.textContent=itm.name; wrap.appendChild(label); }
          mount.appendChild(wrap);
        });
        base+=0.25;
      });

      buildTiles(document.getElementById('flowConnA'), 14, .5);
      buildTiles(document.getElementById('flowConnB'), 14, .56);
      buildTiles(document.getElementById('flowConnC'), 14, .62);
      buildTiles(document.getElementById('flowGrpA'), 18, .95);
      buildTiles(document.getElementById('flowGrpB'), 18, 1.0);
      buildTiles(document.getElementById('flowGrpC'), 18, 1.05);
      buildTiles(document.getElementById('flowDevA'), 10, 1.5);
      buildTiles(document.getElementById('flowDevB'), 10, 1.55);
      buildTiles(document.getElementById('flowDevC'), 10, 1.6);

      const avatar=document.getElementById('endUserAvatar');
      const badge=document.getElementById('endUserBadge');
      if(avatar){ avatar.style.background='#EA4335'; avatar.textContent='U'; }
      if(badge){ badge.textContent='!'; badge.style.background='#E11D48'; }
    }
    function buildTiles(container,count,baseDelay){
      if(!container) return; container.innerHTML='';
      for(let i=0;i<count;i++){ const d=document.createElement('div'); d.className='tile'; d.style.setProperty('--d',(baseDelay+i*0.04).toFixed(2)+'s'); container.appendChild(d); }
    }

    function startFlow(){
      const card=document.getElementById('flowCard'); if(!card) return;
      card.classList.remove('run'); void card.offsetWidth; card.classList.add('run');
      const flash=document.getElementById('flowHubFlash'); const success=document.getElementById('flowSuccess');
      const avatar=document.getElementById('endUserAvatar'); const badge=document.getElementById('endUserBadge');
      if(flash){ flash.classList.remove('hidden'); setTimeout(()=>flash.classList.add('hidden'),1000); }
      if(success) success.classList.add('hidden');
      setTimeout(()=>{
        if(avatar){ avatar.style.background='#10B981'; }
        if(badge){ badge.textContent='✓'; badge.style.background='#10B981'; }
      }, 2100);
      setTimeout(()=> success && success.classList.remove('hidden'), 2500);
      setTimeout(()=> card.classList.remove('run'), 6000);
    }
    function resetFlow(){
      const card=document.getElementById('flowCard'); if(!card) return;
      card.classList.remove('run');
      const success=document.getElementById('flowSuccess'); if(success) success.classList.add('hidden');
      const avatar=document.getElementById('endUserAvatar'); const badge=document.getElementById('endUserBadge');
      if(avatar){ avatar.style.background='#EA4335'; }
      if(badge){ badge.textContent='!'; badge.style.background='#E11D48'; }
    }

    document.addEventListener('DOMContentLoaded', render);

    document.addEventListener('click', (e)=>{
      const act = e.target.closest('[data-action]');
      if(!act) return;
      const action = act.getAttribute('data-action');

      if(action==='close-modal'){
        STATE.modalOpen=false; STATE.modalKind=null; render();
        setTimeout(()=>{ if(STATE.invoker && STATE.invoker.focus) STATE.invoker.focus(); },0);
      }

      if(action==='edit-buffer'){
        const key = act.getAttribute('data-key');
        act.addEventListener('input', (evt)=>{ STATE.editBuffers[key] = evt.target.value; });
      }

      if(action==='save-currentstate'){
        const parseLines = (s)=> (s||'').split('\n').map(l=>l.trim()).filter(Boolean).slice(0,3);
        const change = parseLines($('#whyChange')?.value || '');
        const now = parseLines($('#whyNow')?.value || '');
        const recast = parseLines($('#whyRecast')?.value || '');
        const fallback = STATE.defaultsCurrentState();
        STATE.currentStateTexts = {
          change: change.length?change:fallback.change,
          now: now.length?now:fallback.now,
          recast: recast.length?recast:fallback.recast
        };
        saveDraft({ whyChange: $('#whyChange')?.value || '', whyNow: $('#whyNow')?.value || '', whyRecast: $('#whyRecast')?.value || '' });
        STATE.modalOpen=false;
        STATE.modalKind=null;
        STATE.activeTab='problems';
        STATE.openWhy=null;
        render();
      }

      if(action==='reset-currentstate-defaults'){
        clearDraft();
        captureDefaultsOnce();
        writeFields(DEFAULT_CURRENT_STATE);
      }

      if(action==='save-agenda'){
        const title = $('#agendaTitle')?.value?.trim() || 'Agenda';
        const overviewText = ($('#agendaOverview')?.value || '').trim();
        const def = STATE.defaultsAgenda();
        STATE.todayAgenda = {
          title: title || def.title,
          overviewText: overviewText || def.overviewText
        };
        saveAgendaDraft({ title: $('#agendaTitle')?.value || '', overviewText });
        STATE.modalOpen=false; STATE.modalKind=null; STATE.activeTab='today'; render();
      }

      if(action==='reset-agenda-defaults'){
        clearAgendaDraft();
        const def = STATE.defaultsAgenda();
        const titleEl = $('#agendaTitle'); const ovEl = $('#agendaOverview');
        if(titleEl) titleEl.value = def.title;
        if(ovEl) ovEl.value = def.overviewText;
      }
    });

    document.addEventListener('keydown',(e)=>{
      if(e.key==='Escape' && STATE.modalOpen){ STATE.modalOpen=false; STATE.modalKind=null; render(); setTimeout(()=>{ if(STATE.invoker && STATE.invoker.focus) STATE.invoker.focus(); },0); }
    });
  </script>
</body>
</html>
